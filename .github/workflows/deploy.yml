name: Deploy Backend
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Debug SSH Connection
      run: |
        echo "Checking if secrets are set..."
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then echo "SERVER_HOST is empty!"; fi
        if [ -z "${{ secrets.SERVER_USER }}" ]; then echo "SERVER_USER is empty!"; fi
        if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then echo "SERVER_SSH_KEY is empty!"; fi
        echo "Host: ${{ secrets.SERVER_HOST }}"
        echo "User: ${{ secrets.SERVER_USER }}"

    - name: Deploy Backend via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸ“¦ Pulling latest code..."
          cd /var/www/berater-eskapp
          git fetch origin main
          git reset --hard origin/main

          echo "ğŸ”§ Updating Backend..."
          cd berater-service
          npm ci --omit=dev
          pm2 describe berater-api >/dev/null \
            && pm2 restart berater-api \
            || pm2 start server.js --name berater-api

          echo "ğŸ¨ Building Frontend..."
          cd ../berater-ui
          npm ci
          npm run build --configuration=production

          echo "ğŸ“‹ Deploying Frontend..."
          mkdir -p /var/www/berater-ui/dist/berater-ui
          rm -rf /var/www/berater-ui/dist/berater-ui/*
          cp -r dist/berater-ui/* /var/www/berater-ui/dist/berater-ui/

          echo "âœ… Deployment completed!"
          pm2 status
