@if(isMobile){
<app-customers-mobile
  [customers]="customers"
  (create)="showCreateModal()"
  (showDetails)="showCustomerDetails($event)"
  (edit)="editCustomer($event)"
  (delete)="deleteCustomer($event)"
  (closeActionMenu)="closeActionMenu()"
  (filterActiveChange)="filterActive = $event; loadCustomers()" (toggleActionMenu)="toggleActionMenu($event)"
  (searchTermChange)="searchTerm = $event; onSearchChange()"
/>
} @else {
<div class="page-container" (click)="closeActionMenu()">
  <div class="page-header">
    <h1>Kunden</h1>
    <button class="btn-primary" (click)="showCreateModal()">+ Neuer Kunde</button>
  </div>

  <div class="filters">
    <input type="search" placeholder="Suche nach Name, E-Mail..." [(ngModel)]="searchTerm"
      (ngModelChange)="onSearchChange()" class="search-input" />
    <select [(ngModel)]="filterActive" (ngModelChange)="loadCustomers()" class="filter-select">
      <option [ngValue]="undefined">Alle</option>
      <option [ngValue]="true">Aktiv</option>
      <option [ngValue]="false">Inaktiv</option>
    </select>
  </div>

  <app-table-container>
    <table class="data-table">
      <thead>
        <tr>
          <!-- <th>Kundennr.</th> -->
          <th>Name</th>
          <th>E-Mail</th>
          <th>Telefon</th>
          <th>Status</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        @for(customer of customers; track customer){
        <tr>
          <!-- <td data-label="Kundennr.">{{ customer.customerNumber }}</td> -->
          <td data-label="Name">{{ customer.firstName }} {{ customer.lastName }}</td>
          <td data-label="E-Mail">{{ customer.email || '-' }}</td>
          <td data-label="Telefon">
            @if(customer.phone){
            <span class="phone-container">
              {{ customer.phone }}
              <a [href]="'tel:' + customer.phone" class="phone-icon" title="Anrufen">ðŸ“ž</a>
            </span>
          }@else{
            <span>-</span>
          }
          </td>
          <td data-label="Status">
            <span class="badge" [class.badge-active]="customer.isActive" [class.badge-inactive]="!customer.isActive">
              {{ customer.isActive ? 'Aktiv' : 'Inaktiv' }}
            </span>
          </td>
          <td class="actions-cell" data-label="Aktionen">
            <div class="action-menu-container">
              <button class="action-menu-btn" (click)="toggleActionMenu(customer._id); $event.stopPropagation()">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              @if(activeMenuId === customer._id){
                <div class="action-menu" (click)="$event.stopPropagation()">
                  <button class="menu-item" (click)="showCustomerDetails(customer); closeActionMenu()">
                    <i class="fas fa-info-circle fa-lg"></i> Details anzeigen
                  </button>
                  <button class="menu-item" (click)="editCustomer(customer); closeActionMenu()">
                    <i class="fas fa-edit fa-lg"></i> Bearbeiten
                  </button>
                  <button class="menu-item menu-item-danger"
                    (click)="deleteCustomer(customer._id); closeActionMenu()">
                    <i class="fas fa-trash fa-lg"></i> LÃ¶schen
                  </button>
                </div>
              }
            </div>
          </td>
        </tr>
      }
      </tbody>
    </table>
  </app-table-container>
</div>
}

<!-- Modal for Create/Edit Customer -->
 @if(showModal){
<app-overlay-modal (close)="closeModal()">
  <h2>{{ editMode ? 'Kunde bearbeiten' : 'Neuer Kunde' }}</h2>
  <form (ngSubmit)="saveCustomer()">
    <div class="form-row">
      <div class="form-group">
        <label>Vorname*</label>
        <input type="text" [(ngModel)]="currentCustomer.firstName" name="firstName" required />
      </div>
      <div class="form-group">
        <label>Nachname*</label>
        <input type="text" [(ngModel)]="currentCustomer.lastName" name="lastName" required />
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>E-Mail</label>
        <input type="email" [(ngModel)]="currentCustomer.email" name="email" />
      </div>
      <div class="form-group">
        <label>Telefon</label>
        <input type="tel" [(ngModel)]="currentCustomer.phone" name="phone" />
      </div>
</div>
    @if(currentCustomer.address){
      <label>Adresse:</label>
      <hr/>
      <div class="form-group">
          <label>Strasse</label>
          <input type="text" 
              name="street" 
              [(ngModel)]="currentCustomer.address.street" 
              placeholder="StraÃŸe und Hausnummer"
              class="form-control" />
          <div class="form-row">
              <div class="form-group">
                <label>PLZ</label>
                <input type="text" 
                    name="zip" 
                    [(ngModel)]="currentCustomer.address.zip" 
                    placeholder="PLZ" 
                    class="form-control"
                />
              </div>
              <div class="form-group">
                <label>Ort</label>
                  <input type="text" 
                      name="city" 
                      [(ngModel)]="currentCustomer.address.city" 
                      placeholder="Ort"
                      class="form-control"
                  />
              </div>
          </div>
        </div>
    }
    <div class="form-group">
      <label>Notizen</label>
      <textarea [(ngModel)]="currentCustomer.notes" name="notes" rows="3"></textarea>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeModal()">Abbrechen</button>
      <button type="submit" class="btn-primary">Speichern</button>
    </div>
  </form>
</app-overlay-modal>
}

<!-- Modal for Customer Details -->
 @if(showCustomerDetailsModal){
<app-overlay-modal (close)="closeCustomerDetailsModal()">
  <div class="modal-header">
    <h2>{{ selectedCustomer?.fullName }}</h2>
    <button class="btn-close" (click)="closeCustomerDetailsModal()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <div class="modal-body">
    <div class="info-row">
      <span class="label">Kundennummer</span>
      <span class="value">{{ selectedCustomer?.customerNumber }}</span>
    </div>

    <div class="info-row" *ngIf="selectedCustomer?.phone">
      <span class="label">Telefonnummer</span>
      <span class="value">
        {{ selectedCustomer?.phone }}
      </span>
    </div>

    <div class="info-row address" *ngIf="selectedCustomer?.address">
      <span class="label">Adresse</span>
      <span class="value">
        {{ selectedCustomer?.address?.street }}<br />
        {{ selectedCustomer?.address?.zip }} {{ selectedCustomer?.address?.city }}
      </span>
    </div>

    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e0e0e0;" />

    <h3 style="margin-bottom: 1rem;">Vertragsverlauf</h3>

    <div *ngIf="customerContracts.length === 0" class="no-data">
      Keine VertrÃ¤ge vorhanden
    </div>

    <table class="data-table" *ngIf="customerContracts.length > 0">
      <thead>
        <tr>
          <th>Vertragsnummer</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let contract of customerContracts" class="clickable-row" (click)="navigateToContract(contract._id)">
          <td>{{ contract.contractNumber }}</td>
          <td>
            <span class="badge" [class.badge-active]="contract.status === 'active'"
              [class.badge-inactive]="contract.status === 'ended' || contract.status === 'archived'">
              {{ getContractStatusLabel(contract.status) }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn-secondary" (click)="closeCustomerDetailsModal()">SchlieÃŸen</button>
  </div>
</app-overlay-modal>
}