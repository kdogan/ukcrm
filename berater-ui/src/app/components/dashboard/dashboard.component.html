@if(isMobile){
  <app-dashboard-mobile
    [stats]="stats"
    [userStats]="userStats"
    [isSuperAdmin]="isSuperAdmin"
    [maxContracts]="maxContracts"
    [maxUsers]="maxUsers"
    [subscriptionInfo]="subscriptionInfo"
    [subscriptionWarningMessage]="getSubscriptionWarningMessage()"
    [subscriptionWarningLevel]="getSubscriptionWarningLevel()"
    [chartData]="chartData"
    [maxChartValue]="maxChartValue"
    [favoriteStats]="favoriteStats"
    [availableStatCards]="availableStatCards"
    (approveUpgradeEvent)="approveUpgrade($event)"
    (rejectUpgradeEvent)="rejectUpgrade($event)"
    (chartMonthsChange)="chartMonths = $event; loadChartData()"
    (toggleFavoriteEvent)="onToggleFavoriteFromMobile($event)"
  />
} @else {
    <div class="dashboard">
      <h1>{{ 'DASHBOARD.TITLE' | translate }}</h1>

      <!-- Superadmin Dashboard -->
      @if(isSuperAdmin){
        <div>
          @if(userStats){
            <div class="stats-grid">
              <!-- Gesamt Benutzer -->
              <div class="stat-card">
                <h3><i class="fas fa-users"></i>{{ 'ADMIN.USERS' | translate }}</h3>
                <div class="stat-number">{{ userStats.total || 0 }}</div>
                <div class="stat-label">{{ 'COMMON.ALL' | translate }}</div>
              </div>

              <!-- Aktive Benutzer -->
              <div class="stat-card">
                <h3><i class="fas fa-check-circle"></i> {{ 'DASHBOARD.ACTIVE' | translate }}</h3>
                <div class="stat-number">{{ userStats.active || 0 }}</div>
                <div class="stat-label">{{ 'ADMIN.STATUS.ACTIVE' | translate }}</div>
              </div>

              <!-- Blockierte Benutzer -->
              <div class="stat-card">
                <h3><i class="fas fa-ban"></i> {{ 'ADMIN.STATUS.BLOCKED' | translate }}</h3>
                <div class="stat-number">{{ userStats.blocked || 0 }}</div>
                <div class="stat-label">{{ 'ADMIN.STATUS.BLOCKED' | translate }}</div>
              </div>
              <div class="stat-card">
                <h3><i class="fas fa-box"></i> {{ 'ADMIN.FIELDS.PACKAGE' | translate }}</h3>
                <div class="stat-number">{{ userStats.package || 0 }}</div>
                <div class="stat-label">{{ 'ADMIN.FIELDS.PACKAGE' | translate }}</div>
              </div>

            </div>
          }
          <!-- Benutzer nach Rolle -->
          <div class="supplier-section" *ngIf="userStats?.byRole">
            <h2><i class="fas fa-chart-bar"></i> {{ 'ADMIN.USERS' | translate }} {{ 'ADMIN.FIELDS.ROLE' | translate }}</h2>
            <div class="chart-container">
              <div *ngFor="let item of getRoleStats()" class="chart-bar">
                <div class="bar-label">{{ item.name }}</div>
                <div class="bar-wrapper">
                  <div class="bar" [style.width.%]="getPercentage(item.count)"></div>
                  <span class="bar-value">{{ item.count }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Benutzer nach Paket -->
          <div class="supplier-section" *ngIf="userStats?.byPackage">
            <h2><i class="fas fa-box"></i> {{ 'ADMIN.USERS' | translate }} {{ 'ADMIN.FIELDS.PACKAGE' | translate }}</h2>
            <div class="chart-container">
              <div *ngFor="let item of getPackageStats()" class="chart-bar">
                <div class="bar-label">{{ item.name }}</div>
                <div class="bar-wrapper">
                  <div class="bar" [style.width.%]="getPercentage(item.count)"></div>
                  <span class="bar-value">{{ item.count }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Ablaufende Pakete -->
           @if(expiringSubscriptions.length > 0 || expiredSubscriptions.length > 0){
            <div class="expiring-subscriptions-section">
              <h2><i class="fas fa-exclamation-triangle"></i> {{ 'DASHBOARD.EXPIRING_PACKAGES' | translate }}</h2>

              <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card priority-high">
                  <h3><i class="fas fa-clock"></i> {{ 'DASHBOARD.EXPIRED' | translate }}</h3>
                  <div class="stat-number">{{ expiredSubscriptions.length }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PACKAGES' | translate }}</div>
                </div>
                <div class="stat-card">
                  <h3><i class="fas fa-exclamation-triangle"></i> {{ 'DASHBOARD.URGENT_DAYS' | translate }}</h3>
                  <div class="stat-number">{{ getCountByWarningLevel('danger') }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PACKAGES' | translate }}</div>
                </div>
                <div class="stat-card">
                  <h3><i class="fas fa-calendar-alt"></i> {{ 'DASHBOARD.WARNING_DAYS' | translate }}</h3>
                  <div class="stat-number">{{ getCountByWarningLevel('warning') }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PACKAGES' | translate }}</div>
                </div>
                <div class="stat-card">
                  <h3><i class="fas fa-info-circle"></i> {{ 'DASHBOARD.INFO_DAYS' | translate }}</h3>
                  <div class="stat-number">{{ getCountByWarningLevel('info') }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PACKAGES' | translate }}</div>
                </div>
              </div>

              <!-- Action Button for Expired Packages -->
              @if(expiredSubscriptions.length > 0){
                <div style="margin-bottom: 1.5rem;">
                  <button class="btn-danger" (click)="downgradeExpiredPackages()">
                    <i class="fas fa-arrow-down"></i> {{ 'DASHBOARD.DOWNGRADE_EXPIRED' | translate }} ({{ expiredSubscriptions.length }})
                  </button>
                </div>
              }
              <!-- Expired Subscriptions Table -->
              @if(expiredSubscriptions.length > 0){
                <div style="margin-bottom: 2rem;">
                  <h3 style="color: #c62828; margin-bottom: 1rem;"><i class="fas fa-times-circle"></i> {{ 'DASHBOARD.EXPIRED_PACKAGES' | translate }}</h3>
                  <app-table-container>
                    <table class="data-table">
                      <thead>
                        <tr>
                          <th>{{ 'DASHBOARD.USER' | translate }}</th>
                          <th>{{ 'COMMON.EMAIL' | translate }}</th>
                          <th>{{ 'ADMIN.FIELDS.PACKAGE' | translate }}</th>
                          <th>{{ 'DASHBOARD.EXPIRED_SINCE' | translate }}</th>
                          <th>{{ 'DASHBOARD.LAST_LOGIN' | translate }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let user of expiredSubscriptions">
                          <td>{{ user.firstName }} {{ user.lastName }}</td>
                          <td>{{ user.email }}</td>
                          <td>{{ user.package }}</td>
                          <td>
                            <span class="badge badge-expired">
                              {{ user.daysExpired }} {{ 'DASHBOARD.DAYS' | translate }}
                            </span>
                          </td>
                          <td>{{ user.lastLogin ? (user.lastLogin | date:'dd.MM.yyyy HH:mm') : ('DASHBOARD.NEVER' | translate) }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </app-table-container>
                </div>
              }
              <!-- Expiring Subscriptions Table -->
                @if(expiringSubscriptions.length > 0){
                  <div>
                    <h3 style="color: #f57c00; margin-bottom: 1rem;"><i class="fas fa-clock"></i> {{ 'DASHBOARD.EXPIRING_PACKAGES_SOON' | translate }}</h3>
                    <app-table-container>
                      <table class="data-table">
                        <thead>
                          <tr>
                            <th>{{ 'DASHBOARD.USER' | translate }}</th>
                            <th>{{ 'COMMON.EMAIL' | translate }}</th>
                            <th>{{ 'ADMIN.FIELDS.PACKAGE' | translate }}</th>
                            <th>{{ 'DASHBOARD.DAYS_UNTIL_EXPIRY' | translate }}</th>
                            <th>{{ 'DASHBOARD.WARNING_LEVEL' | translate }}</th>
                            <th>{{ 'DASHBOARD.LAST_LOGIN' | translate }}</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let user of expiringSubscriptions">
                            <td>{{ user.firstName }} {{ user.lastName }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.package }}</td>
                            <td>
                              <span class="badge" [ngClass]="getWarningLevelBadgeClass(user.warningLevel)">
                                {{ user.daysUntilExpiration }} {{ 'DASHBOARD.DAYS' | translate }}
                              </span>
                            </td>
                            <td>
                              <span class="badge" [ngClass]="getWarningLevelBadgeClass(user.warningLevel)">
                                {{ getWarningLevelLabel(user.warningLevel) }}
                              </span>
                            </td>
                            <td>{{ user.lastLogin ? (user.lastLogin | date:'dd.MM.yyyy HH:mm') : ('DASHBOARD.NEVER' | translate) }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </app-table-container>
                  </div>
                }
            </div>
            }
          <!-- Upgrade-Anfragen -->
          @if(stats?.upgradeRequests){
            <div class="upgrade-requests-section">
              <h2><i class="fas fa-sync-alt"></i> {{ 'DASHBOARD.UPGRADE_REQUESTS' | translate }}</h2>
              <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card priority-high">
                  <h3><i class="fas fa-hourglass-half"></i> {{ 'DASHBOARD.AWAITING_REVIEW' | translate }}</h3>
                  <div class="stat-number">{{ stats.upgradeRequests.counts?.awaitingReview || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PENDING' | translate }} & {{ 'DASHBOARD.PAYMENT_RECEIVED' | translate }}</div>
                </div>
                <div class="stat-card">
                  <h3><i class="fas fa-file-alt"></i> {{ 'DASHBOARD.PENDING' | translate }}</h3>
                  <div class="stat-number">{{ stats.upgradeRequests.counts?.pending || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.NEWLY_CREATED' | translate }}</div>
                </div>
                <div class="stat-card">
                  <h3><i class="fas fa-money-bill-wave"></i> {{ 'DASHBOARD.PAYMENT_RECEIVED' | translate }}</h3>
                  <div class="stat-number">{{ stats.upgradeRequests.counts?.paymentReceived || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PAYMENT_INCOMING' | translate }}</div>
                </div>
              </div>

              <div *ngIf="stats.upgradeRequests.pending?.length > 0" class="requests-list">
                <h3>{{ 'DASHBOARD.OPEN_REQUESTS' | translate }}</h3>
                <div *ngFor="let request of stats.upgradeRequests.pending" class="request-card">
                  <div class="request-header">
                    <div class="user-info">
                      <strong>{{ request.user.firstName }} {{ request.user.lastName }}</strong>
                      <span class="email">{{ request.user.email }}</span>
                    </div>
                    <span class="status-badge" [class]="'status-' + request.status">
                      {{ getStatusLabel(request.status) }}
                    </span>
                  </div>
                  <div class="request-details">
                    <div class="detail-item">
                      <span class="label">{{ 'DASHBOARD.CURRENT' | translate }}:</span>
                      <span class="value">{{ request.currentPackage }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">{{ 'DASHBOARD.REQUESTED' | translate }}:</span>
                      <span class="value highlight">{{ request.packageDetails.displayName }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">{{ 'DASHBOARD.PRICE' | translate }}:</span>
                      <span class="value">{{ request.packageDetails.price }} {{ request.packageDetails.currency }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">{{ 'DASHBOARD.DATE' | translate }}:</span>
                      <span class="value">{{ formatDate(request.createdAt) }}</span>
                    </div>
                  </div>
                  <div class="request-actions">
                    <button class="btn-success" (click)="approveUpgrade(request._id)">
                      <i class="fas fa-check"></i> {{ 'DASHBOARD.APPROVE' | translate }}
                    </button>
                    <button class="btn-danger" (click)="rejectUpgrade(request._id)">
                      <i class="fas fa-times"></i> {{ 'DASHBOARD.REJECT' | translate }}
                    </button>
                  </div>
                </div>
              </div>

              <div *ngIf="!stats.upgradeRequests.pending || stats.upgradeRequests.pending.length === 0" class="no-data">
                <p>{{ 'DASHBOARD.NO_OPEN_REQUESTS' | translate }}</p>
              </div>
            </div>
          }
        </div>
      }
      <!-- Berater/Admin Dashboard -->
       @if(!isSuperAdmin){
        <div>
          <!-- Subscription Expiration Warning -->
           @if(shouldShowSubscriptionWarning()){
            <div class="subscription-warning-banner"
                [class.warning-expired]="getSubscriptionWarningLevel() === 'expired'"
                [class.warning-danger]="getSubscriptionWarningLevel() === 'danger'"
                [class.warning-warning]="getSubscriptionWarningLevel() === 'warning'"
                [class.warning-info]="getSubscriptionWarningLevel() === 'info'">
              <div class="warning-icon">
                <i class="fas"
                  [class.fa-exclamation-triangle]="getSubscriptionWarningLevel() === 'expired' || getSubscriptionWarningLevel() === 'danger'"
                  [class.fa-info-circle]="getSubscriptionWarningLevel() === 'warning' || getSubscriptionWarningLevel() === 'info'"></i>
              </div>
              <div class="warning-content">
                <div class="warning-title">
                  <span *ngIf="getSubscriptionWarningLevel() === 'expired'">{{ 'DASHBOARD.SUBSCRIPTION.EXPIRED' | translate }}</span>
                  <span *ngIf="getSubscriptionWarningLevel() === 'danger'">{{ 'DASHBOARD.SUBSCRIPTION.EXPIRING_SOON' | translate }}</span>
                  <span *ngIf="getSubscriptionWarningLevel() === 'warning'">{{ 'DASHBOARD.SUBSCRIPTION.REMINDER' | translate }}</span>
                  <span *ngIf="getSubscriptionWarningLevel() === 'info'">{{ 'DASHBOARD.SUBSCRIPTION.INFO' | translate }}</span>
                </div>
                <div class="warning-message">{{ getSubscriptionWarningMessage() }}</div>
              </div>
              <div class="warning-action">
                <a routerLink="/settings" class="btn-renew">{{ 'DASHBOARD.SUBSCRIPTION.RENEW' | translate }}</a>
              </div>
            </div>
          }

          <!-- FAVORIT-STATISTIKEN (oben) -->
          @if(stats && getFavoriteStatCards().length > 0) {
            <div class="favorites-section">
              <h2><i class="fas fa-star"></i> {{ 'DASHBOARD.FAVORITES' | translate }}</h2>
              <div class="stats-grid">
                <!-- Erinnerungen -->
                @if(isFavorite('reminders') && stats.reminders) {
                  <div class="stat-card priority-high clickable" routerLink="/todos">
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('reminders', $event)"></i>
                      @if(activeTooltip === 'reminders') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.REMINDERS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                    <h3><i class="fas fa-bell"></i> {{ 'SETTINGS.REMINDERS.TITLE' | translate }}</h3>
                    <div class="reminder-stats">
                      <div class="reminder-item high">
                        <span class="count">{{ stats.reminders.urgent || 0 }}</span>
                        <span class="label">{{ 'TODOS.PRIORITY.URGENT' | translate }}</span>
                      </div>
                      <div class="reminder-item medium">
                        <span class="count">{{ stats.reminders.total || 0 }}</span>
                        <span class="label">{{ 'COMMON.ALL' | translate }}</span>
                      </div>
                    </div>
                  </div>
                }

                <!-- Verträge -->
                @if(isFavorite('contracts')) {
                  <div class="stat-card">
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('contracts', $event)"></i>
                      @if(activeTooltip === 'contracts') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.CONTRACTS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                    <h3><i class="fas fa-file-contract"></i> {{ 'DASHBOARD.CONTRACTS' | translate }}</h3>
                    <div class="stat-split">
                      <div>
                        <div class="stat-number small">{{ stats.contracts?.active || 0 }}</div>
                        <div class="stat-label">{{ 'DASHBOARD.ACTIVE' | translate }}</div>
                      </div>
                      <div>
                        <div class="stat-number small">{{ stats.contracts?.total || 0 }}</div>
                        <div class="stat-label">{{ 'COMMON.ALL' | translate }}</div>
                      </div>
                    </div>
                  </div>
                }

                <!-- Zählerablesungen -->
                @if(isFavorite('recentReadings')) {
                  <div class="stat-card clickable" routerLink="/meters">
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('recentContracts', $event)"></i>
                      @if(activeTooltip === 'recentContracts') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.RECENT_CONTRACTS_READINGS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                    <h3><i class="fas fa-tachometer-alt"></i> {{ 'DASHBOARD.RECENT_CONTRACTS_READINGS' | translate }}</h3>
                    <div class="stat-split">
                      <div>
                        <div class="stat-number small">{{ stats.recentContractsReadings?.withReadings || 0 }}/{{ stats.recentContractsReadings?.totalContracts || 0 }}</div>
                        <div class="stat-label">{{ 'DASHBOARD.WITH_READINGS' | translate }}</div>
                      </div>
                      <div>
                        <div class="stat-number small" [class.text-warning]="stats.recentContractsReadings?.withoutReadings > 0">{{ stats.recentContractsReadings?.withoutReadings || 0 }}</div>
                        <div class="stat-label">{{ 'DASHBOARD.WITHOUT_READINGS' | translate }}</div>
                      </div>
                    </div>
                  </div>
                }

                <!-- Kunden -->
                @if(isFavorite('customers')) {
                  <div class="stat-card">
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('customers', $event)"></i>
                      @if(activeTooltip === 'customers') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.CUSTOMERS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                    <h3><i class="fas fa-users"></i> {{ 'DASHBOARD.CUSTOMERS' | translate }}</h3>
                    <div class="stat-number">{{ stats.customers?.active || 0 }}</div>
                    <div class="stat-label">{{ 'DASHBOARD.ACTIVE' | translate }}</div>
                  </div>
                }

                <!-- Zähler -->
                @if(isFavorite('meters')) {
                  <div class="stat-card">
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('meters', $event)"></i>
                      @if(activeTooltip === 'meters') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.METERS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                    <h3><i class="fas fa-bolt"></i> {{ 'DASHBOARD.METERS' | translate }}</h3>
                    <div class="stat-split">
                      <div>
                        <div class="stat-number small">{{ stats.meters?.free || 0 }}</div>
                        <div class="stat-label">{{ 'METERS.STATUS.FREE' | translate }}</div>
                      </div>
                      <div>
                        <div class="stat-number small">{{ stats.meters?.occupied || 0 }}</div>
                        <div class="stat-label">{{ 'METERS.STATUS.OCCUPIED' | translate }}</div>
                      </div>
                    </div>
                  </div>
                }

                <!-- Neue Kunden -->
                @if(isFavorite('newCustomers')) {
                  <div class="stat-card">
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('newCustomers', $event)"></i>
                      @if(activeTooltip === 'newCustomers') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.NEW_CUSTOMERS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                    <h3><i class="fas fa-user-plus"></i> {{ 'DASHBOARD.NEW_CUSTOMERS' | translate }}</h3>
                    <div class="stat-number">{{ stats.newCustomers?.count || 0 }}</div>
                    <div class="stat-label">{{ 'DASHBOARD.LAST_MONTH' | translate }}</div>
                  </div>
                }

                <!-- Überfällige Verträge -->
                @if(isFavorite('overdueContracts') && stats.overdueContracts) {
                  <div class="stat-card warning-card clickable" [class.priority-high]="stats.overdueContracts.count > 0" (click)="openOverdueModal($event)">
                    <div class="info-tooltip-container" (click)="$event.stopPropagation()">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('overdueContracts', $event)"></i>
                      @if(activeTooltip === 'overdueContracts') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.OVERDUE_CONTRACTS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                    <h3><i class="fas fa-exclamation-triangle"></i> {{ 'DASHBOARD.OVERDUE_CONTRACTS' | translate }}</h3>
                    <div class="stat-number warning-text">{{ stats.overdueContracts.count || 0 }}</div>
                    <div class="stat-label">{{ 'DASHBOARD.OVERDUE_CONTRACTS_DESC' | translate }}</div>
                    @if(stats.overdueContracts.count > 0) {
                      <div class="click-hint"><i class="fas fa-external-link-alt"></i> {{ 'COMMON.CLICK_TO_VIEW' | translate }}</div>
                    }
                  </div>
                }
              </div>

              <!-- Favorit-Charts Grid (volle Größe) -->
              @if(isFavorite('monthlyTrends') || isFavorite('contractsBySupplier') || isFavorite('contractStatistics')) {
                <div class="favorite-charts-grid">
                  <!-- Monatliche Trends (volle Größe) -->
                  @if(isFavorite('monthlyTrends') && chartData) {
                    <div class="trends-section is-favorite">
                      <div class="trends-header">
                        <h3><i class="fas fa-chart-line"></i> {{ 'DASHBOARD.MONTHLY_TRENDS' | translate }}</h3>
                        <div class="header-actions">
                          <button class="favorite-toggle" (click)="toggleFavorite('monthlyTrends', $event)" title="Aus Favoriten entfernen">
                            <i class="fas fa-star"></i>
                          </button>
                          <div class="info-tooltip-container inline">
                            <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('favMonthlyTrends', $event)"></i>
                            @if(activeTooltip === 'favMonthlyTrends') {
                              <div class="info-tooltip">
                                <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.MONTHLY_TRENDS' | translate }}</div>
                                <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                              </div>
                            }
                          </div>
                          <select [(ngModel)]="chartMonths" (change)="onChartMonthsChange()" class="months-select">
                            <option [value]="3">3 {{ 'COMMON.MONTHS' | translate }}</option>
                            <option [value]="6">6 {{ 'COMMON.MONTHS' | translate }}</option>
                            <option [value]="12">12 {{ 'COMMON.MONTHS' | translate }}</option>
                          </select>
                        </div>
                      </div>
                      <div class="trends-chart-container">
                        <div class="chart-legend">
                          <div class="legend-item">
                            <span class="legend-color contracts"></span>
                            <span>{{ 'DASHBOARD.CONTRACTS' | translate }}</span>
                          </div>
                          <div class="legend-item">
                            <span class="legend-color customers"></span>
                            <span>{{ 'DASHBOARD.CUSTOMERS' | translate }}</span>
                          </div>
                          <div class="legend-item">
                            <span class="legend-color meters"></span>
                            <span>{{ 'DASHBOARD.METERS' | translate }}</span>
                          </div>
                        </div>
                        <div class="bar-chart">
                          @for(label of chartData.labels; track label; let i = $index) {
                            <div class="chart-column">
                              <div class="bars-group">
                                <div class="vertical-bar contracts"
                                     [style.height.%]="getBarHeight(chartData.contracts[i])"
                                     [title]="'Verträge: ' + chartData.contracts[i]">
                                  @if(chartData.contracts[i] > 0) {
                                    <span class="bar-value-top">{{ chartData.contracts[i] }}</span>
                                  }
                                </div>
                                <div class="vertical-bar customers"
                                     [style.height.%]="getBarHeight(chartData.customers[i])"
                                     [title]="'Kunden: ' + chartData.customers[i]">
                                  @if(chartData.customers[i] > 0) {
                                    <span class="bar-value-top">{{ chartData.customers[i] }}</span>
                                  }
                                </div>
                                <div class="vertical-bar meters"
                                     [style.height.%]="getBarHeight(chartData.meters[i])"
                                     [title]="'Zähler: ' + chartData.meters[i]">
                                  @if(chartData.meters[i] > 0) {
                                    <span class="bar-value-top">{{ chartData.meters[i] }}</span>
                                  }
                                </div>
                              </div>
                              <div class="chart-label">{{ label }}</div>
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  }

                  <!-- Verträge nach Anbieter (volle Größe) -->
                  @if(isFavorite('contractsBySupplier') && stats?.contractsBySupplier) {
                    <div class="supplier-section is-favorite">
                      <div class="section-header-with-info">
                        <h3><i class="fas fa-chart-pie"></i> {{ 'DASHBOARD.CONTRACTS_BY_SUPPLIER' | translate }}</h3>
                        <div class="header-actions">
                          <button class="favorite-toggle" (click)="toggleFavorite('contractsBySupplier', $event)" title="Aus Favoriten entfernen">
                            <i class="fas fa-star"></i>
                          </button>
                          <div class="info-tooltip-container inline">
                            <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('favContractsBySupplier', $event)"></i>
                            @if(activeTooltip === 'favContractsBySupplier') {
                              <div class="info-tooltip">
                                <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.CONTRACTS_BY_SUPPLIER' | translate }}</div>
                                <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                              </div>
                            }
                          </div>
                        </div>
                      </div>
                      <div class="supplier-stats-container">
                        <div class="pie-chart-wrapper">
                          <div class="pie-chart" [style.background]="getPieChartGradient()">
                            <div class="pie-chart-center">
                              <span class="pie-total">{{ getTotalSupplierContracts() }}</span>
                              <span class="pie-label">{{ 'COMMON.TOTAL' | translate }}</span>
                            </div>
                          </div>
                        </div>
                        <div class="supplier-legend">
                          <div class="supplier-table">
                            <div class="supplier-row header">
                              <span class="supplier-name">{{ 'SUPPLIERS.FIELDS.NAME' | translate }}</span>
                              <span class="supplier-count">{{ 'DASHBOARD.CONTRACTS' | translate }}</span>
                              <span class="supplier-percent">%</span>
                            </div>
                            @for(item of stats.contractsBySupplier; track item._id; let i = $index) {
                              <div class="supplier-row">
                                <span class="supplier-name">
                                  <span class="color-dot" [style.background]="getSupplierColor(i)"></span>
                                  {{ item.shortName || item.name }}
                                </span>
                                <span class="supplier-count">{{ item.count }}</span>
                                <span class="supplier-percent">{{ getSupplierPercentage(item.count) }}%</span>
                              </div>
                            }
                          </div>
                        </div>
                      </div>
                    </div>
                  }

                  <!-- Vertragsstatistik (volle Größe) -->
                  @if(isFavorite('contractStatistics') && contractStats) {
                    <div class="contract-statistics-section is-favorite">
                      <div class="section-header-with-info">
                        <h3><i class="fas fa-chart-bar"></i> {{ 'STATISTICS.TITLE' | translate }}</h3>
                        <div class="header-actions">
                          <button class="favorite-toggle" (click)="toggleFavorite('contractStatistics', $event)" title="Aus Favoriten entfernen">
                            <i class="fas fa-star"></i>
                          </button>
                          <div class="info-tooltip-container inline">
                            <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('favContractStats', $event)"></i>
                            @if(activeTooltip === 'favContractStats') {
                              <div class="info-tooltip">
                                <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.CONTRACT_STATISTICS' | translate }}</div>
                                <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                              </div>
                            }
                          </div>
                        </div>
                      </div>
                      <div class="statistics-filters">
                        <div class="filter-group">
                          <span class="filter-label">{{ 'STATISTICS.SELECT_PERIOD' | translate }}:</span>
                          <div class="period-buttons">
                            @for(option of contractStatsMonthOptions; track option) {
                              <button class="period-btn" [class.active]="contractStatsMonths === option && !showCustomMonthsInput" (click)="onContractStatsMonthsChange(option)">
                                {{ option }} {{ 'COMMON.MONTHS' | translate }}
                              </button>
                            }
                          </div>
                        </div>
                      </div>
                      @if(contractStatsLoading) {
                        <div class="loading-indicator">
                          <i class="fas fa-spinner fa-spin"></i> {{ 'COMMON.LOADING' | translate }}...
                        </div>
                      }
                      @if(!contractStatsLoading) {
                        <div class="status-overview">
                          @for(dataset of contractStats.chartData.datasets; track dataset.status) {
                            <div class="status-card" [style.border-left-color]="getStatusColor(dataset.status)">
                              <div class="status-label">{{ dataset.label }}</div>
                              <div class="status-value">{{ getContractStatValue(contractStats.periodStats, dataset.status) }}</div>
                            </div>
                          }
                          <div class="status-card total">
                            <div class="status-label">{{ 'COMMON.TOTAL' | translate }}</div>
                            <div class="status-value">{{ contractStats.periodStats.total }}</div>
                          </div>
                        </div>
                        <div class="contract-chart">
                          <div class="chart-legend">
                            @for(dataset of contractStats.chartData.datasets; track dataset.status) {
                              <div class="legend-item">
                                <span class="legend-color" [style.background-color]="getStatusColor(dataset.status)"></span>
                                <span>{{ dataset.label }}</span>
                              </div>
                            }
                          </div>
                          <div class="stacked-bar-chart">
                            @for(label of contractStats.chartData.labels; track label; let i = $index) {
                              <div class="chart-column">
                                <div class="stacked-bars">
                                  @for(dataset of contractStats.chartData.datasets; track dataset.status) {
                                    @if(dataset.data[i] > 0) {
                                      <div class="bar-segment" [style.height.%]="getContractBarHeight(dataset.data[i])" [style.background-color]="getStatusColor(dataset.status)" [title]="dataset.label + ': ' + dataset.data[i]">
                                        <span class="bar-value">{{ dataset.data[i] }}</span>
                                      </div>
                                    }
                                  }
                                </div>
                                <div class="chart-label">{{ label }}</div>
                                <div class="chart-total">{{ getTotalForMonth(i) }}</div>
                              </div>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          }

          <!-- Auslaufende Verträge -->
           @if(stats?.expiringContracts){
            <div class="contracts-section">
              <h2><i class="fas fa-file-contract"></i> {{ 'DASHBOARD.EXPIRING_SOON' | translate }}</h2>
              <app-table-container>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>{{ 'CONTRACTS.FIELDS.CUSTOMER' | translate }}</th>
                      <th>{{ 'CONTRACTS.FIELDS.SUPPLIER' | translate }}</th>
                      <th>{{ 'CONTRACTS.FIELDS.END_DATE' | translate }}</th>
                      <th>{{ 'CONTRACTS.DAYS_LEFT' | translate }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for(contract of stats.expiringContracts; track contract){
                    <tr>
                      <td>{{ contract.customerId.firstName }} {{ contract.customerId.lastName }}</td>
                      <td>{{ contract.supplierId.name }}</td>
                      <td>{{ contract.endDate | date:'dd.MM.yyyy' }}</td>
                      <td>
                        <span class="badge" [class.badge-danger]="getDaysRemaining(contract.endDate) <= 30">
                          {{ getDaysRemaining(contract.endDate) }} {{ 'DASHBOARD.DAYS' | translate }}
                        </span>
                      </td>
                    </tr>
                  }
                  </tbody>
                </table>
              </app-table-container>
            </div>
          }
          <!-- ALLE STATISTIKEN (unten, mit Favorit-Toggle) -->
          <div class="all-stats-section" *ngIf="stats">
            <div class="section-header" (click)="showMoreStats = !showMoreStats">
              <h2>
                <i class="fas fa-th-large"></i>
                {{ 'DASHBOARD.ALL_STATS' | translate }}
              </h2>
              <i class="fas" [class.fa-chevron-down]="!showMoreStats" [class.fa-chevron-up]="showMoreStats"></i>
            </div>

            <div class="accordion-content" [class.open]="showMoreStats">
              <p class="stats-hint">
                <i class="fas fa-info-circle"></i>
                {{ 'DASHBOARD.FAVORITE_HINT' | translate }}
              </p>
              <div class="stats-grid">
                <!-- Erinnerungen -->
                @if(stats.reminders) {
                  <div class="stat-card" [class.is-favorite]="isFavorite('reminders')">
                    <div class="card-actions">
                      <button class="favorite-toggle" (click)="toggleFavorite('reminders', $event)" [title]="isFavorite('reminders') ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'">
                        <i [class.fas]="isFavorite('reminders')" [class.far]="!isFavorite('reminders')" class="fa-star"></i>
                      </button>
                      <div class="info-tooltip-container">
                        <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('allReminders', $event)"></i>
                        @if(activeTooltip === 'allReminders') {
                          <div class="info-tooltip">
                            <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.REMINDERS' | translate }}</div>
                            <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                          </div>
                        }
                      </div>
                    </div>
                    <h3><i class="fas fa-bell"></i> {{ 'SETTINGS.REMINDERS.TITLE' | translate }}</h3>
                    <div class="reminder-stats">
                      <div class="reminder-item high">
                        <span class="count">{{ stats.reminders.urgent || 0 }}</span>
                        <span class="label">{{ 'TODOS.PRIORITY.URGENT' | translate }}</span>
                      </div>
                      <div class="reminder-item medium">
                        <span class="count">{{ stats.reminders.total || 0 }}</span>
                        <span class="label">{{ 'COMMON.ALL' | translate }}</span>
                      </div>
                    </div>
                  </div>
                }

                <!-- Verträge -->
                <div class="stat-card" [class.is-favorite]="isFavorite('contracts')">
                  <div class="card-actions">
                    <button class="favorite-toggle" (click)="toggleFavorite('contracts', $event)" [title]="isFavorite('contracts') ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'">
                      <i [class.fas]="isFavorite('contracts')" [class.far]="!isFavorite('contracts')" class="fa-star"></i>
                    </button>
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('allContracts', $event)"></i>
                      @if(activeTooltip === 'allContracts') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.CONTRACTS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                  </div>
                  <h3><i class="fas fa-file-contract"></i> {{ 'DASHBOARD.CONTRACTS' | translate }}</h3>
                  <div class="stat-split">
                    <div>
                      <div class="stat-number small">{{ stats.contracts?.active || 0 }}</div>
                      <div class="stat-label">{{ 'DASHBOARD.ACTIVE' | translate }}</div>
                    </div>
                    <div>
                      <div class="stat-number small">{{ stats.contracts?.total || 0 }}</div>
                      <div class="stat-label">{{ 'COMMON.ALL' | translate }}</div>
                    </div>
                  </div>
                </div>

                <!-- Zählerablesungen -->
                <div class="stat-card" [class.is-favorite]="isFavorite('recentReadings')">
                  <div class="card-actions">
                    <button class="favorite-toggle" (click)="toggleFavorite('recentReadings', $event)" [title]="isFavorite('recentReadings') ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'">
                      <i [class.fas]="isFavorite('recentReadings')" [class.far]="!isFavorite('recentReadings')" class="fa-star"></i>
                    </button>
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('allRecentReadings', $event)"></i>
                      @if(activeTooltip === 'allRecentReadings') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.RECENT_CONTRACTS_READINGS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                  </div>
                  <h3><i class="fas fa-tachometer-alt"></i> {{ 'DASHBOARD.RECENT_CONTRACTS_READINGS' | translate }}</h3>
                  <div class="stat-split">
                    <div>
                      <div class="stat-number small">{{ stats.recentContractsReadings?.withReadings || 0 }}/{{ stats.recentContractsReadings?.totalContracts || 0 }}</div>
                      <div class="stat-label">{{ 'DASHBOARD.WITH_READINGS' | translate }}</div>
                    </div>
                    <div>
                      <div class="stat-number small" [class.text-warning]="stats.recentContractsReadings?.withoutReadings > 0">{{ stats.recentContractsReadings?.withoutReadings || 0 }}</div>
                      <div class="stat-label">{{ 'DASHBOARD.WITHOUT_READINGS' | translate }}</div>
                    </div>
                  </div>
                </div>

                <!-- Kunden -->
                <div class="stat-card" [class.is-favorite]="isFavorite('customers')">
                  <div class="card-actions">
                    <button class="favorite-toggle" (click)="toggleFavorite('customers', $event)" [title]="isFavorite('customers') ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'">
                      <i [class.fas]="isFavorite('customers')" [class.far]="!isFavorite('customers')" class="fa-star"></i>
                    </button>
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('allCustomers', $event)"></i>
                      @if(activeTooltip === 'allCustomers') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.CUSTOMERS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                  </div>
                  <h3><i class="fas fa-users"></i> {{ 'DASHBOARD.CUSTOMERS' | translate }}</h3>
                  <div class="stat-number">{{ stats.customers?.active || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.ACTIVE' | translate }}</div>
                </div>

                <!-- Zähler -->
                <div class="stat-card" [class.is-favorite]="isFavorite('meters')">
                  <div class="card-actions">
                    <button class="favorite-toggle" (click)="toggleFavorite('meters', $event)" [title]="isFavorite('meters') ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'">
                      <i [class.fas]="isFavorite('meters')" [class.far]="!isFavorite('meters')" class="fa-star"></i>
                    </button>
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('allMeters', $event)"></i>
                      @if(activeTooltip === 'allMeters') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.METERS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                  </div>
                  <h3><i class="fas fa-bolt"></i> {{ 'DASHBOARD.METERS' | translate }}</h3>
                  <div class="stat-split">
                    <div>
                      <div class="stat-number small">{{ stats.meters?.free || 0 }}</div>
                      <div class="stat-label">{{ 'METERS.STATUS.FREE' | translate }}</div>
                    </div>
                    <div>
                      <div class="stat-number small">{{ stats.meters?.occupied || 0 }}</div>
                      <div class="stat-label">{{ 'METERS.STATUS.OCCUPIED' | translate }}</div>
                    </div>
                  </div>
                </div>

                <!-- Neue Kunden -->
                <div class="stat-card" [class.is-favorite]="isFavorite('newCustomers')">
                  <div class="card-actions">
                    <button class="favorite-toggle" (click)="toggleFavorite('newCustomers', $event)" [title]="isFavorite('newCustomers') ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'">
                      <i [class.fas]="isFavorite('newCustomers')" [class.far]="!isFavorite('newCustomers')" class="fa-star"></i>
                    </button>
                    <div class="info-tooltip-container">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('allNewCustomers', $event)"></i>
                      @if(activeTooltip === 'allNewCustomers') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.NEW_CUSTOMERS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                  </div>
                  <h3><i class="fas fa-user-plus"></i> {{ 'DASHBOARD.NEW_CUSTOMERS' | translate }}</h3>
                  <div class="stat-number">{{ stats.newCustomers?.count || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.LAST_MONTH' | translate }}</div>
                </div>

                <!-- Überfällige Verträge -->
                @if(stats.overdueContracts) {
                  <div class="stat-card warning-card clickable" [class.is-favorite]="isFavorite('overdueContracts')" [class.priority-high]="stats.overdueContracts.count > 0" (click)="openOverdueModal($event)">
                    <div class="card-actions" (click)="$event.stopPropagation()">
                      <button class="favorite-toggle" (click)="toggleFavorite('overdueContracts', $event)" [title]="isFavorite('overdueContracts') ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'">
                        <i [class.fas]="isFavorite('overdueContracts')" [class.far]="!isFavorite('overdueContracts')" class="fa-star"></i>
                      </button>
                      <div class="info-tooltip-container">
                        <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('allOverdueContracts', $event)"></i>
                        @if(activeTooltip === 'allOverdueContracts') {
                          <div class="info-tooltip">
                            <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.OVERDUE_CONTRACTS' | translate }}</div>
                            <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                          </div>
                        }
                      </div>
                    </div>
                    <h3><i class="fas fa-exclamation-triangle"></i> {{ 'DASHBOARD.OVERDUE_CONTRACTS' | translate }}</h3>
                    <div class="stat-number warning-text">{{ stats.overdueContracts.count || 0 }}</div>
                    <div class="stat-label">{{ 'DASHBOARD.OVERDUE_CONTRACTS_DESC' | translate }}</div>
                    @if(stats.overdueContracts.count > 0) {
                      <div class="click-hint"><i class="fas fa-external-link-alt"></i> {{ 'COMMON.CLICK_TO_VIEW' | translate }}</div>
                    }
                  </div>
                }
              </div>

              <!-- Überfällige Verträge Liste -->
              @if(stats.overdueContracts && stats.overdueContracts.list && stats.overdueContracts.list.length > 0) {
                <div class="overdue-contracts-section">
                  <h3><i class="fas fa-exclamation-triangle"></i> {{ 'DASHBOARD.OVERDUE_CONTRACTS_LIST' | translate }}</h3>
                  <app-table-container>
                    <table class="data-table">
                      <thead>
                        <tr>
                          <th>{{ 'CONTRACTS.FIELDS.CUSTOMER' | translate }}</th>
                          <th>{{ 'CONTRACTS.FIELDS.CONTRACT_NUMBER' | translate }}</th>
                          <th>{{ 'CONTRACTS.FIELDS.SUPPLIER' | translate }}</th>
                          <th>{{ 'CONTRACTS.FIELDS.END_DATE' | translate }}</th>
                          <th>{{ 'CONTRACTS.DAYS_OVERDUE' | translate }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for(contract of stats.overdueContracts.list; track contract._id) {
                          <tr class="clickable-row" (click)="navigateToContract(contract._id)">
                            <td>{{ contract.customerId?.firstName }} {{ contract.customerId?.lastName }}</td>
                            <td>{{ contract.contractNumber }}</td>
                            <td>{{ contract.supplierId?.shortName || contract.supplierId?.name }}</td>
                            <td>{{ contract.endDate | date:'dd.MM.yyyy' }}</td>
                            <td>
                              <span class="badge badge-danger">
                                {{ getDaysOverdue(contract.endDate) }} {{ 'DASHBOARD.DAYS' | translate }}
                              </span>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </app-table-container>
                </div>
              }

              <!-- Charts Grid Container (2 Spalten auf Desktop) -->
              <div class="charts-grid">
                <!-- Monatliche Trends Chart -->
                @if(chartData){
                  <div class="trends-section" [class.is-favorite]="isFavorite('monthlyTrends')">
                    <div class="trends-header">
                      <h3><i class="fas fa-chart-line"></i> {{ 'DASHBOARD.MONTHLY_TRENDS' | translate }}</h3>
                      <div class="header-actions">
                        <button class="favorite-toggle" (click)="toggleFavorite('monthlyTrends', $event)" [title]="isFavorite('monthlyTrends') ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'">
                          <i [class.fas]="isFavorite('monthlyTrends')" [class.far]="!isFavorite('monthlyTrends')" class="fa-star"></i>
                        </button>
                        <div class="info-tooltip-container inline">
                          <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('monthlyTrends', $event)"></i>
                          @if(activeTooltip === 'monthlyTrends') {
                            <div class="info-tooltip">
                              <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.MONTHLY_TRENDS' | translate }}</div>
                              <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                            </div>
                          }
                        </div>
                        <select [(ngModel)]="chartMonths" (change)="onChartMonthsChange()" class="months-select">
                          <option [value]="3">3 {{ 'COMMON.MONTHS' | translate }}</option>
                          <option [value]="6">6 {{ 'COMMON.MONTHS' | translate }}</option>
                          <option [value]="12">12 {{ 'COMMON.MONTHS' | translate }}</option>
                        </select>
                      </div>
                    </div>

                    <div class="trends-chart-container">
                      <!-- Legende -->
                      <div class="chart-legend">
                        <div class="legend-item">
                          <span class="legend-color contracts"></span>
                          <span>{{ 'DASHBOARD.CONTRACTS' | translate }}</span>
                        </div>
                        <div class="legend-item">
                          <span class="legend-color customers"></span>
                          <span>{{ 'DASHBOARD.CUSTOMERS' | translate }}</span>
                        </div>
                        <div class="legend-item">
                          <span class="legend-color meters"></span>
                          <span>{{ 'DASHBOARD.METERS' | translate }}</span>
                        </div>
                      </div>

                      <!-- Chart -->
                      <div class="bar-chart">
                        @for(label of chartData.labels; track label; let i = $index) {
                          <div class="chart-column">
                            <div class="bars-group">
                              <div class="vertical-bar contracts"
                                   [style.height.%]="getBarHeight(chartData.contracts[i])"
                                   [title]="'Verträge: ' + chartData.contracts[i]">
                                @if(chartData.contracts[i] > 0) {
                                  <span class="bar-value-top">{{ chartData.contracts[i] }}</span>
                                }
                              </div>
                              <div class="vertical-bar customers"
                                   [style.height.%]="getBarHeight(chartData.customers[i])"
                                   [title]="'Kunden: ' + chartData.customers[i]">
                                @if(chartData.customers[i] > 0) {
                                  <span class="bar-value-top">{{ chartData.customers[i] }}</span>
                                }
                              </div>
                              <div class="vertical-bar meters"
                                   [style.height.%]="getBarHeight(chartData.meters[i])"
                                   [title]="'Zähler: ' + chartData.meters[i]">
                                @if(chartData.meters[i] > 0) {
                                  <span class="bar-value-top">{{ chartData.meters[i] }}</span>
                                }
                              </div>
                            </div>
                            <div class="chart-label">{{ label }}</div>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                }

                <!-- Verträge nach Anbieter -->
                @if(stats?.contractsBySupplier){
                  <div class="supplier-section" [class.is-favorite]="isFavorite('contractsBySupplier')">
                  <div class="section-header-with-info">
                    <h3><i class="fas fa-chart-pie"></i> {{ 'DASHBOARD.CONTRACTS_BY_SUPPLIER' | translate }}</h3>
                    <div class="header-actions">
                      <button class="favorite-toggle" (click)="toggleFavorite('contractsBySupplier', $event)" [title]="isFavorite('contractsBySupplier') ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'">
                        <i [class.fas]="isFavorite('contractsBySupplier')" [class.far]="!isFavorite('contractsBySupplier')" class="fa-star"></i>
                      </button>
                      <div class="info-tooltip-container inline">
                        <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('contractsBySupplier', $event)"></i>
                        @if(activeTooltip === 'contractsBySupplier') {
                          <div class="info-tooltip">
                            <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.CONTRACTS_BY_SUPPLIER' | translate }}</div>
                            <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                          </div>
                        }
                      </div>
                    </div>
                  </div>

                  <div class="supplier-stats-container">
                    <!-- Kreisdiagramm -->
                    <div class="pie-chart-wrapper">
                      <div class="pie-chart" [style.background]="getPieChartGradient()">
                        <div class="pie-chart-center">
                          <span class="pie-total">{{ getTotalSupplierContracts() }}</span>
                          <span class="pie-label">{{ 'COMMON.TOTAL' | translate }}</span>
                        </div>
                      </div>
                    </div>

                    <!-- Legende mit Tabelle -->
                    <div class="supplier-legend">
                      <div class="supplier-table">
                        <div class="supplier-row header">
                          <span class="supplier-name">{{ 'SUPPLIERS.FIELDS.NAME' | translate }}</span>
                          <span class="supplier-count">{{ 'DASHBOARD.CONTRACTS' | translate }}</span>
                          <span class="supplier-percent">%</span>
                        </div>
                        @for(item of stats.contractsBySupplier; track item._id; let i = $index) {
                          <div class="supplier-row">
                            <span class="supplier-name">
                              <span class="color-dot" [style.background]="getSupplierColor(i)"></span>
                              {{ item.shortName || item.name }}
                            </span>
                            <span class="supplier-count">{{ item.count }}</span>
                            <span class="supplier-percent">{{ getSupplierPercentage(item.count) }}%</span>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                </div>
              }

              <!-- Vertragsstatistik nach Status -->
              <div class="contract-statistics-section" [class.is-favorite]="isFavorite('contractStatistics')">
                <div class="section-header-with-info">
                  <h3><i class="fas fa-chart-bar"></i> {{ 'STATISTICS.TITLE' | translate }}</h3>
                  <div class="header-actions">
                    <button class="favorite-toggle" (click)="toggleFavorite('contractStatistics', $event)" [title]="isFavorite('contractStatistics') ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'">
                      <i [class.fas]="isFavorite('contractStatistics')" [class.far]="!isFavorite('contractStatistics')" class="fa-star"></i>
                    </button>
                    <div class="info-tooltip-container inline">
                      <i class="fas fa-info-circle info-icon" (click)="toggleTooltip('contractStatistics', $event)"></i>
                      @if(activeTooltip === 'contractStatistics') {
                        <div class="info-tooltip">
                          <div class="tooltip-content">{{ 'DASHBOARD.TOOLTIPS.CONTRACT_STATISTICS' | translate }}</div>
                          <button class="tooltip-close" (click)="closeTooltip($event)"><i class="fas fa-times"></i></button>
                        </div>
                      }
                    </div>
                  </div>
                </div>

                <!-- Filter-Bereich -->
                <div class="statistics-filters">
                  <!-- Zeitraum-Auswahl -->
                  <div class="filter-group">
                    <span class="filter-label">{{ 'STATISTICS.SELECT_PERIOD' | translate }}:</span>
                    <div class="period-buttons">
                      @for(option of contractStatsMonthOptions; track option) {
                        <button
                          class="period-btn"
                          [class.active]="contractStatsMonths === option && !showCustomMonthsInput"
                          (click)="onContractStatsMonthsChange(option)">
                          {{ option }} {{ 'COMMON.MONTHS' | translate }}
                        </button>
                      }
                      <button
                        class="period-btn"
                        [class.active]="showCustomMonthsInput"
                        (click)="showCustomMonthsInput = true">
                        {{ 'STATISTICS.CUSTOM' | translate }}
                      </button>
                    </div>
                    @if(showCustomMonthsInput) {
                      <div class="custom-months-input">
                        <input
                          type="number"
                          [(ngModel)]="customMonths"
                          min="1"
                          max="24"
                          placeholder="1-24"
                          (change)="onCustomMonthsChange()" />
                        <span>{{ 'COMMON.MONTHS' | translate }}</span>
                      </div>
                    }
                  </div>

                  <!-- Anbieter-Filter -->
                  @if(contractStats && contractStats.suppliers && contractStats.suppliers.length > 0) {
                    <div class="filter-group supplier-filter-group">
                      <span class="filter-label">{{ 'STATISTICS.FILTER_SUPPLIER' | translate }}:</span>
                      <div class="supplier-autocomplete">
                        <input
                          type="text"
                          class="supplier-search-input"
                          [placeholder]="'SUPPLIERS.SEARCH' | translate"
                          [(ngModel)]="supplierSearchQuery"
                          (input)="onSupplierSearchInput()"
                          (focus)="onSupplierSearchFocus()"
                          (blur)="closeSupplierDropdownDelayed()"
                          autocomplete="off" />
                        @if(selectedSupplierId !== 'all') {
                          <button type="button" class="btn-clear-supplier" (click)="clearSupplierSelection()">
                            <i class="fas fa-times"></i>
                          </button>
                        }
                        @if(showSupplierDropdown && filteredSuppliers.length > 0) {
                          <div class="supplier-dropdown">
                            <div
                              class="supplier-dropdown-item"
                              [class.selected]="selectedSupplierId === 'all'"
                              (mousedown)="selectSupplierFilter(null); $event.preventDefault()">
                              {{ 'STATISTICS.ALL_SUPPLIERS' | translate }}
                            </div>
                            @for(supplier of filteredSuppliers; track supplier._id) {
                              <div
                                class="supplier-dropdown-item"
                                [class.selected]="selectedSupplierId === supplier._id"
                                (mousedown)="selectSupplierFilter(supplier); $event.preventDefault()">
                                {{ supplier.shortName || supplier.name }}
                              </div>
                            }
                          </div>
                        }
                        @if(showSupplierDropdown && filteredSuppliers.length === 0 && supplierSearchQuery.length > 0) {
                          <div class="supplier-dropdown">
                            <div class="supplier-dropdown-item no-results">
                              {{ 'COMMON.NO_RESULTS' | translate }}
                            </div>
                          </div>
                        }
                      </div>
                      @if(selectedSupplierId !== 'all' && getSelectedSupplierName()) {
                        <div class="selected-supplier-badge">
                          <span>{{ getSelectedSupplierName() }}</span>
                          <button type="button" class="btn-remove-badge" (click)="clearSupplierSelection()">
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                      }
                    </div>
                  }
                </div>

                @if(contractStatsLoading) {
                  <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i> {{ 'COMMON.LOADING' | translate }}...
                  </div>
                }

                @if(contractStats && !contractStatsLoading) {
                  <!-- Status-Übersicht Karten -->
                  <div class="status-overview">
                    @for(dataset of contractStats.chartData.datasets; track dataset.status) {
                      <div class="status-card" [style.border-left-color]="getStatusColor(dataset.status)">
                        <div class="status-label">{{ dataset.label }}</div>
                        <div class="status-value">{{ getContractStatValue(contractStats.periodStats, dataset.status) }}</div>
                      </div>
                    }
                    <div class="status-card total">
                      <div class="status-label">{{ 'COMMON.TOTAL' | translate }}</div>
                      <div class="status-value">{{ contractStats.periodStats.total }}</div>
                    </div>
                  </div>

                  <!-- Endende Verträge im Zeitraum -->
                  @if(contractStats.endingContracts && contractStats.endingContracts.count > 0) {
                    <div class="ending-contracts-section">
                      <div class="ending-contracts-header">
                        <h4><i class="fas fa-calendar-times"></i> {{ 'STATISTICS.ENDING_CONTRACTS' | translate }} ({{ contractStats.endingContracts.count }})</h4>
                      </div>
                      <div class="ending-contracts-list">
                        @for(contract of contractStats.endingContracts.list; track contract._id) {
                          <div class="ending-contract-item" (click)="navigateToContract(contract._id)">
                            <div class="contract-info">
                              <span class="contract-number">{{ contract.contractNumber }}</span>
                              <span class="customer-name">{{ contract.customerId?.firstName }} {{ contract.customerId?.lastName }}</span>
                              <span class="supplier-name">{{ contract.supplierId?.shortName || contract.supplierId?.name }}</span>
                            </div>
                            <div class="contract-end-date">
                              <i class="fas fa-calendar-alt"></i>
                              {{ contract.endDate | date:'dd.MM.yyyy' }}
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }

                  <!-- Balkendiagramm -->
                  <div class="contract-chart">
                    <div class="chart-legend">
                      @for(dataset of contractStats.chartData.datasets; track dataset.status) {
                        <div class="legend-item">
                          <span class="legend-color" [style.background-color]="getStatusColor(dataset.status)"></span>
                          <span>{{ dataset.label }}</span>
                        </div>
                      }
                    </div>

                    <div class="stacked-bar-chart">
                      @for(label of contractStats.chartData.labels; track label; let i = $index) {
                        <div class="chart-column">
                          <div class="stacked-bars">
                            @for(dataset of contractStats.chartData.datasets; track dataset.status) {
                              @if(dataset.data[i] > 0) {
                                <div
                                  class="bar-segment"
                                  [style.height.%]="getContractBarHeight(dataset.data[i])"
                                  [style.background-color]="getStatusColor(dataset.status)"
                                  [title]="dataset.label + ': ' + dataset.data[i]">
                                  <span class="bar-value">{{ dataset.data[i] }}</span>
                                </div>
                              }
                            }
                          </div>
                          <div class="chart-label">{{ label }}</div>
                          <div class="chart-total">{{ getTotalForMonth(i) }}</div>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
              </div><!-- Ende charts-grid -->
            </div>
          </div>
        </div>
      }
    </div>
}

<!-- Modal für überfällige Verträge -->
@if(showOverdueModal) {
  <div class="modal-overlay" (click)="closeOverdueModal()">
    <div class="modal-container overdue-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2><i class="fas fa-exclamation-triangle warning-icon"></i> {{ 'DASHBOARD.OVERDUE_CONTRACTS' | translate }}</h2>
        <button class="modal-close" (click)="closeOverdueModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        @if(stats?.overdueContracts?.list?.length > 0) {
          <p class="modal-subtitle">{{ 'DASHBOARD.OVERDUE_MODAL_SUBTITLE' | translate }}</p>
          <div class="overdue-list">
            @for(contract of stats.overdueContracts.list; track contract._id) {
              <div class="overdue-item" (click)="navigateToContract(contract._id)">
                <div class="overdue-item-main">
                  <div class="overdue-customer">
                    <i class="fas fa-user"></i>
                    {{ contract.customerId?.firstName }} {{ contract.customerId?.lastName }}
                  </div>
                  <div class="overdue-contract-number">
                    <i class="fas fa-file-contract"></i>
                    {{ contract.contractNumber }}
                  </div>
                </div>
                <div class="overdue-item-details">
                  <div class="overdue-supplier">
                    <i class="fas fa-building"></i>
                    {{ contract.supplierId?.shortName || contract.supplierId?.name }}
                  </div>
                  <div class="overdue-date">
                    <i class="fas fa-calendar-times"></i>
                    {{ contract.endDate | date:'dd.MM.yyyy' }}
                  </div>
                </div>
                <div class="overdue-badge">
                  <span class="badge badge-danger">
                    {{ getDaysOverdue(contract.endDate) }} {{ 'DASHBOARD.DAYS' | translate }}
                  </span>
                  <i class="fas fa-chevron-right"></i>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="no-data">
            <i class="fas fa-check-circle"></i>
            <p>{{ 'DASHBOARD.NO_OVERDUE_CONTRACTS' | translate }}</p>
          </div>
        }
      </div>
    </div>
  </div>
}