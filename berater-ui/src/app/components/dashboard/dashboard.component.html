@if(isMobile){
  <app-dashboard-mobile
    [stats]="stats"
    [userStats]="userStats"
    [isSuperAdmin]="isSuperAdmin"
    [maxContracts]="maxContracts"
    [maxUsers]="maxUsers"
    [subscriptionInfo]="subscriptionInfo"
    [subscriptionWarningMessage]="getSubscriptionWarningMessage()"
    [subscriptionWarningLevel]="getSubscriptionWarningLevel()"
    [chartData]="chartData"
    [maxChartValue]="maxChartValue"
    (approveUpgradeEvent)="approveUpgrade($event)"
    (rejectUpgradeEvent)="rejectUpgrade($event)"
    (chartMonthsChange)="chartMonths = $event; loadChartData()"
  ></app-dashboard-mobile>
} @else {
    <div class="dashboard">
      <h1>{{ 'DASHBOARD.TITLE' | translate }}</h1>

      <!-- Superadmin Dashboard -->
      @if(isSuperAdmin){
        <div>
          @if(userStats){
            <div class="stats-grid">
              <!-- Gesamt Benutzer -->
              <div class="stat-card">
                <h3><i class="fas fa-users"></i>{{ 'ADMIN.USERS' | translate }}</h3>
                <div class="stat-number">{{ userStats.total || 0 }}</div>
                <div class="stat-label">{{ 'COMMON.ALL' | translate }}</div>
              </div>

              <!-- Aktive Benutzer -->
              <div class="stat-card">
                <h3><i class="fas fa-check-circle"></i> {{ 'DASHBOARD.ACTIVE' | translate }}</h3>
                <div class="stat-number">{{ userStats.active || 0 }}</div>
                <div class="stat-label">{{ 'ADMIN.STATUS.ACTIVE' | translate }}</div>
              </div>

              <!-- Blockierte Benutzer -->
              <div class="stat-card">
                <h3><i class="fas fa-ban"></i> {{ 'ADMIN.STATUS.BLOCKED' | translate }}</h3>
                <div class="stat-number">{{ userStats.blocked || 0 }}</div>
                <div class="stat-label">{{ 'ADMIN.STATUS.BLOCKED' | translate }}</div>
              </div>
              <div class="stat-card">
                <h3><i class="fas fa-box"></i> {{ 'ADMIN.FIELDS.PACKAGE' | translate }}</h3>
                <div class="stat-number">{{ userStats.package || 0 }}</div>
                <div class="stat-label">{{ 'ADMIN.FIELDS.PACKAGE' | translate }}</div>
              </div>

            </div>
          }
          <!-- Benutzer nach Rolle -->
          <div class="supplier-section" *ngIf="userStats?.byRole">
            <h2><i class="fas fa-chart-bar"></i> {{ 'ADMIN.USERS' | translate }} {{ 'ADMIN.FIELDS.ROLE' | translate }}</h2>
            <div class="chart-container">
              <div *ngFor="let item of getRoleStats()" class="chart-bar">
                <div class="bar-label">{{ item.name }}</div>
                <div class="bar-wrapper">
                  <div class="bar" [style.width.%]="getPercentage(item.count)"></div>
                  <span class="bar-value">{{ item.count }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Benutzer nach Paket -->
          <div class="supplier-section" *ngIf="userStats?.byPackage">
            <h2><i class="fas fa-box"></i> {{ 'ADMIN.USERS' | translate }} {{ 'ADMIN.FIELDS.PACKAGE' | translate }}</h2>
            <div class="chart-container">
              <div *ngFor="let item of getPackageStats()" class="chart-bar">
                <div class="bar-label">{{ item.name }}</div>
                <div class="bar-wrapper">
                  <div class="bar" [style.width.%]="getPercentage(item.count)"></div>
                  <span class="bar-value">{{ item.count }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Ablaufende Pakete -->
           @if(expiringSubscriptions.length > 0 || expiredSubscriptions.length > 0){
            <div class="expiring-subscriptions-section">
              <h2><i class="fas fa-exclamation-triangle"></i> {{ 'DASHBOARD.EXPIRING_PACKAGES' | translate }}</h2>

              <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card priority-high">
                  <h3><i class="fas fa-clock"></i> {{ 'DASHBOARD.EXPIRED' | translate }}</h3>
                  <div class="stat-number">{{ expiredSubscriptions.length }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PACKAGES' | translate }}</div>
                </div>
                <div class="stat-card">
                  <h3><i class="fas fa-exclamation-triangle"></i> {{ 'DASHBOARD.URGENT_DAYS' | translate }}</h3>
                  <div class="stat-number">{{ getCountByWarningLevel('danger') }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PACKAGES' | translate }}</div>
                </div>
                <div class="stat-card">
                  <h3><i class="fas fa-calendar-alt"></i> {{ 'DASHBOARD.WARNING_DAYS' | translate }}</h3>
                  <div class="stat-number">{{ getCountByWarningLevel('warning') }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PACKAGES' | translate }}</div>
                </div>
                <div class="stat-card">
                  <h3><i class="fas fa-info-circle"></i> {{ 'DASHBOARD.INFO_DAYS' | translate }}</h3>
                  <div class="stat-number">{{ getCountByWarningLevel('info') }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PACKAGES' | translate }}</div>
                </div>
              </div>

              <!-- Action Button for Expired Packages -->
              @if(expiredSubscriptions.length > 0){
                <div style="margin-bottom: 1.5rem;">
                  <button class="btn-danger" (click)="downgradeExpiredPackages()">
                    <i class="fas fa-arrow-down"></i> {{ 'DASHBOARD.DOWNGRADE_EXPIRED' | translate }} ({{ expiredSubscriptions.length }})
                  </button>
                </div>
              }
              <!-- Expired Subscriptions Table -->
              @if(expiredSubscriptions.length > 0){
                <div style="margin-bottom: 2rem;">
                  <h3 style="color: #c62828; margin-bottom: 1rem;"><i class="fas fa-times-circle"></i> {{ 'DASHBOARD.EXPIRED_PACKAGES' | translate }}</h3>
                  <app-table-container>
                    <table class="data-table">
                      <thead>
                        <tr>
                          <th>{{ 'DASHBOARD.USER' | translate }}</th>
                          <th>{{ 'COMMON.EMAIL' | translate }}</th>
                          <th>{{ 'ADMIN.FIELDS.PACKAGE' | translate }}</th>
                          <th>{{ 'DASHBOARD.EXPIRED_SINCE' | translate }}</th>
                          <th>{{ 'DASHBOARD.LAST_LOGIN' | translate }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let user of expiredSubscriptions">
                          <td>{{ user.firstName }} {{ user.lastName }}</td>
                          <td>{{ user.email }}</td>
                          <td>{{ user.package }}</td>
                          <td>
                            <span class="badge badge-expired">
                              {{ user.daysExpired }} {{ 'DASHBOARD.DAYS' | translate }}
                            </span>
                          </td>
                          <td>{{ user.lastLogin ? (user.lastLogin | date:'dd.MM.yyyy HH:mm') : ('DASHBOARD.NEVER' | translate) }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </app-table-container>
                </div>
              }
              <!-- Expiring Subscriptions Table -->
                @if(expiringSubscriptions.length > 0){
                  <div>
                    <h3 style="color: #f57c00; margin-bottom: 1rem;"><i class="fas fa-clock"></i> {{ 'DASHBOARD.EXPIRING_PACKAGES_SOON' | translate }}</h3>
                    <app-table-container>
                      <table class="data-table">
                        <thead>
                          <tr>
                            <th>{{ 'DASHBOARD.USER' | translate }}</th>
                            <th>{{ 'COMMON.EMAIL' | translate }}</th>
                            <th>{{ 'ADMIN.FIELDS.PACKAGE' | translate }}</th>
                            <th>{{ 'DASHBOARD.DAYS_UNTIL_EXPIRY' | translate }}</th>
                            <th>{{ 'DASHBOARD.WARNING_LEVEL' | translate }}</th>
                            <th>{{ 'DASHBOARD.LAST_LOGIN' | translate }}</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let user of expiringSubscriptions">
                            <td>{{ user.firstName }} {{ user.lastName }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.package }}</td>
                            <td>
                              <span class="badge" [ngClass]="getWarningLevelBadgeClass(user.warningLevel)">
                                {{ user.daysUntilExpiration }} {{ 'DASHBOARD.DAYS' | translate }}
                              </span>
                            </td>
                            <td>
                              <span class="badge" [ngClass]="getWarningLevelBadgeClass(user.warningLevel)">
                                {{ getWarningLevelLabel(user.warningLevel) }}
                              </span>
                            </td>
                            <td>{{ user.lastLogin ? (user.lastLogin | date:'dd.MM.yyyy HH:mm') : ('DASHBOARD.NEVER' | translate) }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </app-table-container>
                  </div>
                }
            </div>
            }
          <!-- Upgrade-Anfragen -->
          @if(stats?.upgradeRequests){
            <div class="upgrade-requests-section">
              <h2><i class="fas fa-sync-alt"></i> {{ 'DASHBOARD.UPGRADE_REQUESTS' | translate }}</h2>
              <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card priority-high">
                  <h3><i class="fas fa-hourglass-half"></i> {{ 'DASHBOARD.AWAITING_REVIEW' | translate }}</h3>
                  <div class="stat-number">{{ stats.upgradeRequests.counts?.awaitingReview || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PENDING' | translate }} & {{ 'DASHBOARD.PAYMENT_RECEIVED' | translate }}</div>
                </div>
                <div class="stat-card">
                  <h3><i class="fas fa-file-alt"></i> {{ 'DASHBOARD.PENDING' | translate }}</h3>
                  <div class="stat-number">{{ stats.upgradeRequests.counts?.pending || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.NEWLY_CREATED' | translate }}</div>
                </div>
                <div class="stat-card">
                  <h3><i class="fas fa-money-bill-wave"></i> {{ 'DASHBOARD.PAYMENT_RECEIVED' | translate }}</h3>
                  <div class="stat-number">{{ stats.upgradeRequests.counts?.paymentReceived || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.PAYMENT_INCOMING' | translate }}</div>
                </div>
              </div>

              <div *ngIf="stats.upgradeRequests.pending?.length > 0" class="requests-list">
                <h3>{{ 'DASHBOARD.OPEN_REQUESTS' | translate }}</h3>
                <div *ngFor="let request of stats.upgradeRequests.pending" class="request-card">
                  <div class="request-header">
                    <div class="user-info">
                      <strong>{{ request.user.firstName }} {{ request.user.lastName }}</strong>
                      <span class="email">{{ request.user.email }}</span>
                    </div>
                    <span class="status-badge" [class]="'status-' + request.status">
                      {{ getStatusLabel(request.status) }}
                    </span>
                  </div>
                  <div class="request-details">
                    <div class="detail-item">
                      <span class="label">{{ 'DASHBOARD.CURRENT' | translate }}:</span>
                      <span class="value">{{ request.currentPackage }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">{{ 'DASHBOARD.REQUESTED' | translate }}:</span>
                      <span class="value highlight">{{ request.packageDetails.displayName }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">{{ 'DASHBOARD.PRICE' | translate }}:</span>
                      <span class="value">{{ request.packageDetails.price }} {{ request.packageDetails.currency }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="label">{{ 'DASHBOARD.DATE' | translate }}:</span>
                      <span class="value">{{ formatDate(request.createdAt) }}</span>
                    </div>
                  </div>
                  <div class="request-actions">
                    <button class="btn-success" (click)="approveUpgrade(request._id)">
                      <i class="fas fa-check"></i> {{ 'DASHBOARD.APPROVE' | translate }}
                    </button>
                    <button class="btn-danger" (click)="rejectUpgrade(request._id)">
                      <i class="fas fa-times"></i> {{ 'DASHBOARD.REJECT' | translate }}
                    </button>
                  </div>
                </div>
              </div>

              <div *ngIf="!stats.upgradeRequests.pending || stats.upgradeRequests.pending.length === 0" class="no-data">
                <p>{{ 'DASHBOARD.NO_OPEN_REQUESTS' | translate }}</p>
              </div>
            </div>
          }
        </div>
      }
      <!-- Berater/Admin Dashboard -->
       @if(!isSuperAdmin){
        <div>
          <!-- Subscription Expiration Warning -->
           @if(shouldShowSubscriptionWarning()){
            <div class="subscription-warning-banner"
                [class.warning-expired]="getSubscriptionWarningLevel() === 'expired'"
                [class.warning-danger]="getSubscriptionWarningLevel() === 'danger'"
                [class.warning-warning]="getSubscriptionWarningLevel() === 'warning'"
                [class.warning-info]="getSubscriptionWarningLevel() === 'info'">
              <div class="warning-icon">
                <i class="fas"
                  [class.fa-exclamation-triangle]="getSubscriptionWarningLevel() === 'expired' || getSubscriptionWarningLevel() === 'danger'"
                  [class.fa-info-circle]="getSubscriptionWarningLevel() === 'warning' || getSubscriptionWarningLevel() === 'info'"></i>
              </div>
              <div class="warning-content">
                <div class="warning-title">
                  <span *ngIf="getSubscriptionWarningLevel() === 'expired'">{{ 'DASHBOARD.SUBSCRIPTION.EXPIRED' | translate }}</span>
                  <span *ngIf="getSubscriptionWarningLevel() === 'danger'">{{ 'DASHBOARD.SUBSCRIPTION.EXPIRING_SOON' | translate }}</span>
                  <span *ngIf="getSubscriptionWarningLevel() === 'warning'">{{ 'DASHBOARD.SUBSCRIPTION.REMINDER' | translate }}</span>
                  <span *ngIf="getSubscriptionWarningLevel() === 'info'">{{ 'DASHBOARD.SUBSCRIPTION.INFO' | translate }}</span>
                </div>
                <div class="warning-message">{{ getSubscriptionWarningMessage() }}</div>
              </div>
              <div class="warning-action">
                <a routerLink="/settings" class="btn-renew">{{ 'DASHBOARD.SUBSCRIPTION.RENEW' | translate }}</a>
              </div>
            </div>
          }
          <div class="stats-grid" *ngIf="stats">
            <!-- Erinnerungen -->
             @if(stats.reminders){
              <div class="stat-card priority-high clickable" routerLink="/todos">
                <h3><i class="fas fa-bell"></i> {{ 'SETTINGS.REMINDERS.TITLE' | translate }}</h3>
                <div class="reminder-stats">
                  <div class="reminder-item high">
                    <span class="count">{{ stats.reminders.urgent || 0 }}</span>
                    <span class="label">{{ 'TODOS.PRIORITY.URGENT' | translate }}</span>
                  </div>
                  <div class="reminder-item medium">
                    <span class="count">{{ stats.reminders.total || 0 }}</span>
                    <span class="label">{{ 'COMMON.ALL' | translate }}</span>
                  </div>
                </div>
              </div>
            }

            <!-- Verträge (Hauptstatistik) -->
            <div class="stat-card">
              <h3><i class="fas fa-file-contract"></i> {{ 'DASHBOARD.CONTRACTS' | translate }}</h3>
              <div class="stat-split">
                <div>
                  <div class="stat-number small">{{ stats.contracts?.active || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.ACTIVE' | translate }}</div>
                </div>
                <div>
                  <div class="stat-number small">{{ stats.contracts?.total || 0 }}</div>
                  <div class="stat-label">{{ 'COMMON.ALL' | translate }}</div>
                </div>
              </div>
            </div>

            <!-- Neue Verträge mit Zählerablesungen -->
            <div class="stat-card clickable" routerLink="/meters">
              <h3><i class="fas fa-tachometer-alt"></i> {{ 'DASHBOARD.RECENT_CONTRACTS_READINGS' | translate }}</h3>
              <div class="stat-split">
                <div>
                  <div class="stat-number small">{{ stats.recentContractsReadings?.withReadings || 0 }}/{{ stats.recentContractsReadings?.totalContracts || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.WITH_READINGS' | translate }}</div>
                </div>
                <div>
                  <div class="stat-number small" [class.text-warning]="stats.recentContractsReadings?.withoutReadings > 0">{{ stats.recentContractsReadings?.withoutReadings || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.WITHOUT_READINGS' | translate }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Auslaufende Verträge -->
           @if(stats?.expiringContracts){
            <div class="contracts-section">
              <h2><i class="fas fa-file-contract"></i> {{ 'DASHBOARD.EXPIRING_SOON' | translate }}</h2>
              <app-table-container>
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>{{ 'CONTRACTS.FIELDS.CUSTOMER' | translate }}</th>
                      <th>{{ 'CONTRACTS.FIELDS.SUPPLIER' | translate }}</th>
                      <th>{{ 'CONTRACTS.FIELDS.END_DATE' | translate }}</th>
                      <th>{{ 'CONTRACTS.DAYS_LEFT' | translate }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for(contract of stats.expiringContracts; track contract){
                    <tr>
                      <td>{{ contract.customerId.firstName }} {{ contract.customerId.lastName }}</td>
                      <td>{{ contract.supplierId.name }}</td>
                      <td>{{ contract.endDate | date:'dd.MM.yyyy' }}</td>
                      <td>
                        <span class="badge" [class.badge-danger]="getDaysRemaining(contract.endDate) <= 30">
                          {{ getDaysRemaining(contract.endDate) }} {{ 'DASHBOARD.DAYS' | translate }}
                        </span>
                      </td>
                    </tr>
                  }
                  </tbody>
                </table>
              </app-table-container>
            </div>
          }
          <!-- Monatliche Trends Chart -->
          @if(chartData){
            <div class="trends-section">
              <div class="trends-header">
                <h2><i class="fas fa-chart-line"></i> {{ 'DASHBOARD.MONTHLY_TRENDS' | translate }}</h2>
                <select [(ngModel)]="chartMonths" (change)="onChartMonthsChange()" class="months-select">
                  <option [value]="3">3 {{ 'COMMON.MONTHS' | translate }}</option>
                  <option [value]="6">6 {{ 'COMMON.MONTHS' | translate }}</option>
                  <option [value]="12">12 {{ 'COMMON.MONTHS' | translate }}</option>
                </select>
              </div>

              <div class="trends-chart-container">
                <!-- Legende -->
                <div class="chart-legend">
                  <div class="legend-item">
                    <span class="legend-color contracts"></span>
                    <span>{{ 'DASHBOARD.CONTRACTS' | translate }}</span>
                  </div>
                  <div class="legend-item">
                    <span class="legend-color customers"></span>
                    <span>{{ 'DASHBOARD.CUSTOMERS' | translate }}</span>
                  </div>
                  <div class="legend-item">
                    <span class="legend-color meters"></span>
                    <span>{{ 'DASHBOARD.METERS' | translate }}</span>
                  </div>
                </div>

                <!-- Chart -->
                <div class="bar-chart">
                  @for(label of chartData.labels; track label; let i = $index) {
                    <div class="chart-column">
                      <div class="bars-group">
                        <div class="vertical-bar contracts"
                             [style.height.%]="getBarHeight(chartData.contracts[i])"
                             [title]="'Verträge: ' + chartData.contracts[i]">
                          @if(chartData.contracts[i] > 0) {
                            <span class="bar-value-top">{{ chartData.contracts[i] }}</span>
                          }
                        </div>
                        <div class="vertical-bar customers"
                             [style.height.%]="getBarHeight(chartData.customers[i])"
                             [title]="'Kunden: ' + chartData.customers[i]">
                          @if(chartData.customers[i] > 0) {
                            <span class="bar-value-top">{{ chartData.customers[i] }}</span>
                          }
                        </div>
                        <div class="vertical-bar meters"
                             [style.height.%]="getBarHeight(chartData.meters[i])"
                             [title]="'Zähler: ' + chartData.meters[i]">
                          @if(chartData.meters[i] > 0) {
                            <span class="bar-value-top">{{ chartData.meters[i] }}</span>
                          }
                        </div>
                      </div>
                      <div class="chart-label">{{ label }}</div>
                    </div>
                  }
                </div>
              </div>
            </div>
          }

          <!-- Weitere Statistiken Accordion -->
          <div class="more-stats-accordion" *ngIf="stats">
            <div class="accordion-header" (click)="showMoreStats = !showMoreStats">
              <h2>
                <i class="fas fa-ellipsis-h"></i>
                {{ 'DASHBOARD.MORE_STATS' | translate }}
              </h2>
              <i class="fas" [class.fa-chevron-down]="!showMoreStats" [class.fa-chevron-up]="showMoreStats"></i>
            </div>

            <div class="accordion-content" [class.open]="showMoreStats">
              <div class="stats-grid">
                <!-- Kunden -->
                <div class="stat-card">
                  <h3><i class="fas fa-users"></i> {{ 'DASHBOARD.CUSTOMERS' | translate }}</h3>
                  <div class="stat-number">{{ stats.customers?.active || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.ACTIVE' | translate }}</div>
                </div>

                <!-- Zähler -->
                <div class="stat-card">
                  <h3><i class="fas fa-bolt"></i> {{ 'DASHBOARD.METERS' | translate }}</h3>
                  <div class="stat-split">
                    <div>
                      <div class="stat-number small">{{ stats.meters?.free || 0 }}</div>
                      <div class="stat-label">{{ 'METERS.STATUS.FREE' | translate }}</div>
                    </div>
                    <div>
                      <div class="stat-number small">{{ stats.meters?.occupied || 0 }}</div>
                      <div class="stat-label">{{ 'METERS.STATUS.OCCUPIED' | translate }}</div>
                    </div>
                  </div>
                </div>

                <!-- Neue Kunden -->
                <div class="stat-card">
                  <h3><i class="fas fa-user-plus"></i> {{ 'DASHBOARD.NEW_CUSTOMERS' | translate }}</h3>
                  <div class="stat-number">{{ stats.newCustomers?.count || 0 }}</div>
                  <div class="stat-label">{{ 'DASHBOARD.LAST_MONTH' | translate }}</div>
                </div>
              </div>

              <!-- Verträge nach Anbieter -->
              @if(stats?.contractsBySupplier){
                <div class="supplier-section">
                  <h3><i class="fas fa-chart-pie"></i> {{ 'DASHBOARD.CONTRACTS_BY_SUPPLIER' | translate }}</h3>
                  <div class="chart-container">
                    <div *ngFor="let item of stats.contractsBySupplier" class="chart-bar">
                      <div class="bar-label">{{ item.name }}</div>
                      <div class="bar-wrapper">
                        <div class="bar" [style.width.%]="getPercentage(item.count)"></div>
                        <span class="bar-value">{{ item.count }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      }
    </div>
}