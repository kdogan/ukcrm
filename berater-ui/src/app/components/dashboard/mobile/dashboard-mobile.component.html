<div class="mobile-page">

  <!-- HEADER -->
  <div class="mobile-header">
    <h1>Dashboard</h1>
  </div>

  <!-- SUPERADMIN VIEW -->
  <div *ngIf="isSuperAdmin" class="mobile-content">

    <!-- Stats Cards -->
    <div class="stats-cards" *ngIf="userStats">
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-value">{{ userStats.total || 0 }}</div>
        <div class="stat-label">Benutzer</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">âœ…</div>
        <div class="stat-value">{{ userStats.active || 0 }}</div>
        <div class="stat-label">Aktive</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">ğŸš«</div>
        <div class="stat-value">{{ userStats.blocked || 0 }}</div>
        <div class="stat-label">Blockiert</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">ğŸ“¦</div>
        <div class="stat-value">{{ userStats.package || 0 }}</div>
        <div class="stat-label">Paket</div>
      </div>
    </div>

    <!-- Benutzer nach Rolle -->
    <div class="section-card" *ngIf="userStats?.byRole">
      <h2>ğŸ“Š Benutzer nach Rolle</h2>
      <div class="chart-container">
        <div *ngFor="let item of getRoleStats()" class="chart-bar">
          <div class="bar-label">{{ item.name }}</div>
          <div class="bar-wrapper">
            <div class="bar" [style.width.%]="getPercentage(item.count)"></div>
            <span class="bar-value">{{ item.count }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Benutzer nach Paket -->
    <div class="section-card" *ngIf="userStats?.byPackage">
      <h2>ğŸ“¦ Benutzer nach Paket</h2>
      <div class="chart-container">
        <div *ngFor="let item of getPackageStats()" class="chart-bar">
          <div class="bar-label">{{ item.name }}</div>
          <div class="bar-wrapper">
            <div class="bar" [style.width.%]="getPercentage(item.count)"></div>
            <span class="bar-value">{{ item.count }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Upgrade-Anfragen -->
    <div class="section-card" *ngIf="stats?.upgradeRequests">
      <h2>ğŸ”„ Upgrade-Anfragen</h2>

      <div class="upgrade-stats">
        <div class="upgrade-stat priority-high">
          <div class="upgrade-value">{{ stats.upgradeRequests.counts?.awaitingReview || 0 }}</div>
          <div class="upgrade-label">â³ Warten</div>
        </div>
        <div class="upgrade-stat">
          <div class="upgrade-value">{{ stats.upgradeRequests.counts?.pending || 0 }}</div>
          <div class="upgrade-label">ğŸ“ Pending</div>
        </div>
        <div class="upgrade-stat">
          <div class="upgrade-value">{{ stats.upgradeRequests.counts?.paymentReceived || 0 }}</div>
          <div class="upgrade-label">ğŸ’° Bezahlt</div>
        </div>
      </div>

      <!-- Offene Anfragen -->
      <div *ngIf="stats.upgradeRequests.pending?.length > 0" class="requests-list">
        <h3>Offene Anfragen</h3>
        <div *ngFor="let request of stats.upgradeRequests.pending" class="request-card">
          <div class="request-header">
            <strong>{{ request.user.firstName }} {{ request.user.lastName }}</strong>
            <span class="status-badge" [class]="'status-' + request.status">
              {{ getStatusLabel(request.status) }}
            </span>
          </div>
          <div class="request-email">{{ request.user.email }}</div>

          <div class="request-details">
            <div class="detail-row">
              <span class="detail-label">Aktuell:</span>
              <span class="detail-value">{{ request.currentPackage }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">GewÃ¼nscht:</span>
              <span class="detail-value highlight">{{ request.packageDetails.displayName }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Preis:</span>
              <span class="detail-value">{{ request.packageDetails.price }} {{ request.packageDetails.currency }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Datum:</span>
              <span class="detail-value">{{ formatDate(request.createdAt) }}</span>
            </div>
          </div>

          <div class="request-actions">
            <button class="btn-approve" (click)="approveUpgradeEvent.emit(request._id)">
              âœ“ Genehmigen
            </button>
            <button class="btn-reject" (click)="rejectUpgradeEvent.emit(request._id)">
              âœ— Ablehnen
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="!stats.upgradeRequests.pending || stats.upgradeRequests.pending.length === 0" class="no-data">
        Keine offenen Upgrade-Anfragen
      </div>
    </div>

  </div>

  <!-- BERATER/ADMIN VIEW -->
  <div *ngIf="!isSuperAdmin" class="mobile-content">

    <!-- Subscription Expiration Warning -->
    <div *ngIf="shouldShowSubscriptionWarning()"
         class="subscription-warning-banner"
         [class.warning-expired]="subscriptionWarningLevel === 'expired'"
         [class.warning-danger]="subscriptionWarningLevel === 'danger'"
         [class.warning-warning]="subscriptionWarningLevel === 'warning'"
         [class.warning-info]="subscriptionWarningLevel === 'info'">
      <div class="warning-icon">
        <i class="fas"
           [class.fa-exclamation-triangle]="subscriptionWarningLevel === 'expired' || subscriptionWarningLevel === 'danger'"
           [class.fa-info-circle]="subscriptionWarningLevel === 'warning' || subscriptionWarningLevel === 'info'"></i>
      </div>
      <div class="warning-content">
        <div class="warning-title">
          <span *ngIf="subscriptionWarningLevel === 'expired'">Paket abgelaufen</span>
          <span *ngIf="subscriptionWarningLevel === 'danger'">Paket lÃ¤uft bald ab!</span>
          <span *ngIf="subscriptionWarningLevel === 'warning'">Paket-Erinnerung</span>
          <span *ngIf="subscriptionWarningLevel === 'info'">Paket-Information</span>
        </div>
        <div class="warning-message">{{ subscriptionWarningMessage }}</div>
        <div class="warning-action">
          <a routerLink="/settings" class="btn-renew">Paket verlÃ¤ngern</a>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-cards" *ngIf="stats">
      <!-- Erinnerungen -->
      <div class="stat-card priority-high clickable" *ngIf="stats.reminders" routerLink="/todos">
        <div class="stat-icon">ğŸ””</div>
        <div class="reminder-values">
          <div class="reminder-urgent">
            <span class="count">{{ stats.reminders.urgent || 0 }}</span>
            <span class="label">Dringend</span>
          </div>
          <div class="reminder-total">
            <span class="count">{{ stats.reminders.total || 0 }}</span>
            <span class="label">Gesamt</span>
          </div>
        </div>
      </div>

      <!-- Kunden -->
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-value">{{ stats.customers?.active || 0 }}</div>
        <div class="stat-label">Aktive Kunden</div>
      </div>

      <!-- ZÃ¤hler -->
      <div class="stat-card">
        <div class="stat-icon">âš¡</div>
        <div class="meter-values">
          <div class="meter-free">
            <span class="count">{{ stats.meters?.free || 0 }}</span>
            <span class="label">Frei</span>
          </div>
          <div class="meter-occupied">
            <span class="count">{{ stats.meters?.occupied || 0 }}</span>
            <span class="label">Belegt</span>
          </div>
        </div>
      </div>

      <!-- VertrÃ¤ge -->
      <div class="stat-card">
        <div class="stat-icon">ğŸ“„</div>
        <div class="meter-values">
          <div class="meter-free">
            <span class="count">{{ stats.contracts?.active || 0 }}</span>
            <span class="label">Aktiv</span>
          </div>
          <div class="meter-occupied">
            <span class="count">{{ stats.contracts?.total || 0 }}</span>
            <span class="label">Gesamt</span>
          </div>
        </div>
      </div>

      <!-- Neue Kunden -->
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘¤+</div>
        <div class="stat-value">{{ stats.newCustomers?.count || 0 }}</div>
        <div class="stat-label">Neue Kunden</div>
      </div>

      <!-- ZÃ¤hlerablesungen -->
      <div class="stat-card">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="meter-values">
          <div class="meter-free">
            <span class="count">{{ stats.meterReadings?.recentReadings || 0 }}</span>
            <span class="label">Aktuell</span>
          </div>
          <div class="meter-occupied">
            <span class="count">{{ stats.meterReadings?.pendingReadings || 0 }}</span>
            <span class="label">Ausstehend</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Auslaufende VertrÃ¤ge -->
    <div class="section-card" *ngIf="stats?.expiringContracts && stats.expiringContracts.length > 0">
      <h2>ğŸ“‹ Bald auslaufende VertrÃ¤ge</h2>
      <div class="contracts-list">
        <div *ngFor="let contract of stats.expiringContracts" class="contract-card">
          <div class="contract-number">{{ contract.contractNumber }}</div>
          <strong>{{ contract.customerId.firstName }} {{ contract.customerId.lastName }}</strong>
          <div class="supplier">{{ contract.supplierId.name }}</div>
          <div class="contract-footer">
            <div class="end-date">{{ contract.endDate | date:'dd.MM.yyyy' }}</div>
            <span class="badge" [class.badge-danger]="getDaysRemaining(contract.endDate) <= 30">
              {{ getDaysRemaining(contract.endDate) }} Tage
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- VertrÃ¤ge nach Anbieter -->
    <div class="section-card" *ngIf="stats?.contractsBySupplier">
      <h2>ğŸ“Š VertrÃ¤ge nach Anbieter</h2>
      <div class="chart-container">
        <div *ngFor="let item of stats.contractsBySupplier" class="chart-bar">
          <div class="bar-label">{{ item.name }}</div>
          <div class="bar-wrapper">
            <div class="bar" [style.width.%]="getPercentage(item.count)"></div>
            <span class="bar-value">{{ item.count }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Monatliche Trends Chart -->
    <div class="section-card" *ngIf="chartData">
      <div class="trends-header">
        <h2>ğŸ“ˆ Monatliche Entwicklung</h2>
        <select [(ngModel)]="chartMonths" (change)="onChartMonthsChange()" class="months-select">
          <option [value]="3">3 Monate</option>
          <option [value]="6">6 Monate</option>
          <option [value]="12">12 Monate</option>
        </select>
      </div>

      <!-- Legende -->
      <div class="chart-legend">
        <div class="legend-item">
          <span class="legend-color contracts"></span>
          <span>VertrÃ¤ge</span>
        </div>
        <div class="legend-item">
          <span class="legend-color customers"></span>
          <span>Kunden</span>
        </div>
        <div class="legend-item">
          <span class="legend-color meters"></span>
          <span>ZÃ¤hler</span>
        </div>
      </div>

      <!-- Chart -->
      <div class="bar-chart">
        <div *ngFor="let label of chartData.labels; let i = index" class="chart-column">
          <div class="bars-group">
            <div class="vertical-bar contracts"
                 [style.height.%]="getBarHeight(chartData.contracts[i])"
                 [title]="'VertrÃ¤ge: ' + chartData.contracts[i]">
              <span *ngIf="chartData.contracts[i] > 0" class="bar-value-top">{{ chartData.contracts[i] }}</span>
            </div>
            <div class="vertical-bar customers"
                 [style.height.%]="getBarHeight(chartData.customers[i])"
                 [title]="'Kunden: ' + chartData.customers[i]">
              <span *ngIf="chartData.customers[i] > 0" class="bar-value-top">{{ chartData.customers[i] }}</span>
            </div>
            <div class="vertical-bar meters"
                 [style.height.%]="getBarHeight(chartData.meters[i])"
                 [title]="'ZÃ¤hler: ' + chartData.meters[i]">
              <span *ngIf="chartData.meters[i] > 0" class="bar-value-top">{{ chartData.meters[i] }}</span>
            </div>
          </div>
          <div class="chart-label">{{ label }}</div>
        </div>
      </div>
    </div>

  </div>

</div>
