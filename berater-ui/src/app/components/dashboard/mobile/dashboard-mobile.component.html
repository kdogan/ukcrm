<div class="mobile-page">

  <!-- HEADER -->
  <div class="mobile-header">
    <h1>Dashboard</h1>
  </div>

  <!-- SUPERADMIN VIEW - Hinweis zur Desktop-Version -->
  @if(isSuperAdmin){
    <div class="mobile-content">
      <div class="section-card">
        <div class="no-data" style="text-align: center; padding: 2rem;">
          <i class="fas fa-desktop" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
          <p>Die Superadmin-Ansicht ist fÃ¼r Desktop optimiert.</p>
          <p>Bitte verwenden Sie ein grÃ¶ÃŸeres GerÃ¤t fÃ¼r die volle FunktionalitÃ¤t.</p>
        </div>
      </div>
    </div>
  }

  <!-- BERATER/ADMIN VIEW -->
  @if(!isSuperAdmin){
    <div class="mobile-content">

      <!-- Subscription Expiration Warning -->
       @if(shouldShowSubscriptionWarning()){
        <div class="subscription-warning-banner"
            [class.warning-expired]="subscriptionWarningLevel === 'expired'"
            [class.warning-danger]="subscriptionWarningLevel === 'danger'"
            [class.warning-warning]="subscriptionWarningLevel === 'warning'"
            [class.warning-info]="subscriptionWarningLevel === 'info'">
          <div class="warning-icon">
            <i class="fas"
              [class.fa-exclamation-triangle]="subscriptionWarningLevel === 'expired' || subscriptionWarningLevel === 'danger'"
              [class.fa-info-circle]="subscriptionWarningLevel === 'warning' || subscriptionWarningLevel === 'info'"></i>
          </div>
          <div class="warning-content">
            <div class="warning-title">
              <span *ngIf="subscriptionWarningLevel === 'expired'">Paket abgelaufen</span>
              <span *ngIf="subscriptionWarningLevel === 'danger'">Paket lÃ¤uft bald ab!</span>
              <span *ngIf="subscriptionWarningLevel === 'warning'">Paket-Erinnerung</span>
              <span *ngIf="subscriptionWarningLevel === 'info'">Paket-Information</span>
            </div>
            <div class="warning-message">{{ subscriptionWarningMessage }}</div>
            <div class="warning-action">
              <a routerLink="/settings" class="btn-renew">Paket verlÃ¤ngern</a>
            </div>
          </div>
        </div>
      }
      <!-- FAVORIT-STATISTIKEN (oben) -->
       @if(stats && getFavoriteStatCards().length > 0){
        <div class="favorites-section">
          <h2>â­ Favoriten</h2>
          <div class="stats-cards">
            <!-- Erinnerungen -->
            <div class="stat-card priority-high clickable" *ngIf="isFavorite('reminders') && stats.reminders" routerLink="/todos">
              <div class="stat-icon">ğŸ””</div>
              <div class="reminder-values">
                <div class="reminder-urgent">
                  <span class="count">{{ stats.reminders.urgent || 0 }}</span>
                  <span class="label">Dringend</span>
                </div>
                <div class="reminder-total">
                  <span class="count">{{ stats.reminders.total || 0 }}</span>
                  <span class="label">Gesamt</span>
                </div>
              </div>
            </div>

            <!-- VertrÃ¤ge -->
            <div class="stat-card" *ngIf="isFavorite('contracts')">
              <div class="stat-icon">ğŸ“„</div>
              <div class="meter-values">
                <div class="meter-free">
                  <span class="count">{{ stats.contracts?.active || 0 }}</span>
                  <span class="label">Aktiv</span>
                </div>
                <div class="meter-occupied">
                  <span class="count">{{ stats.contracts?.total || 0 }}</span>
                  <span class="label">Gesamt</span>
                </div>
              </div>
            </div>

            <!-- ZÃ¤hlerablesungen -->
            <div class="stat-card clickable" *ngIf="isFavorite('recentReadings')" routerLink="/meters">
              <div class="stat-icon">ğŸ“Š</div>
              <div class="meter-values">
                <div class="meter-free">
                  <span class="count">{{ stats.recentContractsReadings?.withReadings || 0 }}/{{ stats.recentContractsReadings?.totalContracts || 0 }}</span>
                  <span class="label">Mit Ablesung</span>
                </div>
                <div class="meter-occupied" [class.text-warning]="stats.recentContractsReadings?.withoutReadings > 0">
                  <span class="count">{{ stats.recentContractsReadings?.withoutReadings || 0 }}</span>
                  <span class="label">Ohne Ablesung</span>
                </div>
              </div>
            </div>

            <!-- Kunden -->
            <div class="stat-card" *ngIf="isFavorite('customers')">
              <div class="stat-icon">ğŸ‘¥</div>
              <div class="stat-value">{{ stats.customers?.active || 0 }}</div>
              <div class="stat-label">Aktive Kunden</div>
            </div>

            <!-- ZÃ¤hler -->
            <div class="stat-card" *ngIf="isFavorite('meters')">
              <div class="stat-icon">âš¡</div>
              <div class="meter-values">
                <div class="meter-free">
                  <span class="count">{{ stats.meters?.free || 0 }}</span>
                  <span class="label">Frei</span>
                </div>
                <div class="meter-occupied">
                  <span class="count">{{ stats.meters?.occupied || 0 }}</span>
                  <span class="label">Belegt</span>
                </div>
              </div>
            </div>

            <!-- Neue Kunden -->
            <div class="stat-card" *ngIf="isFavorite('newCustomers')">
              <div class="stat-icon">ğŸ‘¤+</div>
              <div class="stat-value">{{ stats.newCustomers?.count || 0 }}</div>
              <div class="stat-label">Neue Kunden</div>
            </div>

            <!-- ÃœberfÃ¤llige VertrÃ¤ge -->
            <div class="stat-card warning-card" *ngIf="isFavorite('overdueContracts') && stats.overdueContracts"
                [class.priority-high]="stats.overdueContracts.count > 0">
              <div class="stat-icon">âš ï¸</div>
              <div class="stat-value warning-text">{{ stats.overdueContracts.count || 0 }}</div>
              <div class="stat-label">ÃœberfÃ¤llige VertrÃ¤ge</div>
            </div>
          </div>
        </div>
      }
      <!-- ÃœberfÃ¤llige VertrÃ¤ge Liste -->
       @if(stats?.overdueContracts?.list?.length > 0){
        <div class="section-card overdue-section">
          <h2>âš ï¸ ÃœberfÃ¤llige VertrÃ¤ge</h2>
          <div class="contracts-list">
            <div *ngFor="let contract of stats.overdueContracts.list" class="contract-card overdue">
              <div class="contract-number">{{ contract.contractNumber }}</div>
              <strong>{{ contract.customerId?.firstName }} {{ contract.customerId?.lastName }}</strong>
              <div class="supplier">{{ contract.supplierId?.shortName || contract.supplierId?.name }}</div>
              <div class="contract-footer">
                <div class="end-date">{{ contract.endDate | date:'dd.MM.yyyy' }}</div>
                <span class="badge badge-danger">
                  {{ getDaysOverdue(contract.endDate) }} Tage Ã¼berfÃ¤llig
                </span>
              </div>
            </div>
          </div>
        </div>
      }

      <!-- Auslaufende VertrÃ¤ge -->
       @if(stats?.expiringContracts && stats.expiringContracts.length > 0){
        <div class="section-card">
          <h2>ğŸ“‹ Bald auslaufende VertrÃ¤ge</h2>
          <div class="contracts-list">
            @for(contract of stats.expiringContracts; track contract){
              <div class="contract-card">
                <div class="contract-number">{{ contract.contractNumber }}</div>
                <strong>{{ contract.customerId.firstName }} {{ contract.customerId.lastName }}</strong>
                <div class="supplier">{{ contract.supplierId.name }}</div>
                <div class="contract-footer">
                  <div class="end-date">{{ contract.endDate | date:'dd.MM.yyyy' }}</div>
                  <span class="badge" [class.badge-danger]="getDaysRemaining(contract.endDate) <= 30">
                    {{ getDaysRemaining(contract.endDate) }} Tage
                  </span>
                </div>
              </div>
            }
          </div>
        </div>
      }
      <!-- VertrÃ¤ge nach Anbieter -->
      <div class="section-card" *ngIf="stats?.contractsBySupplier">
        <h2>ğŸ“Š VertrÃ¤ge nach Anbieter</h2>
        <div class="supplier-stats-container">
          <!-- Kreisdiagramm -->
          <div class="pie-chart-wrapper">
            <div class="pie-chart" [style.background]="getPieChartGradient()">
              <div class="pie-chart-center">
                <span class="pie-total">{{ getTotalSupplierContracts() }}</span>
                <span class="pie-label">Gesamt</span>
              </div>
            </div>
          </div>
          <!-- Legende -->
          <div class="supplier-legend">
            <div *ngFor="let item of stats.contractsBySupplier; let i = index" class="supplier-row">
              <span class="color-dot" [style.background]="getSupplierColor(i)"></span>
              <span class="supplier-name">{{ item.shortName || item.name }}</span>
              <span class="supplier-count">{{ item.count }}</span>
              <span class="supplier-percent">{{ getSupplierPercentage(item.count) }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Monatliche Trends Chart -->
      <div class="section-card" *ngIf="chartData">
        <div class="trends-header">
          <h2>ğŸ“ˆ Monatliche Entwicklung</h2>
          <select [(ngModel)]="chartMonths" (change)="onChartMonthsChange()" class="months-select">
            <option [value]="3">3 Monate</option>
            <option [value]="6">6 Monate</option>
            <option [value]="12">12 Monate</option>
          </select>
        </div>

        <!-- Legende -->
        <div class="chart-legend">
          <div class="legend-item">
            <span class="legend-color contracts"></span>
            <span>VertrÃ¤ge</span>
          </div>
          <div class="legend-item">
            <span class="legend-color customers"></span>
            <span>Kunden</span>
          </div>
          <div class="legend-item">
            <span class="legend-color meters"></span>
            <span>ZÃ¤hler</span>
          </div>
        </div>

        <!-- Chart -->
        <div class="bar-chart">
          @for(label of chartData.labels; track $index){
            <div class="chart-column">
              <div class="bars-group">
                <div class="vertical-bar contracts"
                    [style.height.%]="getBarHeight(chartData.contracts[$index])"
                    [title]="'VertrÃ¤ge: ' + chartData.contracts[$index]">
                  @if(chartData.contracts[$index] > 0){
                    <span class="bar-value-top">{{ chartData.contracts[$index] }}</span>
                  }
                </div>
                <div class="vertical-bar customers"
                    [style.height.%]="getBarHeight(chartData.customers[$index])"
                    [title]="'Kunden: ' + chartData.customers[$index]">
                  @if(chartData.customers[$index] > 0){
                    <span class="bar-value-top">{{ chartData.customers[$index] }}</span>
                  }
                </div>
                <div class="vertical-bar meters"
                    [style.height.%]="getBarHeight(chartData.meters[$index])"
                    [title]="'ZÃ¤hler: ' + chartData.meters[$index]">
                  @if(chartData.meters[$index] > 0){
                    <span class="bar-value-top">{{ chartData.meters[$index] }}</span>
                  }
                </div>
              </div>
              <div class="chart-label">{{ label }}</div>
            </div>
          }
        </div>
      </div>

      <!-- ALLE STATISTIKEN (unten, mit Favoriten-Toggle) -->
      @if(stats){
        <div class="all-stats-section">
          <div class="section-header-toggle" (click)="showAllStats = !showAllStats">
            <h2>ğŸ“Š Alle Statistiken</h2>
            <span class="toggle-icon">{{ showAllStats ? 'â–²' : 'â–¼' }}</span>
          </div>

          <div class="accordion-content" [class.open]="showAllStats">
            <p class="stats-hint">Tippen Sie auf den Stern, um Statistiken zu Ihren Favoriten hinzuzufÃ¼gen oder zu entfernen.</p>
            <div class="stats-cards">
              <!-- Erinnerungen -->
               @if(stats.reminders){
                <div class="stat-card" [class.is-favorite]="isFavorite('reminders')">
                <button class="favorite-toggle" (click)="toggleFavorite('reminders', $event)">
                  {{ isFavorite('reminders') ? 'â˜…' : 'â˜†' }}
                </button>
                <div class="stat-icon">ğŸ””</div>
                <div class="reminder-values">
                  <div class="reminder-urgent">
                    <span class="count">{{ stats.reminders.urgent || 0 }}</span>
                    <span class="label">Dringend</span>
                  </div>
                  <div class="reminder-total">
                    <span class="count">{{ stats.reminders.total || 0 }}</span>
                    <span class="label">Gesamt</span>
                  </div>
                </div>
                </div>
              }

              <!-- VertrÃ¤ge -->
              <div class="stat-card" [class.is-favorite]="isFavorite('contracts')">
                <button class="favorite-toggle" (click)="toggleFavorite('contracts', $event)">
                  {{ isFavorite('contracts') ? 'â˜…' : 'â˜†' }}
                </button>
                <div class="stat-icon">ğŸ“„</div>
                <div class="meter-values">
                  <div class="meter-free">
                    <span class="count">{{ stats.contracts?.active || 0 }}</span>
                    <span class="label">Aktiv</span>
                  </div>
                  <div class="meter-occupied">
                    <span class="count">{{ stats.contracts?.total || 0 }}</span>
                    <span class="label">Gesamt</span>
                  </div>
                </div>
              </div>

              <!-- ZÃ¤hlerablesungen -->
              <div class="stat-card" [class.is-favorite]="isFavorite('recentReadings')">
                <button class="favorite-toggle" (click)="toggleFavorite('recentReadings', $event)">
                  {{ isFavorite('recentReadings') ? 'â˜…' : 'â˜†' }}
                </button>
                <div class="stat-icon">ğŸ“Š</div>
                <div class="meter-values">
                  <div class="meter-free">
                    <span class="count">{{ stats.recentContractsReadings?.withReadings || 0 }}/{{ stats.recentContractsReadings?.totalContracts || 0 }}</span>
                    <span class="label">Mit Ablesung</span>
                  </div>
                  <div class="meter-occupied" [class.text-warning]="stats.recentContractsReadings?.withoutReadings > 0">
                    <span class="count">{{ stats.recentContractsReadings?.withoutReadings || 0 }}</span>
                    <span class="label">Ohne Ablesung</span>
                  </div>
                </div>
              </div>

              <!-- Kunden -->
              <div class="stat-card" [class.is-favorite]="isFavorite('customers')">
                <button class="favorite-toggle" (click)="toggleFavorite('customers', $event)">
                  {{ isFavorite('customers') ? 'â˜…' : 'â˜†' }}
                </button>
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-value">{{ stats.customers?.active || 0 }}</div>
                <div class="stat-label">Aktive Kunden</div>
              </div>

              <!-- ZÃ¤hler -->
              <div class="stat-card" [class.is-favorite]="isFavorite('meters')">
                <button class="favorite-toggle" (click)="toggleFavorite('meters', $event)">
                  {{ isFavorite('meters') ? 'â˜…' : 'â˜†' }}
                </button>
                <div class="stat-icon">âš¡</div>
                <div class="meter-values">
                  <div class="meter-free">
                    <span class="count">{{ stats.meters?.free || 0 }}</span>
                    <span class="label">Frei</span>
                  </div>
                  <div class="meter-occupied">
                    <span class="count">{{ stats.meters?.occupied || 0 }}</span>
                    <span class="label">Belegt</span>
                  </div>
                </div>
              </div>

              <!-- Neue Kunden -->
              <div class="stat-card" [class.is-favorite]="isFavorite('newCustomers')">
                <button class="favorite-toggle" (click)="toggleFavorite('newCustomers', $event)">
                  {{ isFavorite('newCustomers') ? 'â˜…' : 'â˜†' }}
                </button>
                <div class="stat-icon">ğŸ‘¤+</div>
                <div class="stat-value">{{ stats.newCustomers?.count || 0 }}</div>
                <div class="stat-label">Neue Kunden</div>
              </div>

              <!-- ÃœberfÃ¤llige VertrÃ¤ge -->
              <div class="stat-card warning-card" *ngIf="stats.overdueContracts"
                  [class.is-favorite]="isFavorite('overdueContracts')"
                  [class.priority-high]="stats.overdueContracts.count > 0">
                <button class="favorite-toggle" (click)="toggleFavorite('overdueContracts', $event)">
                  {{ isFavorite('overdueContracts') ? 'â˜…' : 'â˜†' }}
                </button>
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-value warning-text">{{ stats.overdueContracts.count || 0 }}</div>
                <div class="stat-label">ÃœberfÃ¤llige VertrÃ¤ge</div>
              </div>
            </div>

            <!-- VertrÃ¤ge nach Anbieter -->
            <div class="section-card" *ngIf="stats?.contractsBySupplier">
              <h2>ğŸ“Š VertrÃ¤ge nach Anbieter</h2>
              <div class="supplier-stats-container">
                <!-- Kreisdiagramm -->
                <div class="pie-chart-wrapper">
                  <div class="pie-chart" [style.background]="getPieChartGradient()">
                    <div class="pie-chart-center">
                      <span class="pie-total">{{ getTotalSupplierContracts() }}</span>
                      <span class="pie-label">Gesamt</span>
                    </div>
                  </div>
                </div>
                <!-- Legende -->
                <div class="supplier-legend">
                  <div *ngFor="let item of stats.contractsBySupplier; let i = index" class="supplier-row">
                    <span class="color-dot" [style.background]="getSupplierColor(i)"></span>
                    <span class="supplier-name">{{ item.shortName || item.name }}</span>
                    <span class="supplier-count">{{ item.count }}</span>
                    <span class="supplier-percent">{{ getSupplierPercentage(item.count) }}%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>
