<div class="page-container">
  <div class="page-header">
    <h1>{{ 'SUPPORT.TITLE' | translate }}</h1>
    @if(!isSuperAdmin){
      <button class="btn-primary" (click)="showCreateTicketModal()">
        <i class="fas fa-plus"></i> {{ 'SUPPORT.NEW_TICKET' | translate }}
      </button>
    }
  </div>

  @if(!isSuperAdmin){
    <div class="info-box">
      <i class="fas fa-info-circle"></i>
      <div>
        <strong>{{ 'SUPPORT.WELCOME_TITLE' | translate }}</strong>
        <p>{{ 'SUPPORT.WELCOME_TEXT' | translate }}</p>
      </div>
    </div>
  }

  @if(isSuperAdmin){
    <div class="info-box admin">
      <i class="fas fa-user-shield"></i>
      {{ 'SUPPORT.ADMIN_VIEW' | translate }}
    </div>
  }

  <!-- Search and Filter Section -->
  <div class="filter-section">
    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text"
             [(ngModel)]="searchQuery"
             (ngModelChange)="onSearchChange()"
             [placeholder]="'SUPPORT.SEARCH_PLACEHOLDER' | translate">
      @if(searchQuery){
        <button class="clear-search" (click)="searchQuery = ''; onSearchChange()">
          <i class="fas fa-times"></i>
        </button>
      }
    </div>

    <div class="filters-row">
      <div class="filter-group">
        <label>{{ 'COMMON.STATUS' | translate }}</label>
        <select [(ngModel)]="filterStatus" (ngModelChange)="onFilterChange()">
          <option value="all">{{ 'TODOS.ALL_OPEN' | translate }}</option>
          <option value="open">{{ 'SUPPORT.STATUS.OPEN' | translate }}</option>
          <option value="in_progress">{{ 'SUPPORT.STATUS.IN_PROGRESS' | translate }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>{{ 'TODOS.FIELDS.PRIORITY' | translate }}</label>
        <select [(ngModel)]="filterPriority" (ngModelChange)="onFilterChange()">
          <option value="all">{{ 'COMMON.ALL' | translate }}</option>
          <option value="high">{{ 'SUPPORT.PRIORITY.HIGH' | translate }}</option>
          <option value="medium">{{ 'SUPPORT.PRIORITY.MEDIUM' | translate }}</option>
          <option value="low">{{ 'SUPPORT.PRIORITY.LOW' | translate }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>{{ 'SUPPORT.FILTER_ANSWER' | translate }}</label>
        <select [(ngModel)]="filterAnswered" (ngModelChange)="onFilterChange()">
          <option value="all">{{ 'COMMON.ALL' | translate }}</option>
          <option value="answered">{{ 'SUPPORT.ANSWERED' | translate }}</option>
          <option value="unanswered">{{ 'SUPPORT.UNANSWERED' | translate }}</option>
        </select>
      </div>

      <div class="filter-group">
        <div class="checkbox-wrapper">
            <input type="checkbox" 
                   [(ngModel)]="showCompleted" 
                   (ngModelChange)="onFilterChange()" 
                   class="checkbox-input" id="showCompleted">
            <label for="showCompleted" class="checkbox-label">{{ 'SUPPORT.SHOW_COMPLETED' | translate }}</label>
          </div>
      </div>

      <button class="btn-reset" (click)="resetFilters()" [title]="'TODOS.RESET_FILTERS' | translate">
        <i class="fas fa-redo"></i>
      </button>
    </div>

    <div class="results-info">
      <span>{{ filteredTickets.length }} {{ 'SUPPORT.TICKETS_COUNT' | translate }} {{ tickets.length }} {{ 'SUPPORT.TICKETS' | translate }}</span>
    </div>
  </div>

  <div class="tickets-grid">
    @for(ticket of filteredTickets; track ticket._id){
      <div class="ticket-card" (click)="viewTicket(ticket)">
        <div class="ticket-header">
          <div class="ticket-title">
            <i class="fas fa-ticket-alt"></i>
            {{ ticket.title }}
          </div>
          <span class="badge"
                [class.badge-high]="ticket.priority === 'high'"
                [class.badge-medium]="ticket.priority === 'medium'"
                [class.badge-low]="ticket.priority === 'low'">
            {{ getPriorityLabel(ticket.priority) }}
          </span>
        </div>

        <p class="ticket-description">{{ ticket.description }}</p>

        @if(isSuperAdmin && typeof ticket.beraterId === 'object'){
          <div class="ticket-berater">
            <i class="fas fa-user"></i>
            {{ 'SUPPORT.FROM' | translate }}: {{ getBeraterName(ticket) }}
          </div>
        }

        <div class="ticket-footer">
          <span class="ticket-status"
                [class.status-open]="ticket.status === 'open'"
                [class.status-progress]="ticket.status === 'in_progress'"
                [class.status-completed]="ticket.status === 'completed'">
            {{ getStatusLabel(ticket.status) }}
          </span>

          @if(ticket.ticketImages && ticket.ticketImages.length > 0){
            <span class="ticket-images-count">
              <i class="fas fa-image"></i> {{ ticket.ticketImages.length }}
            </span>
          }

          @if(ticket.beraterResponse || ticket.adminResponse){
            <span class="ticket-has-response">
              <i class="fas fa-reply"></i>
              @if(ticket.beraterResponse && ticket.adminResponse){
                {{ 'SUPPORT.ANSWERED' | translate }}
              }@else if(ticket.adminResponse){
                {{ 'SUPPORT.SUPPORT_RESPONSE' | translate }}
              }@else{
                {{ 'SUPPORT.YOUR_RESPONSE' | translate }}
              }
            </span>
          }

          <span class="ticket-date">{{ ticket.createdAt | date:'dd.MM.yyyy HH:mm' }}</span>
        </div>
      </div>
    }@empty{
      <div class="no-data">
        @if(searchQuery || filterStatus !== 'all' || filterPriority !== 'all' || filterAnswered !== 'all' || showCompleted){
          <i class="fas fa-search"></i>
          <p>{{ 'SUPPORT.NO_TICKETS_MATCH' | translate }}</p>
          <button class="btn-secondary" (click)="resetFilters()">{{ 'TODOS.RESET_FILTERS' | translate }}</button>
        }@else{
          @if(isSuperAdmin){
            {{ 'SUPPORT.NO_TICKETS_ADMIN' | translate }}
          }@else{
            {{ 'SUPPORT.NO_TICKETS_USER' | translate }}
          }
        }
      </div>
    }
  </div>
</div>

<!-- Create Ticket Modal -->
@if(showCreateModal){
  <div class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ 'SUPPORT.CREATE_TICKET_TITLE' | translate }}</h2>
        <button class="btn-close" (click)="closeCreateModal()">&times;</button>
      </div>

      <form (ngSubmit)="createTicket()">
        <div class="form-group">
          <label>{{ 'SUPPORT.TITLE_LABEL' | translate }}*</label>
          <input type="text" [(ngModel)]="newTicket.title" name="title" required
                 [placeholder]="'SUPPORT.TITLE_PLACEHOLDER' | translate">
        </div>

        <div class="form-group">
          <label>{{ 'SUPPORT.DESCRIPTION_LABEL' | translate }}*</label>
          <textarea [(ngModel)]="newTicket.description" name="description"
                    rows="6" required
                    [placeholder]="'SUPPORT.DESCRIPTION_PLACEHOLDER' | translate"></textarea>
        </div>

        <div class="form-group">
          <label>{{ 'TODOS.FIELDS.PRIORITY' | translate }}</label>
          <select [(ngModel)]="newTicket.priority" name="priority">
            <option value="low">{{ 'SUPPORT.PRIORITY.LOW' | translate }}</option>
            <option value="medium">{{ 'SUPPORT.PRIORITY.MEDIUM' | translate }}</option>
            <option value="high">{{ 'SUPPORT.PRIORITY.HIGH' | translate }}</option>
          </select>
        </div>

        <div class="form-group">
          <label>{{ 'SUPPORT.UPLOAD_IMAGES' | translate }}</label>
          <input type="file" accept="image/*" multiple (change)="onImageSelect($event)"
                 #fileInput>
          <small>{{ 'SUPPORT.IMAGE_HINT' | translate }}</small>
        </div>

        @if(imagePreviews.length > 0){
          <div class="image-previews">
            @for(preview of imagePreviews; track $index){
              <div class="image-preview">
                <img [src]="preview" alt="Preview">
                <button type="button" class="remove-image" (click)="removeImage($index)">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            }
          </div>
        }

        <div class="modal-footer">
          <button type="button" class="btn-secondary" (click)="closeCreateModal()">{{ 'COMMON.CANCEL' | translate }}</button>
          <button type="submit" class="btn-primary">{{ 'SUPPORT.CREATE_TICKET' | translate }}</button>
        </div>
      </form>
    </div>
  </div>
}

<!-- View Ticket Modal -->
@if(showViewModal && selectedTicket){
  <div class="modal-overlay" (click)="closeViewModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ selectedTicket.title }}</h2>
        <button class="btn-close" (click)="closeViewModal()">&times;</button>
      </div>

      <div class="ticket-details">
        <div class="detail-row">
          <strong>{{ 'COMMON.STATUS' | translate }}:</strong>
          <span class="ticket-status"
                [class.status-open]="selectedTicket.status === 'open'"
                [class.status-progress]="selectedTicket.status === 'in_progress'"
                [class.status-completed]="selectedTicket.status === 'completed'">
            {{ getStatusLabel(selectedTicket.status) }}
          </span>
        </div>

        <div class="detail-row">
          <strong>{{ 'TODOS.FIELDS.PRIORITY' | translate }}:</strong>
          <span class="badge"
                [class.badge-high]="selectedTicket.priority === 'high'"
                [class.badge-medium]="selectedTicket.priority === 'medium'"
                [class.badge-low]="selectedTicket.priority === 'low'">
            {{ getPriorityLabel(selectedTicket.priority) }}
          </span>
        </div>

        @if(isSuperAdmin){
          <div class="detail-row">
            <strong>{{ 'SUPPORT.FROM' | translate }}:</strong>
            {{ getBeraterName(selectedTicket) }}
          </div>
        }

        <div class="detail-row">
          <strong>{{ 'SUPPORT.CREATED_AT' | translate }}:</strong>
          {{ selectedTicket.createdAt | date:'dd.MM.yyyy HH:mm' }}
        </div>

        <div class="detail-section">
          <strong>{{ 'SUPPORT.DESCRIPTION_LABEL' | translate }}:</strong>
          <p class="ticket-description-full">{{ selectedTicket.description }}</p>
        </div>

        @if(selectedTicket.ticketImages && selectedTicket.ticketImages.length > 0){
          <div class="detail-section">
            <strong>{{ 'SUPPORT.ATTACHED_IMAGES' | translate }}:</strong>
            <div class="ticket-images">
              @for(image of selectedTicket.ticketImages; track image.filename){
                <div class="ticket-image" (click)="openImageViewer(getImageUrl(selectedTicket._id, image.filename))">
                  <img [src]="getImageUrl(selectedTicket._id, image.filename)"
                       [alt]="image.originalName">
                  <span class="image-name">{{ image.originalName }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Chronological Conversation -->
        @if(selectedTicket.conversation && selectedTicket.conversation.length > 0){
          <div class="detail-section conversation-section">
            <strong>
              <i class="fas fa-comments"></i> {{ 'SUPPORT.CONVERSATION' | translate }}:
            </strong>
            <div class="conversation-list">
              @for(msg of getSortedConversation(); track $index){
                <div class="conversation-message" [class.berater-message]="msg.senderType === 'berater'" [class.admin-message]="msg.senderType === 'admin'">
                  <div class="message-header">
                    <span class="sender-name">
                      @if(msg.senderType === 'admin'){
                        <i class="fas fa-user-shield"></i>
                      }@else{
                        <i class="fas fa-user"></i>
                      }
                      {{ msg.senderName || (msg.senderType === 'admin' ? 'Support' : 'Berater') }}
                    </span>
                    <span class="message-time">{{ msg.createdAt | date:'dd.MM.yyyy HH:mm' }}</span>
                  </div>
                  <p class="message-content">{{ msg.message }}</p>
                </div>
              }
            </div>
          </div>
        }@else{
          <!-- Fallback: Legacy fields for old tickets without conversation array -->
          @if(selectedTicket.beraterResponse){
            <div class="detail-section berater-response">
              <strong>
                <i class="fas fa-comment"></i> {{ 'SUPPORT.YOUR_ANSWER' | translate }}:
              </strong>
              <p>{{ selectedTicket.beraterResponse }}</p>
              <small>
                {{ 'SUPPORT.ADDED_AT' | translate }} {{ selectedTicket.beraterResponseAt | date:'dd.MM.yyyy HH:mm' }}
              </small>
            </div>
          }

          @if(selectedTicket.adminResponse){
            <div class="detail-section admin-response">
              <strong>
                <i class="fas fa-reply"></i> {{ 'SUPPORT.SUPPORT_ANSWER' | translate }}:
              </strong>
              <p>{{ selectedTicket.adminResponse }}</p>
              <small>
                {{ 'SUPPORT.ANSWERED_AT' | translate }} {{ selectedTicket.adminResponseAt | date:'dd.MM.yyyy HH:mm' }}
                @if(selectedTicket.respondedBy){
                  {{ 'SUPPORT.BY' | translate }} {{ selectedTicket.respondedBy.firstName }} {{ selectedTicket.respondedBy.lastName }}
                }
              </small>
            </div>
          }
        }

        @if(!isSuperAdmin && selectedTicket.status !== 'completed'){
          <div class="detail-section">
            <strong>{{ 'SUPPORT.ADD_MESSAGE' | translate }}:</strong>
            <textarea [(ngModel)]="beraterResponse"
                      rows="4"
                      [placeholder]="'SUPPORT.ADD_MESSAGE_PLACEHOLDER' | translate"></textarea>

            <div class="form-group">
              <label>{{ 'SUPPORT.CHANGE_STATUS' | translate }}:</label>
              <select [(ngModel)]="responseStatus">
                <option value="open">{{ 'SUPPORT.STATUS.OPEN' | translate }}</option>
                <option value="in_progress">{{ 'SUPPORT.STATUS.IN_PROGRESS' | translate }}</option>
                <option value="completed">{{ 'SUPPORT.STATUS.COMPLETED' | translate }}</option>
              </select>
            </div>

            <button class="btn-primary" (click)="submitResponse()">
              <i class="fas fa-paper-plane"></i>
              {{ 'SUPPORT.SEND_MESSAGE' | translate }}
            </button>
          </div>
        }

        @if(isSuperAdmin){
          <div class="detail-section">
            <strong>{{ 'SUPPORT.ADD_MESSAGE' | translate }}:</strong>
            <textarea [(ngModel)]="adminResponse"
                      rows="4"
                      [placeholder]="'SUPPORT.ADD_MESSAGE_PLACEHOLDER' | translate"></textarea>

            <div class="form-group">
              <label>{{ 'SUPPORT.CHANGE_STATUS' | translate }}:</label>
              <select [(ngModel)]="responseStatus">
                <option value="open">{{ 'SUPPORT.STATUS.OPEN' | translate }}</option>
                <option value="in_progress">{{ 'SUPPORT.STATUS.IN_PROGRESS' | translate }}</option>
                <option value="completed">{{ 'SUPPORT.STATUS.COMPLETED' | translate }}</option>
              </select>
            </div>

            <button class="btn-primary" (click)="submitResponse()">
              <i class="fas fa-paper-plane"></i>
              {{ 'SUPPORT.SEND_MESSAGE' | translate }}
            </button>
          </div>
        }
      </div>

      <div class="modal-footer">
        @if(!isSuperAdmin && selectedTicket.status !== 'completed'){
          <button type="button" class="btn-success" (click)="closeTicket()">
            <i class="fas fa-check-circle"></i> {{ 'SUPPORT.CLOSE_TICKET' | translate }}
          </button>
        }
        <button type="button" class="btn-secondary" (click)="closeViewModal()">{{ 'COMMON.CLOSE' | translate }}</button>
      </div>
    </div>
  </div>
}
