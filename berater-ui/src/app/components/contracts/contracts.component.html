
@if(viewportService.isMobile()){
  <app-contracts-mobile
    [contracts]="filteredContracts"
    [activeMenuId]="activeMenuId"
    (create)="showCreateModal()"
    (edit)="editContract($event)"
    (delete)="deleteContract($event)"
    (showDetails)="showContractDetails($event)"
    (statusFilterChange)="onStatusChange($event)"
    (daysFilterChange)="onDaysChange($event)"
    (searchChange)="onContractSearchChange($event)"
    (showCustomer)="showCustomerDetails($event)"
    (showMeter)="showMeterDetails($event)"
    (showSupplier)="showSupplierDetails($event)"
    (closeActionMenu)="closeActionMenu()"
    (toggleActionMenu)="activeMenuId = $event" 
/>
}@else{
  <app-contracts-desktop
    [contracts]="filteredContracts"
    [activeMenuId]="activeMenuId"
    [currentPage]="currentPage"
    [pageSize]="pageSize"
    [totalItems]="totalItems"
    [totalPages]="totalPages"
    (create)="showCreateModal()"
    (edit)="editContract($event)"
    (delete)="deleteContract($event)"
    (showDetails)="showContractDetails($event)"
    (statusFilterChange)="onStatusChange($event)"
    (daysFilterChange)="onDaysChange($event)"
    (searchChange)="onContractSearchChange($event)"
    (showCustomer)="showCustomerDetails($event)"
    (showMeter)="showMeterDetails($event)"
    (showSupplier)="showSupplierDetails($event)"
    (closeActionMenu)="closeActionMenu()"
    (toggleActionMenu)="activeMenuId = $event"
    (pageChange)="goToPage($event)"
    (pageSizeChange)="onPageSizeChange($event)"
/>
}


<!-- Modal for Create/Edit Contract -->
 @if(showModal){
  <app-overlay-modal (close)="closeModal()">
    <div class="modal-header">
      <h2>{{ isEditMode ? ('CONTRACTS.EDIT' | translate) : ('CONTRACTS.NEW' | translate) }}</h2>
      <button class="btn-close" (click)="closeModal()">&times;</button>
    </div>
    <form (ngSubmit)="saveContract()" #contractForm="ngForm">
      @if(isEditMode){
        <div class="form-group">
          <label>Id</label>
          <input type="text" class="form-control" [value]="currentContract.contractNumber" disabled />
        </div>
      }

      <div class="form-group">
        <label for="customerId">{{ 'CONTRACTS.FIELDS.CUSTOMER' | translate }} *</label>
        <app-customer-search
          [customers]="customers"
          [selectedCustomer]="selectedCustomer"
          [showAddButton]="true"
          (customerSelected)="onCustomerSelected($event)"
          (customerCleared)="onCustomerCleared()"
          (addNew)="openCustomerCreationModal()"
        />
        <input type="hidden"
              id="customerId"
              name="customerId"
              [(ngModel)]="currentContract.customerId" required />
      </div>
        <div class="form-group">
          <div class="checkbox-wrapper">
            <input
              type="checkbox"
              id="isCommercial"
              name="isCommercial"
              [(ngModel)]="currentContract.isCommercial"
              class="checkbox-input" />
            <label for="isCommercial" class="checkbox-label">{{ 'CONTRACTS.FIELDS.IS_COMMERCIAL' | translate }}</label>
          </div>
      </div>

      @if(currentContract.isCommercial){
        <div class="form-group">
          <label for="commercialName">{{ 'CONTRACTS.FIELDS.COMMERCIAL_NAME' | translate }}</label>
          <input
            type="text"
            id="commercialName"
            name="commercialName"
            [(ngModel)]="currentContract.commercialName"
            [placeholder]="'CONTRACTS.FIELDS.COMMERCIAL_NAME' | translate"
            class="form-control" />
        </div>
      }

      <div class="form-group">
        <label for="meterId">{{ 'CONTRACTS.FIELDS.METER' | translate }} *</label>
        <app-meter-search
          [meters]="freeMeters"
          [selectedMeter]="selectedMeter"
          [showAddButton]="true"
          [showFreeStatus]="true"
          (meterSelected)="onMeterSelected($event)"
          (meterCleared)="onMeterCleared()"
          (addNew)="openMeterCreationModal()"
        />
        <input type="hidden" id="meterId" name="meterId" [(ngModel)]="currentContract.meterId" required />
      </div>

      <div class="form-group">
        <label for="supplierId">{{ 'CONTRACTS.FIELDS.SUPPLIER' | translate }} *</label>
        <app-supplier-search
          [suppliers]="suppliers"
          [selectedSupplier]="selectedSupplier"
          [showAddButton]="true"
          (supplierSelected)="onSupplierSelected($event)"
          (supplierCleared)="onSupplierCleared()"
          (addNew)="openSupplierCreationModal()"
        />
        <input type="hidden"
              id="supplierId"
              name="supplierId"
              [(ngModel)]="currentContract.supplierId" required />
      </div>
      <div class="form-group">
        <label>{{ 'CONTRACTS.FIELDS.CONTRACT_NUMBER' | translate }}</label>
        <input type="text" id="supplierContractNumber" name="supplierContractNumber" class="form-control" [(ngModel)]="currentContract.supplierContractNumber" />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="startDate">{{ 'CONTRACTS.FIELDS.START_DATE' | translate }} *</label>
          <input type="date" id="startDate" name="startDate" [(ngModel)]="currentContract.startDate" required
            class="form-control" />
        </div>

        <div class="form-group">
          <label for="durationMonths">{{ 'CONTRACTS.FIELDS.DURATION' | translate }} *</label>
          <input type="number" id="durationMonths" name="durationMonths" [(ngModel)]="currentContract.durationMonths"
            required min="1" max="120" placeholder="z.B. 24" class="form-control" />
        </div>
      </div>

      <div class="form-group">
        <label for="status">{{ 'COMMON.STATUS' | translate }}</label>
        <select id="status" name="status" [(ngModel)]="currentContract.status" class="form-control">
          @for(state of contractState; track state){
            <option [value]="state.key">{{state.value}}</option>
          }
        </select>
      </div>

      <!-- Datei-Uploads -->
      <div class="form-group" *ngIf="packageFeatureService.hasFileUpload() && (isEditMode || !isEditMode)">
        <label>{{ 'CONTRACTS.FIELDS.ATTACHMENTS' | translate }}</label>

        <!-- Upload-Button -->
        <div class="file-upload-section">
          <input type="file" #fileInput (change)="onFileSelected($event)" style="display: none"
                accept=".jpg,.jpeg,.png,.gif,.webp,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv" />
          <button type="button" class="btn-secondary btn-sm" (click)="fileInput.click()" [disabled]="uploadingFile">
            <i class="fas fa-upload"></i>
            {{ uploadingFile ? ('COMMON.LOADING' | translate) : ('COMMON.UPLOAD' | translate) }}
          </button>
          <small class="file-info">Max. 10MB | JPG, PNG, PDF, Word, Excel, TXT, CSV</small>
        </div>

        <!-- Liste der hochgeladenen Dateien (Edit-Modus) -->
        <div class="attachments-list" *ngIf="isEditMode && currentContract.attachments && currentContract.attachments.length > 0">
          <div class="attachment-item" *ngFor="let attachment of currentContract.attachments">
            <div class="attachment-icon" (click)="isImage(attachment.mimetype) ? viewImage(attachment) : null"
                [style.cursor]="isImage(attachment.mimetype) ? 'pointer' : 'default'"
                [title]="isImage(attachment.mimetype) ? 'Klicken zum Anzeigen' : ''">
              <i [class]="getFileIcon(attachment.mimetype)"></i>
            </div>
            <div class="attachment-info" (click)="isImage(attachment.mimetype) ? viewImage(attachment) : null"
                [style.cursor]="isImage(attachment.mimetype) ? 'pointer' : 'default'">
              <div class="attachment-name">{{ attachment.originalName }}</div>
              <div class="attachment-meta">
                {{ formatFileSize(attachment.size) }} â€¢ {{ formatDate(attachment.uploadedAt) }}
              </div>
            </div>
            <div class="attachment-actions">
              <button type="button" class="btn-icon" (click)="viewImage(attachment)" [title]="'COMMON.VIEW' | translate"
                      *ngIf="isImage(attachment.mimetype)">
                <i class="fas fa-eye"></i>
              </button>
              <button type="button" class="btn-icon" (click)="downloadAttachment(attachment)" [title]="'COMMON.DOWNLOAD' | translate">
                <i class="fas fa-download"></i>
              </button>
              <button type="button" class="btn-icon btn-danger" (click)="deleteAttachment(attachment)" [title]="'COMMON.DELETE' | translate">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Liste der noch nicht hochgeladenen Dateien (Create-Modus) -->
        <div class="attachments-list" *ngIf="!isEditMode && pendingFiles.length > 0">
          <div class="attachment-item" *ngFor="let file of pendingFiles">
            <div class="attachment-icon">
              <i [class]="getFileIcon(file.type)"></i>
            </div>
            <div class="attachment-info">
              <div class="attachment-name">{{ file.name }}</div>
              <div class="attachment-meta">
                {{ formatFileSize(file.size) }}
              </div>
            </div>
            <div class="attachment-actions">
              <button type="button" class="btn-icon btn-danger" (click)="deleteAttachment(file)" [title]="'COMMON.DELETE' | translate">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Info-Meldung wenn Feature nicht verfÃ¼gbar -->
      <div class="form-group" *ngIf="isEditMode && currentContract._id && !packageFeatureService.hasFileUpload()">
        <div class="feature-not-available">
          <i class="fas fa-lock"></i>
          <p>Datei-Upload ist in Ihrem aktuellen Paket ({{ packageFeatureService.getCurrentPackage() }}) nicht verfÃ¼gbar.</p>
          <p>Upgraden Sie auf ein hÃ¶heres Paket, um Dateien hochzuladen.</p>
        </div>
      </div>

      <div class="form-group">
        <label for="notes">{{ 'COMMON.NOTES' | translate }}</label>
        <textarea id="notes" name="notes" [(ngModel)]="currentContract.notes" rows="3"
          class="form-control"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeModal()" [disabled]="isSaving">{{ 'COMMON.CANCEL' | translate }}</button>
        <button type="submit" class="btn-primary" [disabled]="!contractForm.form.valid || !isFormValid() || isSaving">
          <i class="fas" [class.fa-spinner]="isSaving" [class.fa-spin]="isSaving" [class.fa-save]="!isSaving"></i>
          {{ isSaving ? ('COMMON.SAVING' | translate) : (isEditMode ? ('COMMON.SAVE' | translate) : ('COMMON.CREATE' | translate)) }}
        </button>
      </div>
    </form>
  </app-overlay-modal>
}
<!-- Customer Details Modal -->
@if(showCustomerDetailsModal){
  <app-overlay-modal (close)="closeCustomerDetails()">
    <div class="modal-header">
      <h2>{{ 'COMMON.DETAILS' | translate }}</h2>
      <button class="btn-close" (click)="closeCustomerDetails()">&times;</button>
    </div>
    <app-customer-detail
      [customer]="selectedCustomerDetails"
      [contracts]="customerContracts"
      [showContracts]="true"
      (contractClick)="onContractClick($event)"
    />
  </app-overlay-modal>
}

<!-- Supplier Details Modal -->
 @if(showSupplierDetailsModal){
  <app-overlay-modal (close)="closeSupplierDetails()">
    <div class="modal-header">
      <h2>Anbieterdetails</h2>
      <button class="btn-close" (click)="closeSupplierDetails()">&times;</button>
    </div>
    @if(selectedSupplierDetails){
      <div class="detail-content">
        <div class="detail-row">
          <span class="detail-label">Name:</span>
          <span class="detail-value">{{ selectedSupplierDetails.name }}</span>
        </div>
        @if(selectedSupplierDetails.address?.street || selectedSupplierDetails.address?.city){
        <div class="detail-row">
          <span class="detail-label">Adresse:</span>
          <span class="detail-value">
            @if(selectedSupplierDetails.address?.street){
              <span>{{ selectedSupplierDetails.address?.street }}<br></span>
            }
            @if(selectedSupplierDetails.address?.zipCode || selectedSupplierDetails.address?.city){
              <span>
                {{ selectedSupplierDetails.address?.zipCode }} {{ selectedSupplierDetails.address?.city }}
              </span>
            }
          </span>
        </div>
      }
      @if(selectedSupplierDetails.contactPhone){
        <div class="detail-row">
          <span class="detail-label">Telefon:</span>
          <span class="detail-value">
            {{ selectedSupplierDetails.contactPhone }}
            <a [href]="'tel:' + selectedSupplierDetails.contactPhone" class="phone-link" title="Anrufen">ðŸ“ž</a>
          </span>
        </div>
      }
      @if(selectedSupplierDetails.contactEmail){
        <div class="detail-row">
          <span class="detail-label">E-Mail:</span>
          <span class="detail-value">{{ selectedSupplierDetails.contactEmail }}</span>
        </div>
      }
      </div>
    }
  </app-overlay-modal>
}

<!-- Meter Details Modal -->
 @if(showMeterDetailsModal){
  <app-overlay-modal (close)="closeMeterDetails()">
    <div class="modal-header">
      <h2>{{ 'METERS.DETAILS' | translate }}</h2>
      <button class="btn-close" (click)="closeMeterDetails()">&times;</button>
    </div>
    <div class="modal-body">
      <app-meter-detail
        [meter]="selectedMeterDetails"
        [contracts]="[]"
        [showContracts]="false"
        (customerClick)="showCustomerDetails($event)">
      </app-meter-detail>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeMeterDetails()">{{ 'COMMON.CLOSE' | translate }}</button>
    </div>
  </app-overlay-modal>
}

<!-- Contract Details Modal -->
 @if(showContractDetailsModal){
  <app-overlay-modal (close)="closeContractDetails()">
    <div class="modal-header">
      <h2>{{'CONTRACTS.FIELDS.CONTRACT_DETAILS' | translate}}</h2>
      <button class="btn-close" (click)="closeContractDetails()">&times;</button>
    </div>
    @if(selectedContractDetails){
      <div class="detail-content">
        <div class="detail-row">
          <span class="detail-label">Id:</span>
          <span class="detail-value">{{ selectedContractDetails.contractNumber }}</span>
        </div>

        @if(selectedContractDetails.customerId){
          <div class="detail-row">
            <span class="detail-label">{{'CONTRACTS.FIELDS.CUSTOMER' | translate}}:</span>
            <span class="detail-value">{{ selectedContractDetails.customerId.fullName }}</span>
          </div>
        }
        @if(selectedContractDetails.meterId){
          <div class="detail-row">
            <span class="detail-label">{{'CONTRACTS.FIELDS.METER' | translate}}:</span>
            <span class="detail-value">
              {{ selectedContractDetails.meterId.meterNumber }}
              @if(selectedContractDetails.meterId.type){
                <span> ({{ getTypeLabel(selectedContractDetails.meterId.type) }})</span>
              }
            </span>
          </div>
        }
        @if(selectedContractDetails.supplierId){
          <div class="detail-row">
            <span class="detail-label">{{'CONTRACTS.FIELDS.SUPPLIER' | translate}}:</span>
            <span class="detail-value">{{ selectedContractDetails.supplierId.name }}</span>
          </div>
        }
        @if(selectedContractDetails.supplierContractNumber){
          <div class="detail-row">
            <span class="detail-label">{{'CONTRACTS.FIELDS.CONTRACT_NUMBER' | translate}}:</span>
            <span class="detail-value">{{ selectedContractDetails.supplierContractNumber }}</span>
          </div>
        }
        @if(selectedContractDetails.isCommercial){
          <div class="detail-row">
            <span class="detail-label">{{'CONTRACTS.FIELDS.COMMERCIAL' | translate}}:</span>
            <span class="detail-value">
              <span class="badge badge-active">{{'COMMON.YES' | translate}}</span>
              @if(selectedContractDetails.commercialName){
                <span> - {{ selectedContractDetails.commercialName }}</span>
              }
            </span>
          </div>
        }
        @if(selectedContractDetails.startDate){
          <div class="detail-row">
            <span class="detail-label">{{'CONTRACTS.FIELDS.START_DATE' | translate}}:</span>
            <span class="detail-value">{{ formatDate(selectedContractDetails.startDate) }}</span>
          </div>
        }
        @if(selectedContractDetails.endDate){
          <div class="detail-row">
            <span class="detail-label">{{'CONTRACTS.FIELDS.END_DATE' | translate}}:</span>
            <span class="detail-value">{{ formatDate(selectedContractDetails.endDate) }}</span>
          </div>
        }
        @if(selectedContractDetails.durationMonths){
          <div class="detail-row">
            <span class="detail-label">{{'CONTRACTS.FIELDS.DURATION' | translate}}:</span>
            <span class="detail-value">{{ selectedContractDetails.durationMonths }} Monate</span>
          </div>
        }
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="detail-value">{{ getStatusLabel(selectedContractDetails.status) }}</span>
        </div>
        @if(selectedContractDetails.notes){
          <div class="detail-row">
            <span class="detail-label">Notizen:</span>
            <span class="detail-value">{{ selectedContractDetails.notes }}</span>
          </div>
        }

        <!-- Dokumente/AnhÃ¤nge -->
        @if(selectedContractDetails.attachments && selectedContractDetails.attachments.length > 0){
          <div class="detail-section attachments-section">
            <h3><i class="fas fa-paperclip"></i> {{ 'CONTRACTS.FIELDS.ATTACHMENTS' | translate }} ({{ selectedContractDetails.attachments.length }})</h3>
            <div class="attachments-list">
              @for(attachment of selectedContractDetails.attachments; track attachment._id){
                <div class="attachment-item clickable" (click)="openAttachment(selectedContractDetails._id, attachment)">
                  <div class="attachment-icon">
                    <i [class]="getFileIcon(attachment.mimetype)"></i>
                  </div>
                  <div class="attachment-info">
                    <div class="attachment-name">{{ attachment.originalName }}</div>
                    <div class="attachment-meta">
                      {{ formatFileSize(attachment.size) }} â€¢ {{ formatDate(attachment.uploadedAt) }}
                    </div>
                  </div>
                  <div class="attachment-actions">
                    @if(isImage(attachment.mimetype)){
                      <button type="button" class="btn-icon" (click)="viewImageFromDetails(selectedContractDetails._id, attachment); $event.stopPropagation()" [title]="'COMMON.VIEW' | translate">
                        <i class="fas fa-eye"></i>
                      </button>
                    }
                    <button type="button" class="btn-icon" (click)="downloadAttachmentFromDetails(selectedContractDetails._id, attachment); $event.stopPropagation()" [title]="'COMMON.DOWNLOAD' | translate">
                      <i class="fas fa-download"></i>
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  </app-overlay-modal>
}
<!-- Image Viewer Modal -->
 @if(showImageViewer){
  <app-overlay-modal (close)="closeImageViewer()">
    <div class="image-viewer-modal">
      <div class="image-viewer-header">
        <h2>{{ viewingImage?.originalName }}</h2>
        <button class="btn-close" (click)="closeImageViewer()">&times;</button>
      </div>
      <div class="image-viewer-body">
        <img [src]="imageViewerUrl" [alt]="viewingImage?.originalName" />
      </div>
      <div class="image-viewer-footer">
        <span class="image-meta">{{ formatFileSize(viewingImage?.size || 0) }} â€¢ {{ formatDate(viewingImage?.uploadedAt) }}</span>
        <div class="image-actions">
          <button type="button" class="btn-secondary" (click)="downloadAttachment(viewingImage!)">
            <i class="fas fa-download"></i> Herunterladen
          </button>
          <button type="button" class="btn-secondary" (click)="closeImageViewer()">SchlieÃŸen</button>
        </div>
      </div>
    </div>
  </app-overlay-modal>
}
<!-- Customer Creation Modal -->
@if(showCustomerCreationModal){
  <app-overlay-modal (close)="closeCustomerCreationModal()">
    <h2>{{ 'CUSTOMERS.NEW' | translate }}</h2>
    <app-customer-form
      [customer]="newCustomer"
      [isEditMode]="false"
      [saving]="savingNewCustomer"
      [showSalutation]="true"
      [showAddressToggle]="true"
      (save)="saveNewCustomer($event)"
      (cancel)="closeCustomerCreationModal()"
    />
  </app-overlay-modal>
}
<!-- Meter Creation Modal -->
@if(showMeterCreationModal){
  <app-overlay-modal (close)="closeMeterCreationModal()">
    <app-meter-create
      [meter]="newMeter"
      [isEditMode]="isEditMode"
      (close)="closeMeterCreationModal()"
      (save)="saveNewMeter()"
    />
  </app-overlay-modal>
}
<!-- Supplier Creation Modal -->
@if(showSupplierCreationModal){
  <app-overlay-modal (close)="closeSupplierCreationModal()">
    <div class="modal-header">
      <h2>{{ 'SUPPLIERS.NEW' | translate }}</h2>
      <button class="btn-close" (click)="closeSupplierCreationModal()">&times;</button>
    </div>
    <form (ngSubmit)="saveNewSupplier()" #supplierForm="ngForm">
      <div class="form-group">
        <label>{{ 'COMMON.NAME' | translate }} *</label>
        <input type="text" [(ngModel)]="newSupplier.name" name="name" required class="form-control" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'COMMON.EMAIL' | translate }}</label>
          <input type="email" [(ngModel)]="newSupplier.contactEmail" name="contactEmail" class="form-control" />
        </div>
        <div class="form-group">
          <label>{{ 'COMMON.PHONE' | translate }}</label>
          <input type="tel" [(ngModel)]="newSupplier.contactPhone" name="contactPhone" class="form-control" />
        </div>
      </div>
      <div class="form-group">
        <label>{{ 'SUPPLIERS.FIELDS.WEBSITE' | translate }}</label>
        <input type="url" [(ngModel)]="newSupplier.website" name="website" placeholder="https://..." class="form-control" />
      </div>
      <div class="form-group">
        <label>{{ 'CUSTOMERS.FIELDS.ADDRESS' | translate }}</label>
        <app-address-autocomplete
          [address]="newSupplierAddressData"
          (addressChange)="onNewSupplierAddressChange($event)"
        />
      </div>
      <div class="form-group">
        <label>{{ 'COMMON.NOTES' | translate }}</label>
        <textarea [(ngModel)]="newSupplier.notes" name="notes" rows="3" class="form-control"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeSupplierCreationModal()">{{ 'COMMON.CANCEL' | translate }}</button>
        <button type="submit" class="btn-primary" [disabled]="!supplierForm.form.valid">{{ 'COMMON.CREATE' | translate }}</button>
      </div>
    </form>
  </app-overlay-modal>
}