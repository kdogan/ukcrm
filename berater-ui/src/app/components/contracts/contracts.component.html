
@if(viewportService.isMobile()){
  <app-contracts-mobile
    [contracts]="filteredContracts"
    [activeMenuId]="activeMenuId"
    (create)="showCreateModal()"
    (edit)="editContract($event)"
    (delete)="deleteContract($event)"
    (showDetails)="showContractDetails($event)"
    (statusFilterChange)="onStatusChange($event)"
    (daysFilterChange)="onDaysChange($event)"
    (searchChange)="onContractSearchChange($event)"
    (showCustomer)="showCustomerDetails($event)"
    (showMeter)="showMeterDetails($event)"
    (showSupplier)="showSupplierDetails($event)"
    (closeActionMenu)="closeActionMenu()"
    (toggleActionMenu)="activeMenuId = $event" 
/>
}@else{
  <app-contracts-desktop
    [contracts]="filteredContracts"
    [activeMenuId]="activeMenuId"
    (create)="showCreateModal()"
    (edit)="editContract($event)"
    (delete)="deleteContract($event)"
    (showDetails)="showContractDetails($event)"
    (statusFilterChange)="onStatusChange($event)"
    (daysFilterChange)="onDaysChange($event)"
    (searchChange)="onContractSearchChange($event)"
    (showCustomer)="showCustomerDetails($event)"
    (showMeter)="showMeterDetails($event)"
    (showSupplier)="showSupplierDetails($event)"
    (closeActionMenu)="closeActionMenu()"
  (toggleActionMenu)="activeMenuId = $event"
/>
}


<!-- Modal for Create/Edit Contract -->
 @if(showModal){
  <app-overlay-modal (close)="closeModal()">
    <div class="modal-header">
      <h2>{{ isEditMode ? 'Vertrag bearbeiten' : 'Neuer Vertrag' }}</h2>
      <button class="btn-close" (click)="closeModal()">&times;</button>
    </div>
    <form (ngSubmit)="saveContract()" #contractForm="ngForm">
      @if(isEditMode){
        <div class="form-group">
          <label>Id</label>
          <input type="text" class="form-control" [value]="currentContract.contractNumber" disabled />
        </div>
      }
      <div class="form-group">
        <label>Vertragsnummer (vom Anbieter geliefert)</label>
        <input type="text" id="supplierContractNumber" name="supplierContractNumber" class="form-control" [(ngModel)]="currentContract.supplierContractNumber" />
      </div>

      <div class="form-group">
        <label for="customerId">Kunde *</label>
        <input type="text" 
              placeholder="Suche nach Kunden..." 
              [(ngModel)]="customerSearch"
              (ngModelChange)="filterCustomers()" 
              (focus)="showCustomerDropdown = true" 
              class="form-control search-input"
              [ngModelOptions]="{standalone: true}" 
              autocomplete="off" />
              @if(showCustomerDropdown) {
                <div class="dropdown-list">
                @for(customer of filteredCustomers; track customer){
                  <div class="dropdown-item" 
                      [class.selected]="currentContract.customerId === customer._id" 
                      (click)="selectCustomer(customer)">
                    {{ customer.fullName }}
                    @if(customer.address){
                      <span style="font-size: 12px;"> ({{formatAddress(customer.address)}})</span>
                    }
                  </div>
                }
                @if(filteredCustomers.length === 0 && customerSearch.trim()) {
                  <div class="dropdown-item create-new" (click)="openCustomerCreationModal()">
                    <i class="fas fa-plus-circle"></i> Neuen Kunden erstellen
                  </div>
                }
                </div>
              }
        <input type="hidden" 
              id="customerId" 
              name="customerId" 
              [(ngModel)]="currentContract.customerId" required />
        @if(selectedCustomer){
        <div class="selected-item">
          Ausgew√§hlt: <strong>{{ selectedCustomer.firstName }} {{ selectedCustomer.lastName }}</strong> ({{
          selectedCustomer.customerNumber }})
          <button type="button" class="btn-clear" (click)="clearCustomer()">&times;</button>
        </div>
      }
      </div>

      <div class="form-group">
        <label for="meterId">Z√§hler *</label>
        <input type="text" placeholder="Suche nach Z√§hlernummer..." 
          [(ngModel)]="meterSearch"
          (ngModelChange)="filterMeters()" 
          (focus)="showMeterDropdown = true" 
          class="form-control search-input"
          [ngModelOptions]="{standalone: true}" 
          autocomplete="off" />
        @if(showMeterDropdown){
        <div class="dropdown-list">
          @for(meter of filteredFreeMeters; track meter){
            <div class="dropdown-item"
              [class.selected]="currentContract.meterId === meter._id" [class.occupied]="!isMeterFree(meter)"
              [class.disabled]="!isMeterFree(meter)" 
              (click)="isMeterFree(meter) && selectMeter(meter)"
              [style.cursor]="isMeterFree(meter) ? 'pointer' : 'not-allowed'">
              {{ meter.meterNumber }} ({{ getTypeLabel(meter.type) }})
              @if(!isMeterFree(meter)){
                <span class="meter-status">- Belegt</span>
              }
            </div>
          }
          @if(filteredFreeMeters.length === 0 && meterSearch.trim()) {
            <div class="dropdown-item create-new" (click)="openMeterCreationModal()">
              <i class="fas fa-plus-circle"></i> Neuen Z√§hler erstellen
            </div>
          }
        </div>
        }
        <input type="hidden" id="meterId" name="meterId" [(ngModel)]="currentContract.meterId" required />
        @if(selectedMeter){
          <div class="selected-item">
            Ausgew√§hlt: <strong>{{ selectedMeter.meterNumber }}</strong> ({{ getTypeLabel(selectedMeter.type) }})
            <button type="button" class="btn-clear" (click)="clearMeter()">&times;</button>
          </div>
        }
      </div>

      <div class="form-group">
        <label for="supplierId">Anbieter *</label>
        <select id="supplierId" name="supplierId" [(ngModel)]="currentContract.supplierId" required class="form-control">
          <option value="">Bitte w√§hlen</option>
          @for(supplier of suppliers; track supplier){
            <option [value]="supplier._id"> {{ supplier.name }}</option>
          }
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="startDate">Startdatum *</label>
          <input type="date" id="startDate" name="startDate" [(ngModel)]="currentContract.startDate" required
            class="form-control" />
        </div>

        <div class="form-group">
          <label for="durationMonths">Laufzeit (Monate) *</label>
          <input type="number" id="durationMonths" name="durationMonths" [(ngModel)]="currentContract.durationMonths"
            required min="1" max="120" placeholder="z.B. 24" class="form-control" />
        </div>
      </div>

      <div class="form-group">
        <label for="status">Status</label>
        <select id="status" name="status" [(ngModel)]="currentContract.status" class="form-control">
          @for(state of contractState; track state){
            <option [value]="state.key">{{state.value}}</option>
          }
        </select>
      </div>

      <!-- Datei-Uploads -->
      <div class="form-group" *ngIf="packageFeatureService.hasFileUpload() && (isEditMode || !isEditMode)">
        <label>Anh√§nge</label>

        <!-- Upload-Button -->
        <div class="file-upload-section">
          <input type="file" #fileInput (change)="onFileSelected($event)" style="display: none"
                accept=".jpg,.jpeg,.png,.gif,.webp,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv" />
          <button type="button" class="btn-secondary btn-sm" (click)="fileInput.click()" [disabled]="uploadingFile">
            <i class="fas fa-upload"></i>
            {{ uploadingFile ? 'Uploading...' : 'Datei hochladen' }}
          </button>
          <small class="file-info">Max. 10MB | JPG, PNG, PDF, Word, Excel, TXT, CSV</small>
        </div>

        <!-- Liste der hochgeladenen Dateien (Edit-Modus) -->
        <div class="attachments-list" *ngIf="isEditMode && currentContract.attachments && currentContract.attachments.length > 0">
          <div class="attachment-item" *ngFor="let attachment of currentContract.attachments">
            <div class="attachment-icon" (click)="isImage(attachment.mimetype) ? viewImage(attachment) : null"
                [style.cursor]="isImage(attachment.mimetype) ? 'pointer' : 'default'"
                [title]="isImage(attachment.mimetype) ? 'Klicken zum Anzeigen' : ''">
              <i [class]="getFileIcon(attachment.mimetype)"></i>
            </div>
            <div class="attachment-info" (click)="isImage(attachment.mimetype) ? viewImage(attachment) : null"
                [style.cursor]="isImage(attachment.mimetype) ? 'pointer' : 'default'">
              <div class="attachment-name">{{ attachment.originalName }}</div>
              <div class="attachment-meta">
                {{ formatFileSize(attachment.size) }} ‚Ä¢ {{ formatDate(attachment.uploadedAt) }}
              </div>
            </div>
            <div class="attachment-actions">
              <button type="button" class="btn-icon" (click)="viewImage(attachment)" title="Vorschau"
                      *ngIf="isImage(attachment.mimetype)">
                <i class="fas fa-eye"></i>
              </button>
              <button type="button" class="btn-icon" (click)="downloadAttachment(attachment)" title="Herunterladen">
                <i class="fas fa-download"></i>
              </button>
              <button type="button" class="btn-icon btn-danger" (click)="deleteAttachment(attachment)" title="L√∂schen">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Liste der noch nicht hochgeladenen Dateien (Create-Modus) -->
        <div class="attachments-list" *ngIf="!isEditMode && pendingFiles.length > 0">
          <div class="attachment-item" *ngFor="let file of pendingFiles">
            <div class="attachment-icon">
              <i [class]="getFileIcon(file.type)"></i>
            </div>
            <div class="attachment-info">
              <div class="attachment-name">{{ file.name }}</div>
              <div class="attachment-meta">
                {{ formatFileSize(file.size) }} ‚Ä¢ Wird beim Speichern hochgeladen
              </div>
            </div>
            <div class="attachment-actions">
              <button type="button" class="btn-icon btn-danger" (click)="deleteAttachment(file)" title="L√∂schen">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Info-Meldung wenn Feature nicht verf√ºgbar -->
      <div class="form-group" *ngIf="isEditMode && currentContract._id && !packageFeatureService.hasFileUpload()">
        <div class="feature-not-available">
          <i class="fas fa-lock"></i>
          <p>Datei-Upload ist in Ihrem aktuellen Paket ({{ packageFeatureService.getCurrentPackage() }}) nicht verf√ºgbar.</p>
          <p>Upgraden Sie auf ein h√∂heres Paket, um Dateien hochzuladen.</p>
        </div>
      </div>

      <div class="form-group">
        <label for="notes">Notizen</label>
        <textarea id="notes" name="notes" [(ngModel)]="currentContract.notes" rows="3"
          placeholder="Optional: Zus√§tzliche Informationen zum Vertrag" class="form-control"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeModal()" [disabled]="isSaving">Abbrechen</button>
        <button type="submit" class="btn-primary" [disabled]="!contractForm.form.valid || !isFormValid() || isSaving">
          <i class="fas" [class.fa-spinner]="isSaving" [class.fa-spin]="isSaving" [class.fa-save]="!isSaving"></i>
          {{ isSaving ? 'Wird gespeichert...' : (isEditMode ? 'Speichern' : 'Erstellen') }}
        </button>
      </div>
    </form>
  </app-overlay-modal>
}
<!-- Customer Details Modal -->
 @if(showCustomerDetailsModal){
  <app-overlay-modal (close)="closeCustomerDetails()">
    <div class="modal-header">
      <h2>Kundendetails</h2>
      <button class="btn-close" (click)="closeCustomerDetails()">&times;</button>
    </div>
    <div class="detail-content" *ngIf="selectedCustomerDetails">
      <div class="detail-row">
        <span class="detail-label">Kundennummer:</span>
        <span class="detail-value">{{ selectedCustomerDetails.customerNumber }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Name:</span>
        <span class="detail-value">{{ selectedCustomerDetails.firstName }} {{ selectedCustomerDetails.lastName }}</span>
      </div>
      <div class="detail-row" *ngIf="selectedCustomerDetails.email">
        <span class="detail-label">E-Mail:</span>
        <span class="detail-value">{{ selectedCustomerDetails.email }}</span>
      </div>
      <div class="detail-row" *ngIf="selectedCustomerDetails.phone">
        <span class="detail-label">Telefon:</span>
        <span class="detail-value">
          {{ selectedCustomerDetails.phone }}
          <a [href]="'tel:' + selectedCustomerDetails.phone" class="phone-link" title="Anrufen">üìû</a>
        </span>
      </div>
      <div class="detail-row" *ngIf="selectedCustomerDetails.address?.street || selectedCustomerDetails.address?.city">
        <span class="detail-label">Adresse:</span>
        <span class="detail-value">
          <span *ngIf="selectedCustomerDetails.address?.street">{{ selectedCustomerDetails.address?.street }}<br></span>
          <span *ngIf="selectedCustomerDetails.address?.zip || selectedCustomerDetails.address?.city">
            {{ selectedCustomerDetails.address?.zip }} {{ selectedCustomerDetails.address?.city }}
          </span>
        </span>
      </div>
      <div class="detail-row" *ngIf="selectedCustomerDetails.notes">
        <span class="detail-label">Notizen:</span>
        <span class="detail-value">{{ selectedCustomerDetails.notes }}</span>
      </div>
    </div>
  </app-overlay-modal>
}

<!-- Supplier Details Modal -->
 @if(showSupplierDetailsModal){
  <app-overlay-modal (close)="closeSupplierDetails()">
    <div class="modal-header">
      <h2>Anbieterdetails</h2>
      <button class="btn-close" (click)="closeSupplierDetails()">&times;</button>
    </div>
    @if(selectedSupplierDetails){
      <div class="detail-content">
        <div class="detail-row">
          <span class="detail-label">Name:</span>
          <span class="detail-value">{{ selectedSupplierDetails.name }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Kurzbezeichnung:</span>
          <span class="detail-value">{{ selectedSupplierDetails.shortName }}</span>
        </div>
        @if(selectedSupplierDetails.address?.street || selectedSupplierDetails.address?.city){
        <div class="detail-row">
          <span class="detail-label">Adresse:</span>
          <span class="detail-value">
            @if(selectedSupplierDetails.address?.street){
              <span>{{ selectedSupplierDetails.address?.street }}<br></span>
            }
            @if(selectedSupplierDetails.address?.zipCode || selectedSupplierDetails.address?.city){
              <span>
                {{ selectedSupplierDetails.address?.zipCode }} {{ selectedSupplierDetails.address?.city }}
              </span>
            }
          </span>
        </div>
      }
      @if(selectedSupplierDetails.contactPhone){
        <div class="detail-row">
          <span class="detail-label">Telefon:</span>
          <span class="detail-value">
            {{ selectedSupplierDetails.contactPhone }}
            <a [href]="'tel:' + selectedSupplierDetails.contactPhone" class="phone-link" title="Anrufen">üìû</a>
          </span>
        </div>
      }
      @if(selectedSupplierDetails.contactEmail){
        <div class="detail-row">
          <span class="detail-label">E-Mail:</span>
          <span class="detail-value">{{ selectedSupplierDetails.contactEmail }}</span>
        </div>
      }
      </div>
    }
  </app-overlay-modal>
}

<!-- Meter Details Modal -->
 @if(showMeterDetailsModal){
  <app-overlay-modal (close)="closeMeterDetails()">
    <div class="modal-header">
      <h2>Z√§hlerdetails</h2>
      <button class="btn-close" (click)="closeMeterDetails()">&times;</button>
    </div>
    @if(selectedMeterDetails){
    <div class="detail-content">
      <div class="detail-row">
        <span class="detail-label">Z√§hlernummer:</span>
        <span class="detail-value">{{ selectedMeterDetails.meterNumber }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Typ:</span>
        <span class="detail-value">{{ getTypeLabel(selectedMeterDetails.type) }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Status:</span>
        <span class="detail-value">
          <span class="badge" [class.badge-active]="!selectedMeterDetails.currentCustomerId">
            {{ selectedMeterDetails.currentCustomerId ? 'Belegt' : 'Frei' }}
          </span>
        </span>
      </div>
      @if(selectedMeterDetails.currentCustomerId){
      <div class="detail-row">
        <span class="detail-label">Aktueller Kunde:</span>
        <span class="detail-value">
          {{ selectedMeterDetails.currentCustomerId.firstName }} {{ selectedMeterDetails.currentCustomerId.lastName }}
        </span>
      </div>
      }
    </div>
  }
  </app-overlay-modal>
}

<!-- Contract Details Modal -->
 @if(showContractDetailsModal){
  <app-overlay-modal (close)="closeContractDetails()">
    <div class="modal-header">
      <h2>Vertragsdetails</h2>
      <button class="btn-close" (click)="closeContractDetails()">&times;</button>
    </div>
    @if(selectedContractDetails){
      <div class="detail-content">
        <div class="detail-row">
          <span class="detail-label">Id:</span>
          <span class="detail-value">{{ selectedContractDetails.contractNumber }}</span>
        </div>
        @if(selectedContractDetails.supplierContractNumber){
          <div class="detail-row">
            <span class="detail-label">Vertragsnummer:</span>
            <span class="detail-value">{{ selectedContractDetails.supplierContractNumber }}</span>
          </div>
        }
        @if(selectedContractDetails.customerId){
          <div class="detail-row">
            <span class="detail-label">Kunde:</span>
            <span class="detail-value">{{ selectedContractDetails.customerId.fullName }}</span>
          </div>
        }
        @if(selectedContractDetails.meterId){
          <div class="detail-row">
            <span class="detail-label">Z√§hler:</span>
            <span class="detail-value">
              {{ selectedContractDetails.meterId.meterNumber }}
              @if(selectedContractDetails.meterId.type){
                <span> ({{ getTypeLabel(selectedContractDetails.meterId.type) }})</span>
              }
            </span>
          </div>
        }
        @if(selectedContractDetails.supplierId){
          <div class="detail-row">
            <span class="detail-label">Anbieter:</span>
            <span class="detail-value">{{ selectedContractDetails.supplierId.name }}</span>
          </div>
        }
        @if(selectedContractDetails.startDate){
          <div class="detail-row">
            <span class="detail-label">Startdatum:</span>
            <span class="detail-value">{{ formatDate(selectedContractDetails.startDate) }}</span>
          </div>
        }
        @if(selectedContractDetails.endDate){
          <div class="detail-row">
            <span class="detail-label">Enddatum:</span>
            <span class="detail-value">{{ formatDate(selectedContractDetails.endDate) }}</span>
          </div>
        }
        @if(selectedContractDetails.durationMonths){
          <div class="detail-row">
            <span class="detail-label">Laufzeit:</span>
            <span class="detail-value">{{ selectedContractDetails.durationMonths }} Monate</span>
          </div>
        }
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="detail-value">{{ getStatusLabel(selectedContractDetails.status) }}</span>
        </div>
        @if(selectedContractDetails.notes){
          <div class="detail-row">
            <span class="detail-label">Notizen:</span>
            <span class="detail-value">{{ selectedContractDetails.notes }}</span>
          </div>
        }
      </div>
    }
  </app-overlay-modal>
}
<!-- Image Viewer Modal -->
 @if(showImageViewer){
  <app-overlay-modal (close)="closeImageViewer()">
    <div class="image-viewer-modal">
      <div class="image-viewer-header">
        <h2>{{ viewingImage?.originalName }}</h2>
        <button class="btn-close" (click)="closeImageViewer()">&times;</button>
      </div>
      <div class="image-viewer-body">
        <img [src]="imageViewerUrl" [alt]="viewingImage?.originalName" />
      </div>
      <div class="image-viewer-footer">
        <span class="image-meta">{{ formatFileSize(viewingImage?.size || 0) }} ‚Ä¢ {{ formatDate(viewingImage?.uploadedAt) }}</span>
        <div class="image-actions">
          <button type="button" class="btn-secondary" (click)="downloadAttachment(viewingImage!)">
            <i class="fas fa-download"></i> Herunterladen
          </button>
          <button type="button" class="btn-secondary" (click)="closeImageViewer()">Schlie√üen</button>
        </div>
      </div>
    </div>
  </app-overlay-modal>
}
<!-- Customer Creation Modal -->
@if(showCustomerCreationModal){
  <app-overlay-modal (close)="closeCustomerCreationModal()">
    <div class="modal-header">
      <h2>Neuen Kunden erstellen</h2>
      <button class="btn-close" (click)="closeCustomerCreationModal()">&times;</button>
    </div>
    <form (ngSubmit)="saveNewCustomer()" #customerForm="ngForm">
      <div class="form-row">
        <div class="form-group">
          <label>Vorname *</label>
          <input type="text" [(ngModel)]="newCustomer.firstName" name="firstName" required class="form-control" />
        </div>
        <div class="form-group">
          <label>Nachname *</label>
          <input type="text" [(ngModel)]="newCustomer.lastName" name="lastName" required class="form-control" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>E-Mail</label>
          <input type="email" [(ngModel)]="newCustomer.email" name="email" class="form-control" />
        </div>
        <div class="form-group">
          <label>Telefon</label>
          <input type="tel" [(ngModel)]="newCustomer.phone" name="phone" class="form-control" />
        </div>
      </div>
      <div class="form-group">
        <label>Adresse</label>
        <input type="text" name="street" [(ngModel)]="newCustomer.address.street" placeholder="Stra√üe" class="form-control" />
        <div class="form-row">
          <input type="text" name="zip" [(ngModel)]="newCustomer.address.zip" placeholder="PLZ" class="form-control" />
          <input type="text" name="city" [(ngModel)]="newCustomer.address.city" placeholder="Ort" class="form-control" />
        </div>
      </div>
      <div class="form-group">
        <label>Notizen</label>
        <textarea [(ngModel)]="newCustomer.notes" name="notes" rows="3" class="form-control"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeCustomerCreationModal()">Abbrechen</button>
        <button type="submit" class="btn-primary" [disabled]="!customerForm.form.valid">Erstellen</button>
      </div>
    </form>
  </app-overlay-modal>
}
<!-- Meter Creation Modal -->
@if(showMeterCreationModal){
  <app-overlay-modal (close)="closeMeterCreationModal()">
    <app-meter-create
      [meter]="newMeter"
      [isEditMode]="isEditMode"
      (close)="closeMeterCreationModal()"
      (save)="saveNewMeter()"
    />
  </app-overlay-modal>
}