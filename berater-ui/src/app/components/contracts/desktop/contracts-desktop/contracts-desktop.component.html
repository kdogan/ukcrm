<div class="page-container" (click)="closeActionMenu.emit()">
  <div class="page-header">
    <h1>{{ 'CONTRACTS.TITLE' | translate }}</h1>
    <div class="header-actions">
      <button class="btn-secondary" (click)="exportExcel.emit(); $event.stopPropagation()" title="Als Excel exportieren">
        <i class="fas fa-file-excel"></i> Export
      </button>
      <button class="btn-primary" (click)="create.emit(); $event.stopPropagation()">
        <i class="fas fa-plus"></i> {{ 'CONTRACTS.NEW' | translate }}
      </button>
    </div>
  </div>
  <div class="filters">
    <app-search-input
      [value]="searchTerm"
      (valueChange)="searchTerm = $event; searchChange.emit($event)"
      placeholder="Suche nach Vertragsnr., Kunde oder Zähler...">
    </app-search-input>
    <select [ngModel]="statusFilter" (ngModelChange)="statusFilterChange.emit($event)" (click)="$event.stopPropagation()">
      <option value="">{{ 'CONTRACTS.FILTER.ALL' | translate }} {{ 'CONTRACTS.FIELDS.STATUS' | translate }}</option>
      @for(state of contractState; track state){
        <option [value]="state.key">{{state.value}}</option>
      }
    </select>
    <select [ngModel]="daysFilter" (ngModelChange)="daysFilterChange.emit($event)" (click)="$event.stopPropagation()">
      <option value="">{{ 'CONTRACTS.FILTER.ALL' | translate }}</option>
      <option value="30">Nächste 30 Tage</option>
      <option value="60">Nächste 60 Tage</option>
      <option value="90">Nächste 90 Tage</option>
    </select>
  </div>
  <app-table-container>
    <table class="data-table" (click)="$event.stopPropagation()">
      <thead>
        <tr>
          <th>{{ 'CONTRACTS.FIELDS.CUSTOMER' | translate }}</th>
          <th>{{ 'CONTRACTS.FIELDS.METER' | translate }}</th>
          <th>{{ 'CONTRACTS.FIELDS.SUPPLIER' | translate }}</th>
          <th>{{ 'CONTRACTS.FIELDS.START_DATE' | translate }}</th>
          <th>{{ 'CONTRACTS.FIELDS.END_DATE' | translate }}</th>
          <th>{{ 'CONTRACTS.FIELDS.STATUS' | translate }}</th>
          <th>{{ 'COMMON.ACTIONS' | translate }}</th>
        </tr>
      </thead>
      <tbody>
        @for(contract of contracts; track contract){
          <tr>
            <td>
              @if(contract.customerId){
              <a class="clickable-link"
                (click)="showCustomer.emit(contract.customerId._id); closeActionMenu.emit(); $event.stopPropagation()" title="Kunde anzeigen">
                {{ contract.customerId?.firstName }} {{ contract.customerId?.lastName }}
              </a>
            } @else{
              <span>-</span>
            }
            </td>
            <td>
              @if(contract.meterId){
              <a class="clickable-link"
                (click)="showMeter.emit(contract.meterId._id); closeActionMenu.emit(); $event.stopPropagation()" title="Zähler anzeigen">
                {{ contract.meterId?.meterNumber }}
              </a>
            } @else {
              <span>-</span>
            }
            </td>
            <td>
              @if(contract.supplierId){
              <a class="clickable-link"
                (click)="showSupplier.emit(contract.supplierId._id); closeActionMenu.emit(); $event.stopPropagation()" title="Anbieter anzeigen">
                {{ contract.supplierId?.name }}
              </a>
            }@else{
              <span>-</span>
            }
            </td>
            <td>{{ contract.startDate | date:'dd.MM.yyyy' }}</td>
            <td>{{ contract.endDate | date:'dd.MM.yyyy' }}</td>
            <td><span class="badge"
                  [class.badge-active]="contract.status === 'active'"
                  [class.badge-archived]="contract.status === 'archived'"
                  [class.badge-draft]="contract.status === 'draft'"
                  [class.badge-ended]="contract.status === 'ended'">{{ getStatusLabel(contract.status) }}</span></td>
            <td class="actions-cell">
              <div class="action-menu-container">
                <button class="action-menu-btn" (click)="emitActionMenuId(contract._id); $event.stopPropagation()">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                @if(activeMenuId === contract._id){
                <div class="action-menu" (click)="$event.stopPropagation()">
                  <button class="menu-item" (click)="showDetails.emit(contract); closeActionMenu.emit()">
                    <i class="fas fa-info-circle fa-lg"></i> {{ 'COMMON.DETAILS' | translate}}
                  </button>
                  <button class="menu-item" (click)="edit.emit(contract); closeActionMenu.emit()">
                    <i class="fas fa-edit"></i> {{ 'COMMON.EDIT' | translate}}
                  </button>
                  <button class="menu-item menu-item-danger" (click)="delete.emit(contract._id); closeActionMenu.emit()">
                    <i class="fas fa-trash"></i> {{ 'COMMON.DELETE' | translate}}
                  </button>
                </div>
              }
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </app-table-container>

  <!-- Pagination -->
  @if(totalPages > 1){
    <div class="pagination">
      <div class="pagination-info">
        {{ 'COMMON.SHOWING' | translate }} {{ (currentPage - 1) * pageSize + 1 }} - {{ currentPage * pageSize > totalItems ? totalItems : currentPage * pageSize }} {{ 'COMMON.OF' | translate }} {{ totalItems }}
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn" (click)="goToPage(1); $event.stopPropagation()" [disabled]="currentPage === 1" title="Erste Seite">
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button class="pagination-btn" (click)="goToPage(currentPage - 1); $event.stopPropagation()" [disabled]="currentPage === 1" title="Vorherige Seite">
          <i class="fas fa-angle-left"></i>
        </button>
        @for(page of getVisiblePages(); track page){
          <button class="pagination-btn" [class.active]="page === currentPage" (click)="goToPage(page); $event.stopPropagation()">
            {{ page }}
          </button>
        }
        <button class="pagination-btn" (click)="goToPage(currentPage + 1); $event.stopPropagation()" [disabled]="currentPage === totalPages" title="Nächste Seite">
          <i class="fas fa-angle-right"></i>
        </button>
        <button class="pagination-btn" (click)="goToPage(totalPages); $event.stopPropagation()" [disabled]="currentPage === totalPages" title="Letzte Seite">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
      <div class="pagination-size">
        <select [ngModel]="pageSize" (ngModelChange)="onPageSizeChange($event)" (click)="$event.stopPropagation()" class="page-size-select">
          <option [ngValue]="10">10</option>
          <option [ngValue]="25">25</option>
          <option [ngValue]="50">50</option>
          <option [ngValue]="100">100</option>
        </select>
        <span>{{ 'COMMON.PER_PAGE' | translate }}</span>
      </div>
    </div>
  }
</div>