@if(isMobile){
<app-meters-mobile [meters]="filteredMeters" (create)="showCreateModal()" (edit)="editMeter($event); closeActionMenu()"
  (closeActionMenu)="closeActionMenu()" (filterStatusChange)="statusFilter = $event; filterMeters()"
  (filterTypeChange)="typeFilter = $event; filterMeters()" (toggleActionMenu)="toggleActionMenu($event)"
  (searchTermChange)="searchTerm = $event; onSearchChange()" (showDetails)="showMeterDetails($event); closeActionMenu()"
  (addReading)="showAddReadingModal($event); closeActionMenu()"
  (viewReadings)="viewReadings($event); closeActionMenu()" />
} @else {
<div class="page-container" (click)="closeActionMenu()">
  <div class="page-header">
    <h1>Zähler</h1>
    <button class="btn-primary" (click)="showCreateModal()">+ Neuer Zähler</button>
  </div>

  <div class="filters">
    <app-search-input [value]="searchTerm" (valueChange)="searchTerm = $event; onSearchChange()"
      placeholder="Suche nach Zählernummer...">
    </app-search-input>
    <select [(ngModel)]="statusFilter" (ngModelChange)="filterMeters()" class="filter-select">
      <option value="">Alle Status</option>
      <option value="free">Frei</option>
      <option value="occupied">Belegt</option>
    </select>
    <select [(ngModel)]="typeFilter" (ngModelChange)="filterMeters()" class="filter-select">
      <option value="" disabled>Zählertyp wählen</option>
      <option value="">Alle Typen</option>
      <option *ngFor="let type of meterTypes" [value]="type">
        {{ getTypeLabel(type) }}
      </option>

    </select>
  </div>

  <app-table-container>
    <table class="data-table">
      <thead>
        <tr>
          <th>Zählernummer</th>
          <th>Typ</th>
          <th>Status</th>
          <th>Aktueller Zählerstand</th>
          <th>Letzte Ablesung</th>
          <th>Aktueller Kunde</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let meter of filteredMeters">
          <td>{{ meter.meterNumber }}</td>
          <td>{{ getTypeLabel(meter.type) }}</td>
          <td>
            <span class="badge" [class.badge-active]="!meter.currentCustomerId">
              {{ meter.currentCustomerId ? 'Belegt' : 'Frei' }}
            </span>
          </td>
          <td>
            <!-- Ein-Tarif-Zähler -->
            <strong *ngIf="meter.currentReading != null">{{ meter.currentReading }}</strong>

            <!-- Zwei-Tarif-Zähler (HT/NT) -->
            <div *ngIf="meter.currentReadingHT != null && meter.currentReadingNT != null" style="font-size: 0.9rem;">
              <strong>HT:</strong> {{ meter.currentReadingHT }}<br>
              <strong>NT:</strong> {{ meter.currentReadingNT }}
            </div>

            <!-- Kein Wert -->
            <span *ngIf="meter.currentReading == null && meter.currentReadingHT == null">-</span>
          </td>
          <td>
            {{ meter.lastReadingDate ? (meter.lastReadingDate | date:'dd.MM.yyyy') : '-' }}
          </td>
          <td>
            {{ meter.currentCustomerId ?
            (meter.currentCustomerId.firstName + ' ' + meter.currentCustomerId.lastName) : '-' }}
          </td>
          <td class="actions-cell">
            <div class="action-menu-container">
              <button class="action-menu-btn" (click)="toggleActionMenu(meter._id); $event.stopPropagation()">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="action-menu" *ngIf="activeMenuId === meter._id" (click)="$event.stopPropagation()">
                <button class="menu-item" (click)="showMeterDetails(meter); closeActionMenu()">
                  <i class="fas fa-info-circle fa-lg"></i> Details anzeigen
                </button>
                <button class="menu-item" (click)="showAddReadingModal(meter); closeActionMenu()">
                  <i class="fas fa-plus-circle fa-lg"></i>Ablesung hinzufügen
                </button>
                <button class="menu-item" (click)="viewReadings(meter); closeActionMenu()">
                  <i class="fas fa-eye fa-lg"></i>Ablesungen anzeigen
                </button>
                <button class="menu-item" (click)="editMeter(meter); closeActionMenu()">
                  <i class="fas fa-edit fa-lg"></i> Bearbeiten
                </button>
                <button class="menu-item menu-item-danger" (click)="deleteMeter(meter._id); closeActionMenu()">
                  <i class="fas fa-trash fa-lg"></i> Löschen
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </app-table-container>

</div>
}

<!-- Modal for Create/Edit Meter -->
<app-overlay-modal *ngIf="showModal" (close)="closeModal()">
  <app-meter-create [meter]="currentMeter" , [isEditMode]="isEditMode" , (close)="closeModal()" ,
    (save)="saveMeter()" />
</app-overlay-modal>

<!-- Modal for showing Zähler-->
<app-overlay-modal *ngIf="showMeterModalForDetails" (close)="closeMeterModalDetails()">
  <div class="modal-header">
    <h2>Zähler · {{ selectedMeterForDetails?.meterNumber }}</h2>
    <button class="btn-close" (click)="closeMeterModalDetails()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <div class="modal-body">

    <div class="info-row">
      <span class="label">Zählernummer</span>
      <span class="value">{{ selectedMeterForDetails?.meterNumber }}</span>
    </div>
    <div class="info-row" *ngIf="selectedMeterForDetails.maloId">
      <span class="label">Malo Id</span>
      <span class="value">
        {{ selectedMeterForDetails?.maloId }}
      </span>
    </div>

    <div class="info-row">
      <span class="label">Typ</span>
      <span class="value badge">
        {{ getTypeLabel(selectedMeterForDetails?.type) }}
      </span>
    </div>

    <div class="info-row address">
      <span class="label">Adresse</span>
      <span class="value">
        {{ selectedMeterForDetails?.location?.street }}<br />
        {{ selectedMeterForDetails?.location?.zip }} {{ selectedMeterForDetails?.location?.city }}
      </span>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn-secondary" (click)="closeMeterModalDetails()">Schließen</button>
  </div>
</app-overlay-modal>

<!-- Modal for Adding Reading -->
@if(showReadingModal) {
<app-overlay-modal (close)="closeReadingModal()">
  <div class="modal-header">
    <h2>Neue Ablesung für {{ selectedMeterForReading?.meterNumber }}</h2>
    <button class="btn-close" (click)="closeReadingModal()">&times;</button>
  </div>
  <form (ngSubmit)="saveReading()" #readingForm="ngForm">
    <!-- Zwei-Tarif-Zähler (HT/NT) -->
    @if(selectedMeterForReading?.isTwoTariff){
    <div class="form-group">
      <label for="readingValueHT">HT (Hochtarif) *</label>
      <input type="number" id="readingValueHT" name="readingValueHT" [(ngModel)]="currentReading.readingValueHT"
        [required]="selectedMeterForReading?.isTwoTariff" min="0" step="0.01" placeholder="z.B. 12345"
        class="form-control" />
      @if(selectedMeterForReading?.currentReadingHT){
      <small style="color: #666;">
        Letzter HT-Wert: {{ selectedMeterForReading.currentReadingHT }}
      </small>
      }
    </div>
    <div class="form-group">
      <label for="readingValueNT">NT (Niedrigtarif)</label>
      <input type="number" id="readingValueNT" name="readingValueNT" [(ngModel)]="currentReading.readingValueNT" min="0"
        step="0.01" placeholder="z.B. 5678 (optional)" class="form-control" />
      @if(selectedMeterForReading?.currentReadingNT){
      <small style="color: #666;"> Letzter NT-Wert: {{ selectedMeterForReading.currentReadingNT }}</small>
      }
    </div>
    }@else{
      <!-- Ein-Tarif-Zähler -->
      <div class="form-group" *ngIf="!selectedMeterForReading?.isTwoTariff">
        <label for="readingValue">Zählerstand *</label>
        <input type="number" id="readingValue" name="readingValue" [(ngModel)]="currentReading.readingValue"
          [required]="!selectedMeterForReading?.isTwoTariff" min="0" step="0.01" placeholder="z.B. 12345"
          class="form-control" />
          @if(selectedMeterForReading?.currentReading){
            <small style="color: #666;">
              Letzter Zählerstand: {{ selectedMeterForReading.currentReading }}
            </small>
          }
      </div>
    }


    <div class="form-group">
      <label for="readingDate">Ablesedatum *</label>
      <input type="date" id="readingDate" name="readingDate" [(ngModel)]="currentReading.readingDate" required
        class="form-control" />
    </div>

    <div class="form-group">
      <label for="readingType">Typ</label>
      <select id="readingType" name="readingType" [(ngModel)]="currentReading.readingType" class="form-control">
        <option value="initial">Erstablesung</option>
        <option value="regular">Reguläre Ablesung</option>
        <option value="final">Schlussablesung</option>
        <option value="special">Sonderablesung</option>
      </select>
    </div>

    <div class="form-group">
      <label for="notes">Notizen</label>
      <textarea id="notes" name="notes" [(ngModel)]="currentReading.notes" rows="3"
        placeholder="Optional: Zusätzliche Informationen" class="form-control"></textarea>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeReadingModal()">Abbrechen</button>
      <button type="submit" class="btn-primary" [disabled]="!readingForm.form.valid">
        Speichern
      </button>
    </div>
  </form>
</app-overlay-modal>
}
<!-- Modal for Viewing Readings -->
<app-overlay-modal *ngIf="showReadingsListModal" (close)="closeReadingsListModal()">
  <div class="modal-header">
    <h2>Ablesungen für {{ selectedMeterForReading?.meterNumber }}</h2>
    <button class="btn-close" (click)="closeReadingsListModal()">&times;</button>
  </div>

  <ng-container *ngTemplateOutlet="meterReadingList" />

  <div class="modal-footer">
    <button type="button" class="btn-secondary" (click)="closeReadingsListModal()">
      Schließen
    </button>
  </div>
</app-overlay-modal>

<ng-template #meterReadingList>
  <div class="readings-list">
    <div *ngIf="meterReadings.length === 0" class="no-data">
      Keine Ablesungen vorhanden
    </div>

    <table class="data-table" *ngIf="meterReadings.length > 0">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Zählerstand</th>
          <th>Verbrauch</th>
          <th>Typ</th>
          <th>Notizen</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let reading of meterReadings">
          <td>{{ reading.readingDate | date:'dd.MM.yyyy' }}</td>
          <td>
            <!-- Ein-Tarif-Zähler -->
            <strong *ngIf="reading.readingValue != null">{{ reading.readingValue }}</strong>

            <!-- Zwei-Tarif-Zähler (HT/NT) -->
            <div *ngIf="reading.readingValueHT != null && reading.readingValueNT != null">
              <strong>HT:</strong> {{ reading.readingValueHT }}<br>
              <strong>NT:</strong> {{ reading.readingValueNT }}
            </div>
          </td>
          <td>
            <!-- Ein-Tarif-Verbrauch -->
            <span *ngIf="reading.consumption">
              {{ reading.consumption }} ({{ reading.daysSinceLastReading }} Tage)
            </span>

            <!-- Zwei-Tarif-Verbrauch (HT/NT) -->
            <div *ngIf="reading.consumptionHT != null && reading.consumptionNT != null">
              <strong>HT:</strong> {{ reading.consumptionHT }}<br>
              <strong>NT:</strong> {{ reading.consumptionNT }}<br>
              <strong>Gesamt:</strong> {{ reading.consumptionTotal }}<br>
              <small>({{ reading.daysSinceLastReading }} Tage)</small>
            </div>

            <span *ngIf="!reading.consumption && !reading.consumptionTotal">-</span>
          </td>
          <td>{{ getReadingTypeLabel(reading.readingType) }}</td>
          <td>{{ reading.notes || '-' }}</td>
          <td>
            <button class="btn-small btn-danger" (click)="deleteReading(reading._id)">
              Löschen
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</ng-template>