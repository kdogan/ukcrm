@if(isMobile){
<app-meters-mobile [meters]="filteredMeters" (create)="showCreateModal()" (edit)="editMeter($event); closeActionMenu()"
  (closeActionMenu)="closeActionMenu()" (filterStatusChange)="statusFilter = $event; filterMeters()"
  (filterTypeChange)="typeFilter = $event; filterMeters()" (toggleActionMenu)="toggleActionMenu($event)"
  (searchTermChange)="searchTerm = $event; onSearchChange()" (showDetails)="showMeterDetails($event); closeActionMenu()"
  (addReading)="showAddReadingModal($event); closeActionMenu()"
  (viewReadings)="viewReadings($event); closeActionMenu()"
  (showCustomerDetails)="showCustomerDetails($event)" />
} @else {
<div class="page-container" (click)="closeActionMenu()">
  <div class="page-header">
    <h1>{{ 'METERS.TITLE' | translate }}</h1>
    <button class="btn-primary" (click)="showCreateModal()">+ {{ 'METERS.NEW' | translate }}</button>
  </div>

  <div class="filters">
    <app-search-input [value]="searchTerm" (valueChange)="searchTerm = $event; onSearchChange()"
      [placeholder]="'METERS.SEARCH' | translate">
    </app-search-input>
    <select [(ngModel)]="statusFilter" (ngModelChange)="filterMeters()" class="filter-select">
      <option value="">{{ 'COMMON.ALL' | translate }}</option>
      <option value="free">{{ 'METERS.STATUS.FREE' | translate }}</option>
      <option value="occupied">{{ 'METERS.STATUS.OCCUPIED' | translate }}</option>
    </select>
    <select [(ngModel)]="typeFilter" (ngModelChange)="filterMeters()" class="filter-select">
      <option value="" disabled>{{ 'METERS.FIELDS.TYPE' | translate }}</option>
      <option value="">{{ 'COMMON.ALL' | translate }}</option>
      <option *ngFor="let type of meterTypes" [value]="type">
        {{ getTypeLabel(type) }}
      </option>

    </select>
  </div>

  <app-table-container>
    <table class="data-table">
      <thead>
        <tr>
          <th>{{ 'METERS.FIELDS.METER_NUMBER' | translate }}</th>
          <th>{{ 'METERS.FIELDS.TYPE' | translate }}</th>
          <th>{{ 'COMMON.STATUS' | translate }}</th>
          <th>{{ 'METERS.FIELDS.READING' | translate }}</th>
          <th>{{ 'METERS.FIELDS.LAST_READING' | translate }}</th>
          <th>{{ 'METERS.FIELDS.CUSTOMER' | translate }}</th>
          <th>{{ 'COMMON.ACTIONS' | translate }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let meter of filteredMeters" class="clickable-row" (click)="showMeterDetails(meter)">
          <td>{{ meter.meterNumber }}</td>
          <td>{{ getTypeLabel(meter.type) }}</td>
          <td>
            <span class="badge"
                  [class.badge-active]="!meter.currentCustomerId"
                  [class.badge-inactive]="meter.currentCustomerId">
              {{ meter.currentCustomerId ? ('METERS.STATUS.OCCUPIED' | translate) : ('METERS.STATUS.FREE' | translate) }}
            </span>
          </td>
          <td>

            <!-- Zwei-Tarif-Zähler (HT/NT) -->
            @if(meter.isTwoTariff){
            <div style="font-size: 0.9rem;">
              <strong>HT:</strong> {{ meter.currentReadingHT || '-' }} {{ meter.currentReadingHT ? getMeterUnit(meter.type) : '' }}<br>
              <strong>NT:</strong> {{ meter.currentReadingNT || '-'  }} {{ meter.currentReadingNT ? getMeterUnit(meter.type) : '' }}
            </div>
            }@else {
              <!-- Ein-Tarif-Zähler -->
              <strong>{{ meter.currentReading  || '-'}} {{ meter.currentReading ? getMeterUnit(meter.type) : '' }}</strong>
            }
          </td>
          <td>
            {{ meter.lastReadingDate ? (meter.lastReadingDate | date:'dd.MM.yyyy') : '-' }}
          </td>
          <td>
            @if(meter.currentCustomerId) {
              <span class="customer-link"
                    (click)="showCustomerDetails(meter.currentCustomerId); $event.stopPropagation()"
                    title="{{ 'METERS.SHOW_CUSTOMER_DETAILS' | translate }}">
                {{ meter.currentCustomerId.firstName }} {{ meter.currentCustomerId.lastName }}
              </span>
            } @else {
              -
            }
          </td>
          <td class="actions-cell">
            <div class="action-menu-container">
              <button class="action-menu-btn" (click)="toggleActionMenu(meter._id); $event.stopPropagation()">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div class="action-menu" *ngIf="activeMenuId === meter._id" (click)="$event.stopPropagation()">
                <button class="menu-item" (click)="showMeterDetails(meter); closeActionMenu()">
                  <i class="fas fa-info-circle fa-lg"></i> {{ 'COMMON.DETAILS' | translate }}
                </button>
                <button class="menu-item" (click)="showAddReadingModal(meter); closeActionMenu()">
                  <i class="fas fa-plus-circle fa-lg"></i> {{ 'METERS.ADD_READING' | translate }}
                </button>
                <button class="menu-item" (click)="viewReadings(meter); closeActionMenu()">
                  <i class="fas fa-eye fa-lg"></i> {{ 'METERS.VIEW_READINGS' | translate }}
                </button>
                <button class="menu-item" (click)="editMeter(meter); closeActionMenu()">
                  <i class="fas fa-edit fa-lg"></i> {{ 'COMMON.EDIT' | translate }}
                </button>
                <button class="menu-item menu-item-danger" (click)="deleteMeter(meter._id); closeActionMenu()">
                  <i class="fas fa-trash fa-lg"></i> {{ 'COMMON.DELETE' | translate }}
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </app-table-container>

  <!-- Pagination -->
  @if(totalPages > 1){
    <div class="pagination">
      <div class="pagination-info">
        {{ 'COMMON.SHOWING' | translate }} {{ (currentPage - 1) * pageSize + 1 }} - {{ currentPage * pageSize > totalItems ? totalItems : currentPage * pageSize }} {{ 'COMMON.OF' | translate }} {{ totalItems }}
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn" (click)="goToPage(1)" [disabled]="currentPage === 1" title="Erste Seite">
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button class="pagination-btn" (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1" title="Vorherige Seite">
          <i class="fas fa-angle-left"></i>
        </button>
        @for(page of getVisiblePages(); track page){
          <button class="pagination-btn" [class.active]="page === currentPage" (click)="goToPage(page)">
            {{ page }}
          </button>
        }
        <button class="pagination-btn" (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages" title="Nächste Seite">
          <i class="fas fa-angle-right"></i>
        </button>
        <button class="pagination-btn" (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages" title="Letzte Seite">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
      <div class="pagination-size">
        <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange()" class="page-size-select">
          <option [ngValue]="10">10</option>
          <option [ngValue]="25">25</option>
          <option [ngValue]="50">50</option>
          <option [ngValue]="100">100</option>
        </select>
        <span>{{ 'COMMON.PER_PAGE' | translate }}</span>
      </div>
    </div>
  }

</div>
}

<!-- Modal for Create/Edit Meter -->
 @if(showModal){
  <app-overlay-modal (close)="closeModal()">
    <app-meter-create 
      [meter]="currentMeter" 
      [isEditMode]="isEditMode" 
      (close)="closeModal()"
      (save)="saveMeter()" 
    />
  </app-overlay-modal>
}

<!-- Modal for showing Zähler-->
 @if(showMeterModalForDetails){
  <app-overlay-modal (close)="closeMeterModalDetails()">
    <div class="modal-header">
      <h2>Zähler · {{ selectedMeterForDetails?.meterNumber }}</h2>
      <button class="btn-close" (click)="closeMeterModalDetails()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">

      <div class="info-row">
        <span class="label">Zählernummer</span>
        <span class="value">{{ selectedMeterForDetails?.meterNumber }}</span>
      </div>
      <div class="info-row" *ngIf="selectedMeterForDetails.maloId">
        <span class="label">Malo Id</span>
        <span class="value">
          {{ selectedMeterForDetails?.maloId }}
        </span>
      </div>

      <div class="info-row">
        <span class="label">Typ</span>
        <span class="value badge">
          {{ getTypeLabel(selectedMeterForDetails?.type) }}
        </span>
      </div>

      <div class="info-row address">
        <span class="label">Adresse</span>
        <span class="value">
          {{ selectedMeterForDetails?.location?.street }}<br />
          {{ selectedMeterForDetails?.location?.zip }} {{ selectedMeterForDetails?.location?.city }}
        </span>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeMeterModalDetails()">Schließen</button>
    </div>
  </app-overlay-modal>
}
<!-- Modal for Adding Reading -->
@if(showReadingModal) {
<app-overlay-modal (close)="closeReadingModal()">
  <div class="modal-header">
    <h2>Neue Ablesung für {{ selectedMeterForReading?.meterNumber }}</h2>
    <button class="btn-close" (click)="closeReadingModal()">&times;</button>
  </div>
  <form (ngSubmit)="saveReading()" #readingForm="ngForm">
    <!-- Zwei-Tarif-Zähler (HT/NT) -->
    @if(selectedMeterForReading?.isTwoTariff){
    <div class="form-group">
      <label for="readingValueHT">HT (Hochtarif) in {{ getMeterUnit(selectedMeterForReading.type) }} *</label>
      <input type="number" id="readingValueHT" name="readingValueHT" [(ngModel)]="currentReading.readingValueHT"
        [required]="selectedMeterForReading?.isTwoTariff" min="0" step="0.01" placeholder="z.B. 12345"
        class="form-control" />
      @if(selectedMeterForReading?.currentReadingHT){
      <small style="color: #666;">
        Letzter HT-Wert: {{ selectedMeterForReading.currentReadingHT }} {{ getMeterUnit(selectedMeterForReading.type) }}
      </small>
      }
    </div>
    <div class="form-group">
      <label for="readingValueNT">NT (Niedrigtarif) in {{ getMeterUnit(selectedMeterForReading.type) }}</label>
      <input type="number" id="readingValueNT" name="readingValueNT" [(ngModel)]="currentReading.readingValueNT" min="0"
        step="0.01" placeholder="z.B. 5678 (optional)" class="form-control" />
      @if(selectedMeterForReading?.currentReadingNT){
      <small style="color: #666;"> Letzter NT-Wert: {{ selectedMeterForReading.currentReadingNT }} {{ getMeterUnit(selectedMeterForReading.type) }}</small>
      }
    </div>
    }@else{
      <!-- Ein-Tarif-Zähler -->
      <div class="form-group">
        <label for="readingValue">Zählerstand in {{ getMeterUnit(selectedMeterForReading.type) }} *</label>
        <input type="number" id="readingValue" name="readingValue" [(ngModel)]="currentReading.readingValue"
          [required]="!selectedMeterForReading?.isTwoTariff" min="0" step="0.01" placeholder="z.B. 12345"
          class="form-control" />
          @if(selectedMeterForReading?.currentReading){
            <small style="color: #666;">
              Letzter Zählerstand: {{ selectedMeterForReading.currentReading }} {{ getMeterUnit(selectedMeterForReading.type) }}
            </small>
          }
      </div>
    }


    <div class="form-group">
      <label for="readingDate">Ablesedatum *</label>
      <input type="date" id="readingDate" name="readingDate" [(ngModel)]="currentReading.readingDate" required
        class="form-control" />
    </div>

    <div class="form-group">
      <label for="readingType">Typ</label>
      <select id="readingType" name="readingType" [(ngModel)]="currentReading.readingType" class="form-control">
        <option value="initial">Erstablesung</option>
        <option value="regular">Reguläre Ablesung</option>
        <option value="final">Schlussablesung</option>
        <option value="special">Sonderablesung</option>
      </select>
    </div>

    <div class="form-group">
      <label for="notes">Notizen</label>
      <textarea id="notes" name="notes" [(ngModel)]="currentReading.notes" rows="3"
        placeholder="Optional: Zusätzliche Informationen" class="form-control"></textarea>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeReadingModal()">Abbrechen</button>
      <button type="submit" class="btn-primary" [disabled]="!readingForm.form.valid">
        Speichern
      </button>
    </div>
  </form>
</app-overlay-modal>
}
<!-- Modal for Viewing Readings -->
<app-overlay-modal *ngIf="showReadingsListModal" (close)="closeReadingsListModal()">
  <div class="modal-header">
    <h2>Ablesungen für {{ selectedMeterForReading?.meterNumber }}</h2>
    <button class="btn-close" (click)="closeReadingsListModal()">&times;</button>
  </div>

  <ng-container *ngTemplateOutlet="meterReadingList" />

  <div class="modal-footer">
    <button type="button" class="btn-secondary" (click)="closeReadingsListModal()">
      Schließen
    </button>
  </div>
</app-overlay-modal>

<ng-template #meterReadingList>
  <div class="readings-list">
    <div *ngIf="meterReadings.length === 0" class="no-data">
      Keine Ablesungen vorhanden
    </div>

    <table class="data-table" *ngIf="meterReadings.length > 0">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Zählerstand</th>
          <th>Verbrauch</th>
          <th>Typ</th>
          <th>Notizen</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let reading of meterReadings">
          <td>{{ reading.readingDate | date:'dd.MM.yyyy' }}</td>
          <td>
            <!-- Ein-Tarif-Zähler -->
            <strong *ngIf="reading.readingValue != null">{{ reading.readingValue }} {{ getMeterUnit(selectedMeterForReading.type) }}</strong>

            <!-- Zwei-Tarif-Zähler (HT/NT) -->
            <div *ngIf="reading.readingValueHT != null">
              <strong>HT:</strong> {{ reading.readingValueHT }} {{ getMeterUnit(selectedMeterForReading.type) }}<br>
              <strong>NT:</strong> {{ reading.readingValueNT || '-' }} {{ reading.readingValueNT ? getMeterUnit(selectedMeterForReading.type) : '' }}
            </div>
          </td>
          <td>
            <!-- Ein-Tarif-Verbrauch -->
            <span *ngIf="reading.consumption">
              {{ reading.consumption }} {{ getMeterUnit(selectedMeterForReading.type) }} ({{ reading.daysSinceLastReading }} Tage)
            </span>

            <!-- Zwei-Tarif-Verbrauch (HT/NT) -->
            <div *ngIf="reading.consumptionHT != null && reading.consumptionNT != null">
              <strong>HT:</strong> {{ reading.consumptionHT }} {{ getMeterUnit(selectedMeterForReading.type) }}<br>
              <strong>NT:</strong> {{ reading.consumptionNT }} {{ getMeterUnit(selectedMeterForReading.type) }}<br>
              <strong>Gesamt:</strong> {{ reading.consumptionTotal }} {{ getMeterUnit(selectedMeterForReading.type) }}<br>
              <small>({{ reading.daysSinceLastReading }} Tage)</small>
            </div>

            <span *ngIf="!reading.consumption && !reading.consumptionTotal">-</span>
          </td>
          <td>{{ getReadingTypeLabel(reading.readingType) }}</td>
          <td>{{ reading.notes || '-' }}</td>
          <td>
            <button class="btn-small btn-danger" (click)="deleteReading(reading._id)">
              Löschen
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</ng-template>

<!-- Customer Details Modal -->
@if(showCustomerDetailsModal && selectedCustomer) {
  <app-overlay-modal (close)="closeCustomerDetailsModal()">
    <div class="modal-header">
      <h2>{{ 'CUSTOMERS.DETAILS' | translate }}</h2>
      <button class="btn-close" (click)="closeCustomerDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <app-customer-detail
        [customer]="selectedCustomer"
        [contracts]="customerContracts"
        [showContracts]="true">
      </app-customer-detail>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeCustomerDetailsModal()">
        {{ 'COMMON.CLOSE' | translate }}
      </button>
    </div>
  </app-overlay-modal>
}