@if(isMobile){
  <app-messages-mobile
    [messages]="messages"
    [conversations]="conversations"
    [selectedConversation]="selectedConversation"
    [users]="users"
    [currentUserId]="currentUserId"
    [(messageText)]="messageText"
    [showUserPicker]="showUserPicker"
    (sendMessageEvent)="sendMessage()"
    (selectConversationEvent)="selectConversation($event)"
    (startConversationEvent)="startConversation($event)"
    (messageTextChange)="messageText = $event"
    (toggleUserPickerEvent)="showUserPicker = !showUserPicker"
    (backToListEvent)="selectedConversation = null">
  </app-messages-mobile>

}@else {

<div class="chat-page">

  <!-- SIDEBAR / KONVERSATIONEN -->
  <div class="sidebar">
    <h3>
      Unterhaltungen
      <button class="new-conv-btn" (click)="showUserPicker = true">+</button>
    </h3>
    <ul>
      <li *ngFor="let conv of conversations" [class.active]="conv._id === selectedConversation?._id"
          (click)="selectConversation(conv)">
        {{ conv.otherUserName }}
        <span *ngIf="conv.unreadCount > 0" class="unread-badge">{{ conv.unreadCount }}</span>
      </li>
    </ul>
  </div>

  <!-- USER PICKER POPUP -->
  <div class="user-picker-popup" *ngIf="showUserPicker">
    <h4>Wähle einen Nutzer</h4>
    <ul>
      <li *ngFor="let u of users" (click)="startConversation(u._id)">
        {{ u.name }} <span *ngIf="u.address">({{ u.address }})</span>
      </li>
    </ul>
    <button (click)="showUserPicker = false">Abbrechen</button>
  </div>

  <!-- CHAT FENSTER -->
  <div class="chat-window" *ngIf="selectedConversation">
    <div class="chat-container">
      <!-- HEADER -->
      <div class="chat-header">
        <strong>{{ selectedConversation.otherUserName }}</strong>
      </div>

      <!-- MESSAGES -->
      <div class="chat-messages">
        <div *ngFor="let m of messages" class="message" [class.me]="m.senderId === currentUserId"
            [class.other]="m.senderId !== currentUserId">
          <div class="bubble">
            <span class="text" *ngIf="m.text">{{ m.text }}</span>
            <div class="message-image" *ngIf="m.imageUrl" (click)="openImageViewer(getFullImageUrl(m.imageUrl))">
              <img [src]="getFullImageUrl(m.imageUrl)" [alt]="m.imageName || 'Bild'">
            </div>
            <span class="time">{{ m.createdAt | date:'HH:mm' }}</span>
          </div>
        </div>
      </div>

      <!-- INPUT -->
      <div class="chat-input-container">
        <!-- Image Preview -->
        <div class="image-preview" *ngIf="imagePreview">
          <img [src]="imagePreview" alt="Vorschau">
          <button class="remove-image-btn" (click)="removeImage()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="chat-input">
          <input
            type="file"
            #fileInput
            accept="image/*"
            (change)="onImageSelect($event)"
            style="display: none">

          <button class="attach-btn" (click)="fileInput.click()" type="button">
            <i class="fas fa-paperclip"></i>
          </button>

          <textarea
             #messageTextarea
             [(ngModel)]="messageText"
             (keydown)="onKeyDown($event)"
             placeholder="Nachricht schreiben… (Shift+Enter für neue Zeile)"
             rows="1"></textarea>

          <button (click)="sendMessage()" [disabled]="!messageText.trim() && !selectedImage">
            <i class="fas fa-arrow-up"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="no-selection" *ngIf="!selectedConversation">
    Bitte wähle eine Unterhaltung aus.
  </div>
</div>

<!-- Image Viewer Modal -->
<div class="image-viewer-overlay" *ngIf="showImageViewer" (click)="closeImageViewer()">
  <div class="image-viewer-content" (click)="$event.stopPropagation()">
    <button class="close-viewer-btn" (click)="closeImageViewer()">
      <i class="fas fa-times"></i>
    </button>
    <img [src]="viewingImageUrl" alt="Vollbild">
  </div>
</div>
}
