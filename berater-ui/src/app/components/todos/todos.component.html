@if(viewportService.isMobile()){
<app-todos-mobile
  [filteredTodos]="filteredTodos"
  [mainView]="mainView"
  [calendarView]="calendarView"
  [calendarDate]="calendarDate"
  [selectedDay]="selectedDay"
  [monthDays]="monthDays"
  (create)="showCreateModal()"
  (edit)="editTodo($event)"
  (delete)="deleteTodo($event)"
  (complete)="completeTodo($event)"
  (generateAuto)="generateAutoTodos()"
  (mainViewChange)="mainView = $event"
  (filterChange)="onFilterChange($event)"
  (navigateToCustomer)="navigateToCustomer($event)"
  (navigateToContract)="navigateToContract($event)"
  (navigateToMeter)="navigateToMeter($event)"
  (changeMonthEvent)="changeMonth($event)"
  (openDayEvent)="openDay($event)"
  (backToMonthEvent)="backToMonth()" />
}@else{
<app-todos-desktop
  [filteredTodos]="filteredTodos"
  [mainView]="mainView"
  [calendarView]="calendarView"
  [calendarDate]="calendarDate"
  [selectedDay]="selectedDay"
  [monthDays]="monthDays"
  (create)="showCreateModal()"
  (edit)="editTodo($event)"
  (delete)="deleteTodo($event)"
  (complete)="completeTodo($event)"
  (generateAuto)="generateAutoTodos()"
  (mainViewChange)="mainView = $event"
  (filterChange)="onFilterChange($event)"
  (navigateToCustomer)="navigateToCustomer($event)"
  (navigateToContract)="navigateToContract($event)"
  (navigateToMeter)="navigateToMeter($event)"
  (changeMonthEvent)="changeMonth($event)"
  (openDayEvent)="openDay($event)"
  (backToMonthEvent)="backToMonth()" />
}

<!-- Modal for Create/Edit TODO -->
<app-overlay-modal *ngIf="showModal" (close)="closeModal()">
  <div class="modal-header">
    <h2>{{ isEditMode ? ('TODOS.EDIT' | translate) : ('TODOS.NEW' | translate) }}</h2>
    <button class="btn-close" (click)="closeModal()">&times;</button>
  </div>

  <form (ngSubmit)="saveTodo()" #todoForm="ngForm">
    <div class="form-group">
      <label for="title">{{ 'TODOS.FIELDS.TITLE' | translate }} *</label>
      <input type="text" id="title" name="title" [(ngModel)]="currentTodo.title" required
        class="form-control" />
    </div>

    <div class="form-group">
      <label for="description">{{ 'TODOS.FIELDS.DESCRIPTION' | translate }}</label>
      <textarea id="description" name="description" [(ngModel)]="currentTodo.description" rows="4"
        class="form-control"></textarea>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="priority">{{ 'TODOS.FIELDS.PRIORITY' | translate }}</label>
        <select id="priority" name="priority" [(ngModel)]="currentTodo.priority" class="form-control">
          <option value="low">{{ 'TODOS.PRIORITY.LOW' | translate }}</option>
          <option value="medium">{{ 'TODOS.PRIORITY.MEDIUM' | translate }}</option>
          <option value="high">{{ 'TODOS.PRIORITY.HIGH' | translate }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="status">{{ 'TODOS.FIELDS.STATUS' | translate }}</label>
        <select id="status" name="status" [(ngModel)]="currentTodo.status" class="form-control">
          <option value="open">{{ 'TODOS.STATUS.OPEN' | translate }}</option>
          <option value="in_progress">{{ 'TODOS.STATUS.IN_PROGRESS' | translate }}</option>
          <option value="completed">{{ 'TODOS.STATUS.COMPLETED' | translate }}</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="dueDate">{{ 'TODOS.FIELDS.DUE_DATE' | translate }}</label>
      <input type="date" id="dueDate" name="dueDate" [(ngModel)]="currentTodo.dueDate"
        class="form-control" />
    </div>

    <div class="form-section">
      <h3>{{ 'TODOS.LINKS' | translate }}</h3>

      <!-- Kunde Suche -->
      <div class="form-group">
        <label>{{ 'TODOS.FIELDS.CUSTOMER' | translate }}</label>
        <div class="search-field">
          <input type="text"
                [placeholder]="'CUSTOMERS.SEARCH' | translate"
                [(ngModel)]="customerSearch"
                (input)="filterCustomers()"
                (focus)="showCustomerDropdown = true; filterCustomers()"
                (blur)="closeCustomerDropdownDelayed()"
                class="form-control"
                [ngModelOptions]="{standalone: true}"
                autocomplete="off" />
        </div>
        <div class="dropdown-list" *ngIf="showCustomerDropdown">
          <div class="dropdown-item"
              *ngFor="let customer of filteredCustomers"
              [class.selected]="currentTodo.relatedCustomerId === customer._id"
              (mousedown)="selectCustomer(customer); $event.preventDefault()">
            <span class="customer-name">{{ customer.firstName }} {{ customer.lastName }}</span>
            <span class="customer-address" *ngIf="getCustomerAddress(customer)">{{ getCustomerAddress(customer) }}</span>
          </div>
          <div class="dropdown-item no-results" *ngIf="filteredCustomers.length === 0">
            {{ 'COMMON.NO_RESULTS' | translate }}
          </div>
        </div>
        <div class="selected-item" *ngIf="selectedCustomer">
          <span class="selected-text">{{ selectedCustomer.firstName }} {{ selectedCustomer.lastName }}<span class="selected-address" *ngIf="getCustomerAddress(selectedCustomer)"> ({{ getCustomerAddress(selectedCustomer) }})</span></span>
          <button type="button" class="btn-clear" (click)="clearCustomer()">&times;</button>
        </div>
      </div>

      <!-- Vertrag Suche -->
      <div class="form-group">
        <label>{{ 'TODOS.FIELDS.CONTRACT' | translate }}</label>
        <div class="search-field">
          <input type="text"
                [placeholder]="'CONTRACTS.SEARCH' | translate"
                [(ngModel)]="contractSearch"
                (input)="filterContracts()"
                (focus)="showContractDropdown = true; filterContracts()"
                (blur)="closeContractDropdownDelayed()"
                class="form-control"
                [ngModelOptions]="{standalone: true}"
                autocomplete="off" />
        </div>
        <div class="dropdown-list" *ngIf="showContractDropdown">
          <div class="dropdown-item"
              *ngFor="let contract of filteredContracts"
              [class.selected]="currentTodo.relatedContractId === contract._id"
              (mousedown)="selectContract(contract); $event.preventDefault()">
            {{ contract.contractNumber }} - {{ contract.customerId?.firstName }} {{ contract.customerId?.lastName }}
          </div>
          <div class="dropdown-item no-results" *ngIf="filteredContracts.length === 0">
            {{ 'COMMON.NO_RESULTS' | translate }}
          </div>
        </div>
        <div class="selected-item" *ngIf="selectedContract">
          {{ 'COMMON.SELECT' | translate }}: <strong>{{ selectedContract.contractNumber }}</strong>
          <button type="button" class="btn-clear" (click)="clearContract()">&times;</button>
        </div>
      </div>

      <!-- ZÃ¤hler Suche -->
      <div class="form-group">
        <label>{{ 'TODOS.FIELDS.METER' | translate }}</label>
        <div class="search-field">
          <input type="text"
                [placeholder]="'METERS.SEARCH' | translate"
                [(ngModel)]="meterSearch"
                (input)="filterMeters()"
                (focus)="showMeterDropdown = true; filterMeters()"
                (blur)="closeMeterDropdownDelayed()"
                class="form-control"
                [ngModelOptions]="{standalone: true}"
                autocomplete="off" />
        </div>
        <div class="dropdown-list" *ngIf="showMeterDropdown">
          <div class="dropdown-item"
              *ngFor="let meter of filteredMeters"
              [class.selected]="currentTodo.relatedMeterId === meter._id"
              (mousedown)="selectMeter(meter); $event.preventDefault()">
            {{ meter.meterNumber }} ({{ getTypeLabel(meter.type) }})
          </div>
          <div class="dropdown-item no-results" *ngIf="filteredMeters.length === 0">
            {{ 'COMMON.NO_RESULTS' | translate }}
          </div>
        </div>
        <div class="selected-item" *ngIf="selectedMeter">
          {{ 'COMMON.SELECT' | translate }}: <strong>{{ selectedMeter.meterNumber }}</strong> ({{ getTypeLabel(selectedMeter.type) }})
          <button type="button" class="btn-clear" (click)="clearMeter()">&times;</button>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeModal()">{{ 'COMMON.CANCEL' | translate }}</button>
      <button type="submit" class="btn-primary" [disabled]="!todoForm.form.valid">
        {{ isEditMode ? ('COMMON.SAVE' | translate) : ('COMMON.CREATE' | translate) }}
      </button>
    </div>
  </form>
</app-overlay-modal>
