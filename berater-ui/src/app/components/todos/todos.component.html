<div class="page-container">
    <div class="page-header">
        <h1>TODOs</h1>
        <div class="header-actions">
            <button class="btn-secondary" (click)="generateAutoTodos()">Automatische TODOs generieren</button>
            <button class="btn-primary" (click)="showCreateModal()">+ Neues TODO</button>
        </div>
    </div>
    <!-- üîπ Haupt-Umschalter -->
    <div class="main-switch">
        <button class="btn-small" [class.active]="mainView==='list'" (click)="mainView='list'">Liste</button>
        <button class="btn-small" [class.active]="mainView==='calendar'" (click)="mainView='calendar'">Kalender</button>
    </div>
    <!-- üîπ Listen-Ansicht -->
    @if(mainView === 'list'){
        <div class="filters">
            <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="filterTodos()" placeholder="Suchen..."
            class="search-input" />
        <select [(ngModel)]="statusFilter" (ngModelChange)="filterTodos()" class="filter-select">
            <option value="">Alle Status</option>
            <option value="open">Offen</option>
            <option value="in_progress">In Bearbeitung</option>
            <option value="completed">Erledigt</option>
        </select>
        <select [(ngModel)]="priorityFilter" (ngModelChange)="filterTodos()" class="filter-select">
            <option value="">Alle Priorit√§ten</option>
            <option value="high">Hoch</option>
            <option value="medium">Mittel</option>
            <option value="low">Niedrig</option>
        </select>
    </div>
    <div class="todos-grid">
        <app-todo *ngFor="let todo of filteredTodos" [todo]="todo" (deleteTodoEmiter)="deleteTodo($event)"
            (completeTodoEmiter)="completeTodo($event)" (editTodoEmiter)="editTodo($event)"
            (navigateToCustomerEmiter)="navigateToCustomer($event)"
            (navigateToContractEmiter)="navigateToContract($event)" (navigateToMeterEmiter)="navigateToMeter($event)" />

        <div *ngIf="filteredTodos.length === 0" class="no-data">
            <p>Keine TODOs gefunden</p>
        </div>
    </div>
}
    <div *ngIf="mainView === 'calendar'">

        <!-- MONAT -->
        <div *ngIf="calendarView === 'month'">
            <div class="calendar-header">
                <button (click)="changeMonth(-1)">‚Äπ</button>
                <h2>{{ calendarDate | date:'MMMM yyyy' }}</h2>
                <button (click)="changeMonth(1)">‚Ä∫</button>
            </div>

            <div class="calendar-grid">
                <div class="weekday" *ngFor="let d of ['Mo','Di','Mi','Do','Fr','Sa','So']">{{ d }}</div>

                <div class="day-cell" *ngFor="let day of monthDays" [class.other-month]="!isSameMonth(day)"
                    [class.today]="isToday(day)" (click)="openDay(day)">

                    <div class="date">{{ day.getDate() }}</div>

                    <div class="todo-dot" *ngFor="let todo of todosForDate(day)">
                        {{ todo.title }}
                    </div>
                </div>
            </div>
        </div>

        <!-- TAG -->
        <div *ngIf="calendarView === 'day'">
            <button class="btn-small" (click)="backToMonth()">‚Üê Zur√ºck</button>
            <h2>{{ selectedDay | date:'fullDate' }}</h2>

            <div class="todos-grid">
                <app-todo *ngFor="let todo of todosForDate(selectedDay!)" 
                    [todo]="todo" 
                    (deleteTodoEmiter)="deleteTodo($event)"
                    (completeTodoEmiter)="completeTodo($event)" 
                    (editTodoEmiter)="editTodo($event)"
                    (navigateToCustomerEmiter)="navigateToCustomer($event)"
                    (navigateToContractEmiter)="navigateToContract($event)"
                    (navigateToMeterEmiter)="navigateToMeter($event)" />

                <div *ngIf="todosForDate(selectedDay!).length === 0" class="no-data">
                    Keine TODOs
                </div>
            </div>
        </div>

    </div>

    <!-- Modal for Create/Edit TODO -->
    <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>{{ isEditMode ? 'TODO bearbeiten' : 'Neues TODO' }}</h2>
                <button class="btn-close" (click)="closeModal()">&times;</button>
            </div>

            <form (ngSubmit)="saveTodo()" #todoForm="ngForm">
                <div class="form-group">
                    <label for="title">Titel *</label>
                    <input type="text" id="title" name="title" [(ngModel)]="currentTodo.title" required
                        class="form-control" placeholder="z.B. Adresse von Kunde √§ndern" />
                </div>

                <div class="form-group">
                    <label for="description">Beschreibung</label>
                    <textarea id="description" name="description" [(ngModel)]="currentTodo.description" rows="4"
                        class="form-control" placeholder="Zus√§tzliche Details..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="priority">Priorit√§t</label>
                        <select id="priority" name="priority" [(ngModel)]="currentTodo.priority" class="form-control">
                            <option value="low">Niedrig</option>
                            <option value="medium">Mittel</option>
                            <option value="high">Hoch</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status" [(ngModel)]="currentTodo.status" class="form-control">
                            <option value="open">Offen</option>
                            <option value="in_progress">In Bearbeitung</option>
                            <option value="completed">Erledigt</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="dueDate">F√§lligkeitsdatum</label>
                    <input type="date" id="dueDate" name="dueDate" [(ngModel)]="currentTodo.dueDate"
                        class="form-control" />
                </div>

                <div class="form-section">
                    <h3>Verkn√ºpfungen (optional)</h3>

                    <div class="form-group">
                        <label for="relatedCustomerId">Kunde</label>
                        <select id="relatedCustomerId" name="relatedCustomerId"
                            [(ngModel)]="currentTodo.relatedCustomerId" class="form-control">
                            <option [ngValue]="null">Kein Kunde</option>
                            <option *ngFor="let customer of customers" [value]="customer._id">
                                {{ customer.firstName }} {{ customer.lastName }} ({{ customer.customerNumber }})
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="relatedContractId">Vertrag</label>
                        <select id="relatedContractId" name="relatedContractId"
                            [(ngModel)]="currentTodo.relatedContractId" class="form-control">
                            <option [ngValue]="null">Kein Vertrag</option>
                            <option *ngFor="let contract of contracts" [value]="contract._id">
                                {{ contract.contractNumber }} - {{ contract.customerId?.firstName }} {{
                                contract.customerId?.lastName }}
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="relatedMeterId">Z√§hler</label>
                        <select id="relatedMeterId" name="relatedMeterId" [(ngModel)]="currentTodo.relatedMeterId"
                            class="form-control">
                            <option [ngValue]="null">Kein Z√§hler</option>
                            <option *ngFor="let meter of meters" [value]="meter._id">
                                {{ meter.meterNumber }} ({{ getTypeLabel(meter.type) }})
                            </option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" (click)="closeModal()">Abbrechen</button>
                    <button type="submit" class="btn-primary" [disabled]="!todoForm.form.valid">
                        {{ isEditMode ? 'Speichern' : 'Erstellen' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>