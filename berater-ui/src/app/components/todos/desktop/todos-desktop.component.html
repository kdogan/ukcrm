<div class="page-container">
  <div class="page-header">
    <h1>TODOs</h1>
    <div class="header-actions">
      <button class="btn-secondary" (click)="generateAuto.emit()">
        <i class="fas fa-magic"></i> Automatische TODOs generieren
      </button>
      <button class="btn-primary" (click)="create.emit()">+ Neues TODO</button>
    </div>
  </div>

  <!-- View Switcher -->
  <div class="main-switch">
    <button
      class="btn-small"
      [class.active]="mainView === 'list'"
      (click)="mainViewChange.emit('list')">
      Liste
    </button>
    <button
      class="btn-small"
      [class.active]="mainView === 'calendar'"
      (click)="mainViewChange.emit('calendar')">
      Kalender
    </button>
  </div>

  <!-- LIST VIEW -->
  @if(mainView === 'list') {
    <!-- Search and Filter Section -->
    <div class="filter-section">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <app-search-input
          [value]="searchTerm"
          (valueChange)="searchTerm = $event; onFilterChange()"
          placeholder="TODOs durchsuchen...">
        </app-search-input>
        @if(searchTerm){
          <button class="clear-search" (click)="searchTerm = ''; onFilterChange()">
            <i class="fas fa-times"></i>
          </button>
        }
      </div>

      <div class="filters-row">
        <div class="filter-group">
          <label>Status</label>
          <select [(ngModel)]="statusFilter" (ngModelChange)="onFilterChange()">
            <option value="">Alle offenen</option>
            <option value="open">Offen</option>
            <option value="in_progress">In Bearbeitung</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Priorität</label>
          <select [(ngModel)]="priorityFilter" (ngModelChange)="onFilterChange()">
            <option value="">Alle</option>
            <option value="high">Hoch</option>
            <option value="medium">Mittel</option>
            <option value="low">Niedrig</option>
          </select>
        </div>

        <div class="filter-group checkbox-filter">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="showCompleted" (ngModelChange)="onFilterChange()">
            <span>Abgeschlossene anzeigen</span>
          </label>
        </div>

        <button class="btn-reset" (click)="resetFilters()" title="Filter zurücksetzen">
          <i class="fas fa-redo"></i>
        </button>
      </div>

      <div class="results-info">
        <span>{{ filteredTodos.length }} TODOs</span>
      </div>
    </div>

    <div class="todos-grid">
      <app-todo
        *ngFor="let todo of filteredTodos"
        [todo]="todo"
        (deleteTodoEmiter)="delete.emit($event)"
        (completeTodoEmiter)="complete.emit($event)"
        (editTodoEmiter)="edit.emit($event)"
        (navigateToCustomerEmiter)="navigateToCustomer.emit($event)"
        (navigateToContractEmiter)="navigateToContract.emit($event)"
        (navigateToMeterEmiter)="navigateToMeter.emit($event)" />

      <div *ngIf="filteredTodos.length === 0" class="no-data">
        @if(searchTerm || statusFilter || priorityFilter){
          <i class="fas fa-search"></i>
          <p>Keine TODOs gefunden, die den Suchkriterien entsprechen.</p>
          <button class="btn-secondary" (click)="resetFilters()">Filter zurücksetzen</button>
        }@else{
          <p>Keine TODOs vorhanden</p>
        }
      </div>
    </div>
  }

  <!-- CALENDAR VIEW -->
  @if(mainView === 'calendar') {
    @if(calendarView === 'month') {
      <div class="calendar-header">
        <button (click)="changeMonthEvent.emit(-1)">‹</button>
        <h2>{{ calendarDate | date:'MMMM yyyy' }}</h2>
        <button (click)="changeMonthEvent.emit(1)">›</button>
      </div>

      <div class="calendar-grid">
        <div class="weekday" *ngFor="let d of ['Mo','Di','Mi','Do','Fr','Sa','So']">{{ d }}</div>

        <div
          class="day-cell"
          *ngFor="let day of monthDays"
          [class.other-month]="!isSameMonth(day)"
          [class.today]="isToday(day)"
          (click)="openDayEvent.emit(day)">

          <div class="date">{{ day.getDate() }}</div>

          <div class="todo-dot" *ngFor="let todo of todosForDate(day)">
            {{ todo.title }}
          </div>
        </div>
      </div>
    }

    @if(calendarView === 'day') {
      <button class="btn-small" (click)="backToMonthEvent.emit()">← Zurück</button>
      <h2>{{ selectedDay | date:'fullDate' }}</h2>

      <div class="todos-grid">
        <app-todo
          *ngFor="let todo of todosForDate(selectedDay!)"
          [todo]="todo"
          (deleteTodoEmiter)="delete.emit($event)"
          (completeTodoEmiter)="complete.emit($event)"
          (editTodoEmiter)="edit.emit($event)"
          (navigateToCustomerEmiter)="navigateToCustomer.emit($event)"
          (navigateToContractEmiter)="navigateToContract.emit($event)"
          (navigateToMeterEmiter)="navigateToMeter.emit($event)" />

        <div *ngIf="todosForDate(selectedDay!).length === 0" class="no-data">
          Keine TODOs
        </div>
      </div>
    }
  }
</div>
